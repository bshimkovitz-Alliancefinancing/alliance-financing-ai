<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JEP3FEBY4V"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-JEP3FEBY4V');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approval Notice - Alliance Financing Group</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #F1F5F9; min-height: 100vh; color: #1E293B; }
        :root { --navy: #0D1E3D; --gold: #C9A84C; --green: #10B981; --blue: #2563EB; }

        .header { background: var(--navy); padding: 1.25rem 0; text-align: center; }
        .header h1 { color: #fff; font-size: 1.25rem; font-weight: 700; }
        .header h1 span { color: var(--gold); }

        .container { max-width: 700px; margin: 2rem auto; padding: 0 1.5rem; }

        .card { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 1.5rem; }
        .card-header-approval { background: linear-gradient(135deg, #065F46, #10B981); padding: 28px; color: #fff; text-align: center; }
        .card-header-approval h2 { font-size: 1.5rem; margin-bottom: 6px; }
        .card-header-approval p { font-size: 0.9rem; opacity: 0.9; }
        .card-header-docs { background: linear-gradient(135deg, #0D1E3D, #1a3a6b); padding: 24px 28px; color: #fff; }
        .card-header-docs h2 { font-size: 1.25rem; margin-bottom: 4px; }
        .card-header-docs p { font-size: 0.875rem; opacity: 0.8; }
        .card-body { padding: 28px; }

        .approval-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.2); padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-top: 12px; }

        .approval-details { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }
        .detail-item { padding: 14px; background: #F8FAFC; border-radius: 8px; border: 1px solid #E2E8F0; }
        .detail-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748B; font-weight: 600; }
        .detail-value { font-size: 16px; font-weight: 700; color: var(--navy); margin-top: 4px; }
        .detail-value.amount { font-size: 22px; color: var(--green); }

        .conditions-box { padding: 16px; background: #FFFBEB; border: 1px solid #FCD34D; border-radius: 8px; border-left: 4px solid var(--gold); margin-bottom: 24px; }
        .conditions-box h3 { font-size: 14px; color: #92400E; margin-bottom: 8px; font-weight: 700; }
        .conditions-box p { font-size: 13px; color: #78350F; line-height: 1.6; }

        .message-box { padding: 16px; background: #F0F9FF; border: 1px solid #BAE6FD; border-radius: 8px; margin-bottom: 24px; }
        .message-box h3 { font-size: 13px; color: #0C4A6E; margin-bottom: 6px; font-weight: 600; }
        .message-box p { font-size: 13px; color: #475569; line-height: 1.5; font-style: italic; }

        .btn-accept { width: 100%; padding: 16px; background: linear-gradient(135deg, #065F46, #10B981); color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(16,185,129,0.3); }
        .btn-accept:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(16,185,129,0.4); }
        .btn-accept:disabled { background: #E5E7EB; color: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-submit { width: 100%; padding: 14px; background: linear-gradient(135deg, #0D1E3D, #1a3a6b); color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(13,30,61,0.3); }
        .btn-submit:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(13,30,61,0.4); }
        .btn-submit:disabled { background: #E5E7EB; color: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }

        .accepted-banner { text-align: center; padding: 20px; background: #F0FDF4; border: 1px solid #86EFAC; border-radius: 8px; margin-bottom: 24px; }
        .accepted-banner .icon { font-size: 32px; margin-bottom: 8px; }
        .accepted-banner h3 { color: #166534; font-size: 16px; margin-bottom: 4px; }
        .accepted-banner p { color: #15803D; font-size: 13px; }

        .required-docs { margin-bottom: 24px; }
        .required-docs h3 { font-size: 14px; color: var(--navy); margin-bottom: 12px; font-weight: 700; }
        .req-doc-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 6px; margin-bottom: 6px; font-size: 13px; }
        .req-doc-check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #CBD5E1; display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; }
        .req-doc-check.done { background: var(--green); border-color: var(--green); color: #fff; }

        .upload-area { border: 2px dashed #CBD5E1; border-radius: 8px; padding: 32px 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 16px; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--blue); background: #EFF6FF; }
        .upload-area-icon { font-size: 36px; margin-bottom: 8px; }
        .upload-area-text { font-size: 14px; color: #64748B; }
        .upload-area-text strong { color: var(--blue); }
        .upload-area-hint { font-size: 12px; color: #94A3B8; margin-top: 6px; }

        .doc-type-row { display: flex; gap: 10px; margin-bottom: 16px; }
        .doc-type-row select { flex: 1; padding: 10px 12px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 13px; font-family: inherit; }
        .doc-type-row label { display: flex; align-items: center; gap: 6px; padding: 10px 16px; background: var(--gold); color: #fff; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; white-space: nowrap; }
        .doc-type-row label input { display: none; }

        .file-list { margin-bottom: 20px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 6px; margin-bottom: 6px; }
        .file-item-info { flex: 1; }
        .file-item-name { font-weight: 600; font-size: 13px; color: var(--navy); }
        .file-item-meta { font-size: 11px; color: #64748B; margin-top: 2px; }
        .file-item-meta .badge { background: #EFF6FF; color: #3B82F6; padding: 1px 6px; border-radius: 8px; font-weight: 600; margin-right: 6px; }
        .file-item-remove { padding: 4px 10px; background: #FEE2E2; color: #DC2626; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; }

        .upload-progress { display: none; margin-bottom: 16px; }
        .progress-bar-bg { width: 100%; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: var(--green); transition: width 0.3s; }
        .progress-text { font-size: 12px; color: #64748B; margin-top: 6px; }

        .success-card { text-align: center; padding: 40px 28px; }
        .success-icon { font-size: 48px; margin-bottom: 16px; }
        .success-title { font-size: 20px; font-weight: 700; color: var(--navy); margin-bottom: 8px; }
        .success-text { font-size: 14px; color: #64748B; line-height: 1.6; }

        .error-card { text-align: center; padding: 40px 28px; }
        .error-icon { font-size: 48px; margin-bottom: 16px; }
        .error-title { font-size: 20px; font-weight: 700; color: #DC2626; margin-bottom: 8px; }
        .error-text { font-size: 14px; color: #64748B; line-height: 1.6; }

        .loading-card { text-align: center; padding: 60px 28px; }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid #E5E7EB; border-top-color: var(--navy); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 14px; color: #64748B; }

        .secure-badge { display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; color: #64748B; margin-top: 12px; }
        .secure-badge svg { width: 14px; height: 14px; fill: var(--green); }

        .footer { text-align: center; padding: 2rem 1rem; font-size: 12px; color: #94A3B8; }
        .footer a { color: #64748B; text-decoration: none; }

        @media (max-width: 480px) {
            .approval-details { grid-template-columns: 1fr; }
            .doc-type-row { flex-direction: column; }
            .container { padding: 0 1rem; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1><span>Alliance</span> Financing Group</h1>
</div>

<div class="container">
    <!-- Loading -->
    <div class="card" id="loadingCard">
        <div class="loading-card">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading your approval notice...</div>
        </div>
    </div>

    <!-- Error -->
    <div class="card" id="errorCard" style="display:none;">
        <div class="error-card">
            <div class="error-icon">&#9888;&#65039;</div>
            <div class="error-title">Invalid or Expired Link</div>
            <div class="error-text" id="errorMessage">This approval link is no longer valid. Please contact your representative.</div>
        </div>
    </div>

    <!-- Phase 1: Approval Details + Accept -->
    <div id="approvalCard" style="display:none;">
        <div class="card">
            <div class="card-header-approval">
                <h2>&#127881; Congratulations!</h2>
                <p>Your financing application has been approved</p>
                <div class="approval-badge">&#9989; Approved by Alliance Financing Group</div>
            </div>
            <div class="card-body">
                <div class="approval-details" id="approvalDetails"></div>

                <div id="conditionsSection" style="display:none;">
                    <div class="conditions-box">
                        <h3>&#128203; Conditions of Approval</h3>
                        <p id="conditionsText"></p>
                    </div>
                </div>

                <div id="messageSection" style="display:none;">
                    <div class="message-box">
                        <h3>Message from Our Team</h3>
                        <p id="messageText"></p>
                    </div>
                </div>

                <div style="margin-bottom:16px;padding:14px;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:8px;font-size:13px;color:#166534;line-height:1.5;">
                    By clicking "Accept This Approval" below, you acknowledge the terms outlined above and agree to proceed with this financing arrangement. Required documents will be requested in the next step.
                </div>

                <button class="btn-accept" id="acceptBtn" onclick="acceptApproval()">&#9989; Accept This Approval</button>

                <div class="secure-badge">
                    <svg viewBox="0 0 20 20"><path d="M10 1a4.5 4.5 0 00-4.5 4.5V9H4a1 1 0 00-1 1v8a1 1 0 001 1h12a1 1 0 001-1v-8a1 1 0 00-1-1h-1.5V5.5A4.5 4.5 0 0010 1zm-2.5 4.5a2.5 2.5 0 015 0V9h-5V5.5z"/></svg>
                    Secure, encrypted connection
                </div>
            </div>
        </div>
    </div>

    <!-- Phase 2: Next Steps / Document Upload -->
    <div id="nextStepsCard" style="display:none;">
        <div class="card">
            <div class="accepted-banner">
                <div class="icon">&#9989;</div>
                <h3>Approval Accepted</h3>
                <p id="acceptedTime"></p>
            </div>
        </div>

        <div class="card" id="docsRequiredCard" style="display:none;">
            <div class="card-header-docs">
                <h2>&#128196; Next Steps &mdash; Required Documents</h2>
                <p>Please upload the following documents to proceed</p>
            </div>
            <div class="card-body">
                <div class="required-docs" id="requiredDocsList"></div>

                <div class="doc-type-row">
                    <select id="uploadDocType"></select>
                    <label>
                        <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx,.csv" multiple onchange="handleFiles(this.files)">
                        + Choose Files
                    </label>
                </div>

                <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-area-icon">&#128193;</div>
                    <div class="upload-area-text">Drag &amp; drop files here or <strong>click to browse</strong></div>
                    <div class="upload-area-hint">PDF, PNG, JPG, Word, Excel &mdash; max 10MB per file</div>
                </div>

                <div class="file-list" id="fileList"></div>

                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-bar-bg"><div class="progress-bar" id="progressBar"></div></div>
                    <div class="progress-text" id="progressText">Uploading...</div>
                </div>

                <button class="btn-submit" id="submitBtn" onclick="uploadAll()" disabled>Upload Documents</button>

                <div class="secure-badge">
                    <svg viewBox="0 0 20 20"><path d="M10 1a4.5 4.5 0 00-4.5 4.5V9H4a1 1 0 00-1 1v8a1 1 0 001 1h12a1 1 0 001-1v-8a1 1 0 00-1-1h-1.5V5.5A4.5 4.5 0 0010 1zm-2.5 4.5a2.5 2.5 0 015 0V9h-5V5.5z"/></svg>
                    Secure, encrypted upload &mdash; your documents are protected
                </div>
            </div>
        </div>

        <!-- No docs required message -->
        <div class="card" id="noDocsCard" style="display:none;">
            <div class="card-body" style="text-align:center;padding:40px 28px;">
                <div style="font-size:36px;margin-bottom:12px;">&#128077;</div>
                <h3 style="color:var(--navy);margin-bottom:8px;">You're All Set!</h3>
                <p style="color:#64748B;font-size:14px;line-height:1.6;">Your approval has been accepted. Our team will be in touch with next steps and any documentation requirements.</p>
            </div>
        </div>
    </div>

    <!-- Phase 3: Upload Complete -->
    <div class="card" id="successCard" style="display:none;">
        <div class="success-card">
            <div class="success-icon">&#127881;</div>
            <div class="success-title">Documents Uploaded Successfully!</div>
            <div class="success-text" id="successText">Your documents have been received. Our team will review them and be in touch with next steps.</div>
            <div style="margin-top:24px;padding:16px;background:#F0FDF4;border-radius:8px;font-size:13px;color:#166534;">
                You can safely close this page. If you need to upload additional documents, use the same link from your email.
            </div>
        </div>
    </div>
</div>

<div class="footer">
    <p>Alliance Financing Group &nbsp;|&nbsp; <a href="mailto:info@alliancefinancing.ai">info@alliancefinancing.ai</a> &nbsp;|&nbsp; <a href="tel:+18776603660">1-877-660-3660</a></p>
    <p style="margin-top:6px;">&copy; 2025 Alliance Financing Group. All rights reserved.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://uernphejrcsicnkobsdw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlcm5waGVqcmNzaWNua29ic2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzU3ODksImV4cCI6MjA4NjUxMTc4OX0.A2YN3gkaYwR_9nyE3OkWl5Io9tfxe8lTgC913stXmUI';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

var noticeData = null;
var pendingFiles = [];

var docTypeLabels = {
    driver_license: "Driver's License", void_cheque: 'Void Cheque',
    articles_of_incorporation: 'Articles of Incorporation', business_license: 'Business License',
    financial_statements: 'Financial Statements', tax_returns: 'Tax Returns',
    bank_statement: 'Bank Statement', credit_report: 'Credit Report',
    photo_id: 'Photo ID', credit_application: 'Credit Application',
    equipment_quote: 'Equipment Quote / Invoice', processing_statement: 'Processing Statement',
    ap_ar_aging: 'AP / AR Aging Report', supporting_document: 'Supporting Document', other: 'Other'
};

function formatCurrency(val) {
    if (!val) return '$0';
    return '$' + Number(val).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

// Initialize
(async function() {
    var params = new URLSearchParams(window.location.search);
    var token = params.get('token');

    if (!token) {
        showError('This link appears to be incomplete. Please use the full link from your email.');
        return;
    }

    try {
        var { data: notice, error } = await db
            .from('approval_notices')
            .select('*, deals(company_name, deal_number, product_type, applications(application_id))')
            .eq('token', token)
            .eq('is_active', true)
            .single();

        if (error || !notice) {
            showError('This approval link is no longer valid or has expired. Please contact your representative.');
            return;
        }

        if (notice.expires_at && new Date(notice.expires_at) < new Date()) {
            showError('This approval link has expired. Please contact your representative for an updated notice.');
            return;
        }

        noticeData = notice;
        var details = notice.approval_details || {};

        // Build approval details grid
        var detailsHtml = '';
        var isLeasing = details.product === 'Equipment Leasing';
        if (details.amount) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Approved Amount</div><div class="detail-value amount">' + formatCurrency(details.amount) + '</div></div>';
        }
        if (details.product) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Product Type</div><div class="detail-value">' + details.product + '</div></div>';
        }
        if (isLeasing && details.downpayment) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Down Payment</div><div class="detail-value">' + formatCurrency(details.downpayment) + '</div></div>';
        }
        if (details.term) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Term</div><div class="detail-value">' + details.term + ' months</div></div>';
        }
        if (isLeasing && details.advance_payments) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Advance Payments</div><div class="detail-value">' + details.advance_payments + '</div></div>';
        }
        if (isLeasing && details.purchase_option) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Purchase Option</div><div class="detail-value">' + details.purchase_option + '</div></div>';
        }
        if (!isLeasing && details.rate) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Rate</div><div class="detail-value">' + details.rate + '%</div></div>';
        }
        if (details.monthly_payment) {
            detailsHtml += '<div class="detail-item"><div class="detail-label">Monthly Payment</div><div class="detail-value">' + formatCurrency(details.monthly_payment) + '</div></div>';
        }
        document.getElementById('approvalDetails').innerHTML = detailsHtml;

        // Conditions
        if (details.conditions) {
            document.getElementById('conditionsText').textContent = details.conditions;
            document.getElementById('conditionsSection').style.display = 'block';
        }

        // Message
        if (notice.message) {
            document.getElementById('messageText').textContent = notice.message;
            document.getElementById('messageSection').style.display = 'block';
        }

        // Check if already accepted
        if (notice.accepted_at) {
            showNextSteps(notice);
        } else {
            document.getElementById('loadingCard').style.display = 'none';
            document.getElementById('approvalCard').style.display = 'block';
        }

    } catch (err) {
        console.error('Init error:', err);
        showError('Something went wrong loading this page. Please try again or contact support.');
    }
})();

function showError(msg) {
    document.getElementById('loadingCard').style.display = 'none';
    document.getElementById('errorMessage').textContent = msg;
    document.getElementById('errorCard').style.display = 'block';
}

// Accept approval
async function acceptApproval() {
    var btn = document.getElementById('acceptBtn');
    btn.disabled = true;
    btn.textContent = 'Processing...';

    try {
        var now = new Date();

        // Record acceptance
        var { error: updateErr } = await db.from('approval_notices').update({
            accepted_at: now.toISOString(),
            accepted_by_name: noticeData.client_name || 'Client',
            updated_at: now.toISOString()
        }).eq('id', noticeData.id);

        if (updateErr) throw updateErr;

        // Add system note to deal
        var { data: deal } = await db.from('deals').select('notes').eq('id', noticeData.deal_id).single();
        var notes = [];
        try { notes = deal.notes ? JSON.parse(deal.notes) : []; } catch(e) { notes = []; }
        var dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        notes.push({
            text: '\u2705 Approval accepted by ' + (noticeData.client_name || 'Client') + ' on ' + dateStr + '.',
            author: 'System',
            date: dateStr,
            visible_to_agent: noticeData.visible_to_agent !== false
        });
        await db.from('deals').update({ notes: JSON.stringify(notes) }).eq('id', noticeData.deal_id);

        // Update local data
        noticeData.accepted_at = now.toISOString();

        // Transition to next steps
        showNextSteps(noticeData);

    } catch (err) {
        console.error('Accept error:', err);
        alert('Something went wrong. Please try again.');
        btn.disabled = false;
        btn.textContent = '\u2705 Accept This Approval';
    }
}

function showNextSteps(notice) {
    document.getElementById('loadingCard').style.display = 'none';
    document.getElementById('approvalCard').style.display = 'none';
    document.getElementById('nextStepsCard').style.display = 'block';

    // Show accepted time
    var acceptedDate = new Date(notice.accepted_at);
    document.getElementById('acceptedTime').textContent = 'Accepted on ' + acceptedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

    var requiredDocs = notice.required_documents || [];

    if (requiredDocs.length > 0) {
        document.getElementById('docsRequiredCard').style.display = 'block';

        // Build required docs list
        var docsListHtml = requiredDocs.map(function(doc) {
            var label = doc.name || docTypeLabels[doc.type] || doc.type;
            return '<div class="req-doc-item"><div class="req-doc-check" id="check-' + doc.type + '"></div><span>' + label + '</span></div>';
        }).join('');
        document.getElementById('requiredDocsList').innerHTML = '<h3>Documents Needed</h3>' + docsListHtml;

        // Build doc type dropdown from required docs + other
        var selectEl = document.getElementById('uploadDocType');
        selectEl.innerHTML = requiredDocs.map(function(doc) {
            var label = doc.name || docTypeLabels[doc.type] || doc.type;
            return '<option value="' + doc.type + '">' + label + '</option>';
        }).join('') + '<option value="other">Other</option>';

        // Setup drag and drop
        setupDragDrop();
    } else {
        document.getElementById('noDocsCard').style.display = 'block';
    }
}

function setupDragDrop() {
    var dropZone = document.getElementById('dropZone');
    if (!dropZone) return;
    dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });
}

function handleFiles(files) {
    var docType = document.getElementById('uploadDocType').value;
    for (var i = 0; i < files.length; i++) {
        var file = files[i];
        if (file.size > 10 * 1024 * 1024) {
            alert(file.name + ' exceeds the 10MB limit and was not added.');
            continue;
        }
        pendingFiles.push({ file: file, docType: docType, typeLabel: docTypeLabels[docType] || docType });
    }
    document.getElementById('fileInput').value = '';
    renderFileList();
}

function renderFileList() {
    var listEl = document.getElementById('fileList');
    var btn = document.getElementById('submitBtn');

    if (pendingFiles.length === 0) {
        listEl.innerHTML = '';
        btn.disabled = true;
        btn.textContent = 'Upload Documents';
        return;
    }

    btn.disabled = false;
    btn.textContent = 'Upload ' + pendingFiles.length + ' Document' + (pendingFiles.length !== 1 ? 's' : '');

    listEl.innerHTML = pendingFiles.map(function(item, idx) {
        var sizeMB = (item.file.size / 1024 / 1024).toFixed(2);
        return '<div class="file-item">' +
            '<div class="file-item-info">' +
                '<div class="file-item-name">' + item.file.name + '</div>' +
                '<div class="file-item-meta"><span class="badge">' + item.typeLabel + '</span>' + sizeMB + ' MB</div>' +
            '</div>' +
            '<button class="file-item-remove" onclick="removeFile(' + idx + ')">Remove</button>' +
        '</div>';
    }).join('');
}

function removeFile(idx) {
    pendingFiles.splice(idx, 1);
    renderFileList();
}

async function uploadAll() {
    if (pendingFiles.length === 0) return;

    var btn = document.getElementById('submitBtn');
    var progressEl = document.getElementById('uploadProgress');
    var progressBar = document.getElementById('progressBar');
    var progressText = document.getElementById('progressText');

    btn.disabled = true;
    btn.textContent = 'Uploading...';
    progressEl.style.display = 'block';

    var total = pendingFiles.length;
    var uploaded = 0;
    var uploadedTypes = [];

    for (var i = 0; i < pendingFiles.length; i++) {
        var item = pendingFiles[i];
        progressText.textContent = 'Uploading ' + (i + 1) + ' of ' + total + ': ' + item.file.name;
        progressBar.style.width = ((i / total) * 100) + '%';

        try {
            var filePath = 'deals/' + noticeData.deal_id + '/' + Date.now() + '-' + item.file.name.replace(/[^a-zA-Z0-9._-]/g, '_');

            var uploadUrl = SUPABASE_URL + '/storage/v1/object/deal-documents/' + filePath;
            var uploadResp = await fetch(uploadUrl, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY, 'apikey': SUPABASE_ANON_KEY, 'x-upsert': 'true' },
                body: item.file
            });

            if (!uploadResp.ok) {
                console.warn('Upload failed for ' + item.file.name);
                continue;
            }

            await db.from('documents').insert([{
                deal_id: noticeData.deal_id,
                file_name: item.file.name,
                file_path: filePath,
                file_type: item.file.type,
                file_size_bytes: item.file.size,
                document_type: item.docType,
                uploaded_by_name: noticeData.client_name || 'Applicant',
                visible_to_agent: true,
                notes: 'Uploaded via approval notice portal'
            }]);

            uploaded++;
            uploadedTypes.push(item.docType);

            // Mark the doc type as done in the checklist
            var checkEl = document.getElementById('check-' + item.docType);
            if (checkEl) {
                checkEl.classList.add('done');
                checkEl.textContent = '\u2713';
            }
        } catch (err) {
            console.error('Upload error for ' + item.file.name + ':', err);
        }
    }

    progressBar.style.width = '100%';

    // Update approval notice upload log
    try {
        var uploadLog = noticeData.upload_log || [];
        uploadLog.push({
            uploaded_at: new Date().toISOString(),
            file_count: uploaded,
            doc_types: uploadedTypes
        });
        await db.from('approval_notices').update({
            upload_log: uploadLog,
            updated_at: new Date().toISOString()
        }).eq('id', noticeData.id);

        // Add system note to deal
        var { data: deal } = await db.from('deals').select('notes').eq('id', noticeData.deal_id).single();
        var notes = [];
        try { notes = deal.notes ? JSON.parse(deal.notes) : []; } catch(e) { notes = []; }
        var now = new Date();
        var dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        notes.push({
            text: '\uD83D\uDCCE ' + uploaded + ' document' + (uploaded !== 1 ? 's' : '') + ' uploaded by ' + (noticeData.client_name || 'applicant') + ' via approval notice portal.',
            author: 'System',
            date: dateStr,
            visible_to_agent: noticeData.visible_to_agent !== false
        });
        await db.from('deals').update({ notes: JSON.stringify(notes) }).eq('id', noticeData.deal_id);
    } catch (e) {
        console.warn('Could not update upload log:', e);
    }

    // Show success
    document.getElementById('nextStepsCard').style.display = 'none';
    document.getElementById('successText').textContent = uploaded + ' document' + (uploaded !== 1 ? 's' : '') + ' uploaded successfully. Our team will review them and be in touch with next steps.';
    document.getElementById('successCard').style.display = 'block';
}
</script>
</body>
</html>
