<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JEP3FEBY4V"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-JEP3FEBY4V');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syndication Desk Portal - Alliance Financing Group</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #F1F5F9; min-height: 100vh; color: #1E293B; }
        :root { --navy: #0D1E3D; --gold: #C9A84C; --green: #10B981; --blue: #2563EB; --danger: #EF4444; }

        .header { background: var(--navy); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header h1 { color: #fff; font-size: 1.1rem; font-weight: 700; }
        .header h1 span { color: var(--gold); }
        .header-institution { color: var(--gold); font-size: 14px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-user { color: #CBD5E1; font-size: 13px; }
        .btn-logout { padding: 6px 14px; background: transparent; border: 1px solid #475569; color: #CBD5E1; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: inherit; }
        .btn-logout:hover { background: rgba(255,255,255,0.1); }

        .nav-tabs { background: white; border-bottom: 1px solid #E2E8F0; padding: 0 2rem; display: flex; gap: 0; }
        .nav-tab { padding: 14px 20px; font-size: 14px; font-weight: 600; color: #64748B; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-tab:hover { color: var(--navy); }
        .nav-tab.active { color: var(--navy); border-bottom-color: var(--gold); }

        .main { max-width: 1100px; margin: 0 auto; padding: 24px; }

        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stat-label { font-size: 12px; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--navy); margin-top: 4px; }
        .stat-detail { font-size: 12px; color: #94A3B8; margin-top: 2px; }

        .card { background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 24px; overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid #F1F5F9; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--navy); }
        .card-body { padding: 20px; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 14px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748B; font-weight: 600; border-bottom: 2px solid #E2E8F0; }
        td { padding: 12px 14px; font-size: 14px; border-bottom: 1px solid #F1F5F9; }

        .status-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .status-new { background: #DBEAFE; color: #1E40AF; }
        .status-review { background: #FEF3C7; color: #92400E; }
        .status-approved { background: #DCFCE7; color: #166534; }
        .status-funded { background: #D1FAE5; color: #065F46; }
        .status-declined { background: #FEE2E2; color: #991B1B; }

        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-gold { background: var(--gold); color: white; }
        .btn-gold:hover { background: #b8953f; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-secondary { background: #F1F5F9; color: #475569; border: 1px solid #E2E8F0; }
        .btn-navy { background: var(--navy); color: white; }
        .btn-navy:hover { background: #051428; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; font-size: 13px; color: var(--navy); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 14px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }

        .page-section { display: none; }
        .page-section.active { display: block; }

        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--navy), #1a3a6b); }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .login-card h2 { font-size: 20px; color: var(--navy); margin-bottom: 6px; text-align: center; }
        .login-card p { font-size: 13px; color: #64748B; text-align: center; margin-bottom: 24px; }

        .deal-card { border: 1px solid #E2E8F0; border-radius: 10px; padding: 16px; margin-bottom: 12px; transition: all 0.2s; cursor: pointer; }
        .deal-card:hover { border-color: var(--gold); box-shadow: 0 2px 8px rgba(201,168,76,0.15); }
        .deal-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .deal-card-company { font-weight: 700; color: var(--navy); font-size: 15px; }
        .deal-card-details { display: flex; gap: 16px; font-size: 13px; color: #64748B; }

        .syndication-badge { display: inline-flex; align-items: center; gap: 4px; background: #DBEAFE; color: #1E40AF; padding: 2px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; }

        .notes-timeline { margin-top: 16px; }
        .note-item { padding: 10px 14px; border-left: 3px solid var(--gold); background: #FAFAF8; border-radius: 0 6px 6px 0; margin-bottom: 8px; }
        .note-meta { font-size: 11px; color: #94A3B8; margin-bottom: 4px; }
        .note-text { font-size: 13px; color: #475569; line-height: 1.5; }

        .empty-state { text-align: center; padding: 40px; color: #94A3B8; font-size: 14px; }
        .footer { text-align: center; padding: 2rem; font-size: 12px; color: #94A3B8; }
        .footer a { color: var(--gold); text-decoration: none; }

        @media (max-width: 768px) {
            .stats-row { grid-template-columns: 1fr 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 8px; text-align: center; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:28px;">üè¶</div>
        </div>
        <h2>Syndication Desk Portal</h2>
        <p>Alliance Financing Group ‚Äî Institutional Access</p>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="your@institution.com">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Your password" onkeyup="if(event.key==='Enter')handleSyndLogin()">
        </div>
        <button class="btn btn-navy" style="width:100%;padding:12px;" onclick="handleSyndLogin()">Sign In</button>
        <p id="loginError" style="color:var(--danger);font-size:13px;text-align:center;margin-top:10px;display:none;"></p>
    </div>
</div>

<!-- Portal App -->
<div id="portalApp" style="display:none;">
    <div class="header">
        <div class="header-left">
            <h1><span>Alliance</span> Financing Group</h1>
            <div class="header-institution" id="syndInstitutionName">Syndication Desk</div>
        </div>
        <div class="header-right">
            <span class="header-user" id="syndUserName">User</span>
            <button class="btn-logout" onclick="handleSyndLogout()">Logout</button>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showSyndPage('overview')">Overview</div>
        <div class="nav-tab" onclick="showSyndPage('pipeline')">Deal Pipeline</div>
        <div class="nav-tab" onclick="showSyndPage('submit')">Submit Request</div>
        <div class="nav-tab" onclick="showSyndPage('history')">History</div>
    </div>

    <div class="main">
        <!-- Overview Page -->
        <div id="syndOverview" class="page-section active">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Active Syndications</div>
                    <div class="stat-value" id="sStatActive">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Pipeline Value</div>
                    <div class="stat-value" id="sStatPipeline">$0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Funded This Year</div>
                    <div class="stat-value" id="sStatFunded">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Volume Funded</div>
                    <div class="stat-value" id="sStatVolume">$0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Active Syndicated Deals</div>
                </div>
                <div class="card-body" id="activeSyndDeals">
                    <p class="empty-state">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Pipeline Page -->
        <div id="syndPipeline" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Full Deal Pipeline</div>
                    <div style="display:flex;gap:8px;">
                        <select id="syndStatusFilter" onchange="renderPipeline()" style="padding:6px 10px;border:1px solid #E2E8F0;border-radius:6px;font-size:13px;">
                            <option value="">All Statuses</option>
                            <option value="New">New</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Approved">Approved</option>
                            <option value="In funding">In Funding</option>
                            <option value="Funded">Funded</option>
                            <option value="Declined">Declined</option>
                        </select>
                    </div>
                </div>
                <div class="card-body" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Deal #</th>
                                <th>Company</th>
                                <th>Product</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="pipelineBody">
                            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Submit Syndication Request Page -->
        <div id="syndSubmit" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Submit Syndication Request</div>
                </div>
                <div class="card-body">
                    <p style="color:#64748B;font-size:14px;margin-bottom:20px;">Submit a new syndication request for Alliance Financing to review. Our team will assess and respond within 24-48 hours.</p>
                    <form id="syndDealForm" onsubmit="submitSyndRequest(event)">
                        <div style="font-weight:700;color:var(--navy);font-size:15px;margin-bottom:12px;">Borrower Information</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Borrower / Company Name *</label>
                                <input type="text" id="sdCompanyName" required>
                            </div>
                            <div class="form-group">
                                <label>Industry / Sector</label>
                                <input type="text" id="sdIndustry" placeholder="e.g., Manufacturing, Healthcare">
                            </div>
                        </div>

                        <div style="font-weight:700;color:var(--navy);font-size:15px;margin:20px 0 12px;border-top:1px solid #E2E8F0;padding-top:16px;">Transaction Details</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Transaction Amount *</label>
                                <input type="number" id="sdAmount" required placeholder="0.00" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>Currency</label>
                                <select id="sdCurrency">
                                    <option value="CAD">CAD</option>
                                    <option value="USD">USD</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Financing Type *</label>
                                <select id="sdProduct" required>
                                    <option value="">Select Type</option>
                                    <option value="Equipment Leasing">Equipment Leasing</option>
                                    <option value="Term Loan">Term Loan</option>
                                    <option value="Working Capital">Working Capital</option>
                                    <option value="Commercial Mortgage">Commercial Mortgage</option>
                                    <option value="MCA">MCA</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Proposed Term</label>
                                <input type="text" id="sdTerm" placeholder="e.g., 36 months, 5 years">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Transaction Summary *</label>
                            <textarea id="sdSummary" rows="4" required placeholder="Provide a summary of the transaction, collateral, borrower background, and any relevant details..."></textarea>
                        </div>

                        <div style="font-weight:700;color:var(--navy);font-size:15px;margin:20px 0 12px;border-top:1px solid #E2E8F0;padding-top:16px;">Your Contact for This Deal</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contact Name</label>
                                <input type="text" id="sdContactName" placeholder="Desk contact for this deal">
                            </div>
                            <div class="form-group">
                                <label>Contact Email</label>
                                <input type="email" id="sdContactEmail" placeholder="contact@institution.com">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-navy" style="padding:12px 32px;font-size:15px;">Submit Syndication Request</button>
                        <p id="syndSubmitError" style="color:var(--danger);font-size:13px;margin-top:10px;display:none;"></p>
                        <p id="syndSubmitSuccess" style="color:var(--green);font-size:13px;margin-top:10px;display:none;"></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div id="syndHistory" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Completed Transactions</div>
                </div>
                <div class="card-body" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Deal #</th>
                                <th>Company</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Funded Date</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>¬© 2025 Alliance Financing Group. All rights reserved.</p>
        <p style="margin-top: 4px;"><a href="https://alliancefinancing.ai">alliancefinancing.ai</a></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = 'https://uernphejrcsicnkobsdw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlcm5waGVqcmNzaWNua29ic2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzU3ODksImV4cCI6MjA4NjUxMTc4OX0.A2YN3gkaYwR_9nyE3OkWl5Io9tfxe8lTgC913stXmUI';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let syndUser = null;
    let syndDeals = [];

    async function handleSyndLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errEl = document.getElementById('loginError');
        errEl.style.display = 'none';

        if (!email || !password) {
            errEl.textContent = 'Please enter email and password.';
            errEl.style.display = 'block';
            return;
        }

        try {
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) throw error;

            const { data: userData, error: userError } = await db
                .from('users')
                .select('*')
                .ilike('email', email)
                .maybeSingle();

            if (userError) throw userError;
            if (!userData || userData.agent_type !== 'syndication_desk') {
                await db.auth.signOut();
                errEl.textContent = 'This portal is for syndication desk partners only.';
                errEl.style.display = 'block';
                return;
            }

            syndUser = userData;
            showPortal();
        } catch (err) {
            errEl.textContent = err.message || 'Login failed.';
            errEl.style.display = 'block';
        }
    }

    function showPortal() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('portalApp').style.display = 'block';
        document.getElementById('syndInstitutionName').textContent = syndUser.company_name || 'Syndication Desk';
        document.getElementById('syndUserName').textContent = syndUser.full_name || syndUser.email;
        loadSyndData();
    }

    async function handleSyndLogout() {
        await db.auth.signOut();
        syndUser = null;
        document.getElementById('portalApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
    }

    function showSyndPage(page) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

        const pageMap = { 'overview': 'syndOverview', 'pipeline': 'syndPipeline', 'submit': 'syndSubmit', 'history': 'syndHistory' };
        const el = document.getElementById(pageMap[page]);
        if (el) el.classList.add('active');

        const tabs = document.querySelectorAll('.nav-tab');
        const tabIndex = { 'overview': 0, 'pipeline': 1, 'submit': 2, 'history': 3 };
        if (tabs[tabIndex[page]]) tabs[tabIndex[page]].classList.add('active');

        if (page === 'pipeline') renderPipeline();
        if (page === 'history') renderHistory();
    }

    function getStatusBadge(status) {
        const map = {
            'New': 'status-new', 'In Review': 'status-review', 'Under Review': 'status-review',
            'Approved': 'status-approved', 'Funded': 'status-funded', 'Declined': 'status-declined',
            'Approval sent': 'status-approved', 'In funding': 'status-approved'
        };
        const cls = map[status] || 'status-new';
        return `<span class="status-badge ${cls}">${status || 'New'}</span>`;
    }

    function formatCurrency(amount) {
        return '$' + Number(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    async function loadSyndData() {
        try {
            // Get deals where this syndication desk is the source agent
            const { data: deals } = await db
                .from('deals')
                .select('deal_number, company_name, deal_amount, currency, status, product, created_at, is_syndicated, notes')
                .eq('source_agent_id', syndUser.id)
                .order('created_at', { ascending: false });

            syndDeals = deals || [];

            // Stats
            const active = syndDeals.filter(d => !['Funded', 'Declined', 'Withdrawn'].includes(d.status));
            const funded = syndDeals.filter(d => d.status === 'Funded');
            const pipelineValue = active.reduce((sum, d) => sum + (d.deal_amount || 0), 0);
            const totalVolume = funded.reduce((sum, d) => sum + (d.deal_amount || 0), 0);

            document.getElementById('sStatActive').textContent = active.length;
            document.getElementById('sStatPipeline').textContent = formatCurrency(pipelineValue);
            document.getElementById('sStatFunded').textContent = funded.length;
            document.getElementById('sStatVolume').textContent = formatCurrency(totalVolume);

            // Active deals cards
            const container = document.getElementById('activeSyndDeals');
            if (active.length === 0) {
                container.innerHTML = '<p class="empty-state">No active syndicated deals. Submit a new request to get started.</p>';
            } else {
                container.innerHTML = active.map(d => `
                    <div class="deal-card">
                        <div class="deal-card-header">
                            <div class="deal-card-company">${d.company_name || 'N/A'} <span class="syndication-badge">Syndicated</span></div>
                            ${getStatusBadge(d.status)}
                        </div>
                        <div class="deal-card-details">
                            <span><strong>Deal:</strong> ${d.deal_number || 'N/A'}</span>
                            <span><strong>Amount:</strong> ${formatCurrency(d.deal_amount)} ${d.currency || 'CAD'}</span>
                            <span><strong>Product:</strong> ${d.product || 'N/A'}</span>
                            <span><strong>Submitted:</strong> ${formatDate(d.created_at)}</span>
                        </div>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error('Load syndication data error:', err);
        }
    }

    function renderPipeline() {
        const statusFilter = document.getElementById('syndStatusFilter').value;
        const filtered = statusFilter ? syndDeals.filter(d => d.status === statusFilter) : syndDeals;

        const tbody = document.getElementById('pipelineBody');
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No deals found.</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(d => `
            <tr>
                <td><strong>${d.deal_number || 'N/A'}</strong></td>
                <td>${d.company_name || 'N/A'}</td>
                <td>${d.product || 'N/A'}</td>
                <td>${formatCurrency(d.deal_amount)} ${d.currency || 'CAD'}</td>
                <td>${getStatusBadge(d.status)}</td>
                <td>${formatDate(d.created_at)}</td>
            </tr>
        `).join('');
    }

    function renderHistory() {
        const completed = syndDeals.filter(d => ['Funded', 'Declined', 'Withdrawn'].includes(d.status));
        const tbody = document.getElementById('historyBody');
        if (completed.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No completed transactions yet.</td></tr>';
            return;
        }
        tbody.innerHTML = completed.map(d => `
            <tr>
                <td><strong>${d.deal_number || 'N/A'}</strong></td>
                <td>${d.company_name || 'N/A'}</td>
                <td>${formatCurrency(d.deal_amount)} ${d.currency || 'CAD'}</td>
                <td>${getStatusBadge(d.status)}</td>
                <td>${formatDate(d.created_at)}</td>
            </tr>
        `).join('');
    }

    async function submitSyndRequest(event) {
        event.preventDefault();
        const errEl = document.getElementById('syndSubmitError');
        const successEl = document.getElementById('syndSubmitSuccess');
        errEl.style.display = 'none';
        successEl.style.display = 'none';

        try {
            const companyName = document.getElementById('sdCompanyName').value.trim();
            const industry = document.getElementById('sdIndustry').value.trim();
            const amount = parseFloat(document.getElementById('sdAmount').value);
            const currency = document.getElementById('sdCurrency').value;
            const product = document.getElementById('sdProduct').value;
            const term = document.getElementById('sdTerm').value.trim();
            const summary = document.getElementById('sdSummary').value.trim();
            const contactName = document.getElementById('sdContactName').value.trim();
            const contactEmail = document.getElementById('sdContactEmail').value.trim();

            const dealNumber = 'AF-SD-' + Date.now().toString(36).toUpperCase();

            const noteText = `üè¶ Syndication request from ${syndUser.company_name || syndUser.full_name}. ${industry ? 'Industry: ' + industry + '.' : ''} ${term ? 'Proposed term: ' + term + '.' : ''} ${contactName ? 'Desk contact: ' + contactName + (contactEmail ? ' (' + contactEmail + ')' : '') + '.' : ''}\n\nSummary: ${summary}`;

            const { data, error } = await db
                .from('deals')
                .insert([{
                    deal_number: dealNumber,
                    company_name: companyName,
                    deal_amount: amount,
                    currency: currency,
                    product: product,
                    status: 'New',
                    source_agent_id: syndUser.id,
                    source: 'Syndication Portal',
                    is_syndicated: true,
                    notes: JSON.stringify([{
                        text: noteText,
                        author: syndUser.full_name || 'Syndication Desk',
                        date: new Date().toISOString(),
                        visible_to_agent: true
                    }]),
                    created_at: new Date().toISOString()
                }])
                .select();

            if (error) throw error;

            document.getElementById('syndDealForm').reset();
            successEl.textContent = 'Syndication request submitted successfully! Reference: ' + dealNumber;
            successEl.style.display = 'block';
            loadSyndData();

        } catch (err) {
            console.error('Submit syndication request error:', err);
            errEl.textContent = err.message || 'Error submitting request.';
            errEl.style.display = 'block';
        }
    }

    // Check for existing session on load
    async function checkSession() {
        const { data: { session } } = await db.auth.getSession();
        if (session) {
            const { data: userData } = await db
                .from('users')
                .select('*')
                .ilike('email', session.user.email)
                .maybeSingle();
            if (userData && userData.agent_type === 'syndication_desk') {
                syndUser = userData;
                showPortal();
            }
        }
    }
    checkSession();
</script>
</body>
</html>
