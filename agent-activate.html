<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JEP3FEBY4V"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-JEP3FEBY4V');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activate Your Account - Alliance Financing Group</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #F1F5F9; min-height: 100vh; color: #1E293B; }
        :root { --navy: #0D1E3D; --gold: #C9A84C; --green: #10B981; --blue: #2563EB; --danger: #EF4444; }

        .header { background: var(--navy); padding: 1.25rem 0; text-align: center; }
        .header h1 { color: #fff; font-size: 1.25rem; font-weight: 700; }
        .header h1 span { color: var(--gold); }

        .container { max-width: 560px; margin: 2rem auto; padding: 0 1.5rem; }

        .card { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 1.5rem; }
        .card-header-welcome { background: linear-gradient(135deg, var(--navy), #1a3a6b); padding: 32px; color: #fff; text-align: center; }
        .card-header-welcome h2 { font-size: 1.5rem; margin-bottom: 8px; }
        .card-header-welcome p { font-size: 0.9rem; opacity: 0.85; }
        .card-header-success { background: linear-gradient(135deg, #065F46, #10B981); padding: 32px; color: #fff; text-align: center; }
        .card-header-success h2 { font-size: 1.5rem; margin-bottom: 8px; }
        .card-header-success p { font-size: 0.9rem; opacity: 0.9; }
        .card-body { padding: 28px; }

        .type-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); padding: 6px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; margin-top: 12px; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; font-size: 14px; color: var(--navy); margin-bottom: 6px; }
        .form-group input { width: 100%; padding: 12px 14px; border: 1px solid #E2E8F0; border-radius: 8px; font-size: 14px; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.15); }
        .form-group small { display: block; margin-top: 4px; font-size: 12px; color: #64748B; }

        .password-requirements { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px; padding: 14px; margin-bottom: 20px; }
        .password-requirements p { font-size: 12px; color: #64748B; margin-bottom: 6px; font-weight: 600; }
        .password-requirements ul { list-style: none; padding: 0; }
        .password-requirements li { font-size: 12px; color: #94A3B8; padding: 2px 0; }
        .password-requirements li.met { color: var(--green); }
        .password-requirements li::before { content: '‚óã '; }
        .password-requirements li.met::before { content: '‚óè '; }

        .btn-activate { width: 100%; padding: 14px; background: linear-gradient(135deg, var(--navy), #1a3a6b); color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.2s; }
        .btn-activate:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(13,30,61,0.3); }
        .btn-activate:disabled { background: #E5E7EB; color: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-dashboard { display: inline-block; width: 100%; padding: 14px; background: var(--gold); color: #fff; border: none; border-radius: 8px; font-weight: 700; font-size: 16px; cursor: pointer; text-align: center; text-decoration: none; transition: all 0.2s; }
        .btn-dashboard:hover { background: #b8953f; }

        .error-msg { text-align: center; padding: 40px; color: var(--danger); }
        .error-msg h3 { margin-bottom: 8px; }

        .welcome-info { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .info-item { padding: 12px; background: #F8FAFC; border-radius: 8px; border: 1px solid #E2E8F0; }
        .info-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748B; font-weight: 600; }
        .info-value { font-size: 15px; font-weight: 600; color: var(--navy); margin-top: 2px; }

        .quick-start { margin-top: 24px; }
        .quick-start h3 { font-size: 16px; font-weight: 700; color: var(--navy); margin-bottom: 12px; }
        .quick-start-item { display: flex; gap: 12px; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid #F1F5F9; }
        .quick-start-item:last-child { border-bottom: none; }
        .quick-start-num { width: 28px; height: 28px; background: var(--navy); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; flex-shrink: 0; }
        .quick-start-text { font-size: 14px; color: #475569; line-height: 1.5; }
        .quick-start-text strong { color: var(--navy); }

        .loading { text-align: center; padding: 60px; }
        .spinner { width: 36px; height: 36px; border: 3px solid #E2E8F0; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .footer { text-align: center; padding: 2rem; font-size: 12px; color: #94A3B8; }
        .footer a { color: var(--gold); text-decoration: none; }
    </style>
</head>
<body>

<div class="header">
    <h1><span>Alliance</span> Financing Group</h1>
</div>

<div class="container">
    <!-- Loading State -->
    <div id="loadingState" class="card">
        <div class="card-body loading">
            <div class="spinner"></div>
            <p style="color: #64748B;">Validating your invitation...</p>
        </div>
    </div>

    <!-- Error State -->
    <div id="errorState" style="display:none;">
        <div class="card">
            <div class="card-body error-msg">
                <h3 id="errorTitle">Invalid Link</h3>
                <p id="errorMessage">This activation link is invalid or has expired. Please contact Alliance Financing Group for assistance.</p>
            </div>
        </div>
    </div>

    <!-- Phase 1: Set Password -->
    <div id="activatePhase" style="display:none;">
        <div class="card">
            <div class="card-header-welcome">
                <h2>Welcome to Alliance Financing</h2>
                <p id="welcomeName">Set up your account to get started</p>
                <div class="type-badge" id="typeBadge"></div>
            </div>
            <div class="card-body">
                <div class="welcome-info" id="agentInfo"></div>

                <div style="border-top: 1px solid #E2E8F0; margin: 0 0 20px; padding-top: 20px;">
                    <h3 style="font-size: 16px; font-weight: 700; color: var(--navy); margin-bottom: 16px;">Create Your Password</h3>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="activateEmail" readonly style="background: #F8FAFC; cursor: not-allowed;">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="activatePassword" placeholder="Create a strong password" oninput="checkPasswordStrength()">
                </div>
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="activatePasswordConfirm" placeholder="Re-enter your password" oninput="checkPasswordStrength()">
                </div>

                <div class="password-requirements" id="passwordReqs">
                    <p>Password Requirements:</p>
                    <ul>
                        <li id="reqLength">At least 8 characters</li>
                        <li id="reqUpper">One uppercase letter</li>
                        <li id="reqLower">One lowercase letter</li>
                        <li id="reqNumber">One number</li>
                        <li id="reqMatch">Passwords match</li>
                    </ul>
                </div>

                <button class="btn-activate" id="activateBtn" onclick="activateAccount()" disabled>
                    Activate My Account
                </button>
                <p id="activateError" style="color: var(--danger); font-size: 13px; text-align: center; margin-top: 10px; display: none;"></p>
            </div>
        </div>
    </div>

    <!-- Phase 2: Success + Quick Start Guide -->
    <div id="successPhase" style="display:none;">
        <div class="card">
            <div class="card-header-success">
                <h2>Account Activated!</h2>
                <p>You're all set to start using Alliance Financing</p>
            </div>
            <div class="card-body">
                <div class="quick-start" id="quickStartGuide"></div>
                <div style="margin-top: 24px;">
                    <a href="dashboard.html" class="btn-dashboard">Go to Dashboard ‚Üí</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="footer">
    <p>¬© 2025 Alliance Financing Group. All rights reserved.</p>
    <p style="margin-top: 4px;"><a href="https://alliancefinancing.ai">alliancefinancing.ai</a></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = 'https://uernphejrcsicnkobsdw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlcm5waGVqcmNzaWNua29ic2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzU3ODksImV4cCI6MjA4NjUxMTc4OX0.A2YN3gkaYwR_9nyE3OkWl5Io9tfxe8lTgC913stXmUI';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let agentData = null;

    const typeLabels = {
        'super_agent': 'üèÜ Super Agent',
        'referring_agent': 'ü§ù Referring Agent',
        'syndication_desk': 'üè¶ Syndication Desk',
        'vendor_program': 'üè≠ Vendor Program',
        'vendor_salesperson': 'üë§ Vendor Salesperson'
    };

    const quickStartByType = {
        'super_agent': [
            { title: 'View Your Dashboard', desc: 'See your deal pipeline, team performance, and commission summary at a glance.' },
            { title: 'Manage Your Team', desc: 'Invite sub-agents, track their deals, and manage override commissions.' },
            { title: 'Share Your Referral Link', desc: 'Use your unique referral link to track applications from your network.' },
            { title: 'Submit Deals', desc: 'Submit new deals directly through the portal or use the application forms.' }
        ],
        'referring_agent': [
            { title: 'View Your Dashboard', desc: 'See your active deals, referral stats, and commission tracking.' },
            { title: 'Share Your Referral Link', desc: 'Find your unique referral link on the dashboard. Share it with clients.' },
            { title: 'Access Marketing Materials', desc: 'Download branded flyers, email templates, and social media content.' },
            { title: 'Track Your Deals', desc: 'Monitor the status of every deal you refer through the pipeline.' }
        ],
        'syndication_desk': [
            { title: 'View Your Dashboard', desc: 'See your syndicated deal pipeline and transaction status.' },
            { title: 'Review Deal Flow', desc: 'Access deals available for syndication and submit your interest.' },
            { title: 'Track Transactions', desc: 'Monitor the progress of syndicated deals from submission to funding.' },
            { title: 'Access Your Portal', desc: 'Use your branded syndication portal for streamlined deal management.' }
        ],
        'vendor_program': [
            { title: 'View Your Dashboard', desc: 'See your submitted deals, approval status, and program stats.' },
            { title: 'Manage Your Sales Team', desc: 'View your salespeople\'s deals and overall program performance.' },
            { title: 'Submit Customer Deals', desc: 'Submit financing applications on behalf of your customers.' },
            { title: 'Access Your Portal', desc: 'Use your branded vendor portal to manage all financing requests.' }
        ],
        'vendor_salesperson': [
            { title: 'Access Your Portal', desc: 'Log into the vendor portal to manage your customer financing requests.' },
            { title: 'Submit Customer Deals', desc: 'Submit new financing requests for your customers quickly and easily.' },
            { title: 'Track Your Deals', desc: 'Monitor the status of every deal you\'ve submitted from start to funding.' },
            { title: 'Stay Connected', desc: 'Your manager can see your activity and help with any questions.' }
        ]
    };

    // Initialize
    async function init() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        if (!token) {
            showError('Missing Token', 'No activation token was provided. Please use the link from your invitation email.');
            return;
        }

        try {
            const { data, error } = await db
                .from('users')
                .select('*')
                .eq('invite_token', token)
                .maybeSingle();

            if (error) throw error;

            if (!data) {
                showError('Invalid Link', 'This activation link is invalid or has already been used.');
                return;
            }

            if (data.onboarding_status === 'active' && data.invite_accepted_at) {
                showError('Already Activated', 'This account has already been activated. <a href="dashboard.html" style="color:var(--gold);font-weight:600;">Go to Dashboard ‚Üí</a>');
                return;
            }

            agentData = data;
            showActivatePhase();
        } catch (err) {
            console.error('Init error:', err);
            showError('Error', 'Something went wrong. Please try again or contact support.');
        }
    }

    function showError(title, message) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('errorState').style.display = 'block';
        document.getElementById('errorTitle').textContent = title;
        document.getElementById('errorMessage').innerHTML = message;
    }

    function showActivatePhase() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('activatePhase').style.display = 'block';

        const agentType = agentData.agent_type || 'referring_agent';
        document.getElementById('welcomeName').textContent = 'Welcome, ' + (agentData.full_name || 'Partner') + '!';
        document.getElementById('typeBadge').textContent = typeLabels[agentType] || 'ü§ù Agent';
        document.getElementById('activateEmail').value = agentData.email || '';

        // Build agent info grid
        let infoHtml = `
            <div class="info-item">
                <div class="info-label">Name</div>
                <div class="info-value">${agentData.full_name || 'N/A'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value">${agentData.email || 'N/A'}</div>
            </div>
        `;
        if (agentData.company_name) {
            infoHtml += `
                <div class="info-item">
                    <div class="info-label">${agentType === 'syndication_desk' ? 'Institution' : agentType === 'vendor_program' ? 'Company' : 'Company'}</div>
                    <div class="info-value">${agentData.company_name}</div>
                </div>
            `;
        }
        if (agentData.business_type) {
            infoHtml += `
                <div class="info-item">
                    <div class="info-label">Business Type</div>
                    <div class="info-value">${agentData.business_type}</div>
                </div>
            `;
        }
        document.getElementById('agentInfo').innerHTML = infoHtml;
    }

    function checkPasswordStrength() {
        const pw = document.getElementById('activatePassword').value;
        const pwConfirm = document.getElementById('activatePasswordConfirm').value;

        const checks = {
            reqLength: pw.length >= 8,
            reqUpper: /[A-Z]/.test(pw),
            reqLower: /[a-z]/.test(pw),
            reqNumber: /[0-9]/.test(pw),
            reqMatch: pw.length > 0 && pw === pwConfirm
        };

        Object.entries(checks).forEach(([id, met]) => {
            const el = document.getElementById(id);
            if (met) el.classList.add('met');
            else el.classList.remove('met');
        });

        const allMet = Object.values(checks).every(v => v);
        document.getElementById('activateBtn').disabled = !allMet;
    }

    async function activateAccount() {
        const btn = document.getElementById('activateBtn');
        const errEl = document.getElementById('activateError');
        btn.disabled = true;
        btn.textContent = 'Activating...';
        errEl.style.display = 'none';

        const email = agentData.email;
        const password = document.getElementById('activatePassword').value;

        try {
            // 1. Create Supabase Auth account
            const { data: authData, error: authError } = await db.auth.signUp({
                email: email,
                password: password
            });

            if (authError) throw authError;

            // 2. Update user record
            const { error: updateError } = await db
                .from('users')
                .update({
                    onboarding_status: 'active',
                    invite_accepted_at: new Date().toISOString(),
                    agent_status: 'Active'
                })
                .eq('id', agentData.id);

            if (updateError) throw updateError;

            // 3. Show success phase
            showSuccessPhase();

        } catch (err) {
            console.error('Activation error:', err);
            errEl.textContent = err.message || 'Error activating account. Please try again.';
            errEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Activate My Account';
        }
    }

    function showSuccessPhase() {
        document.getElementById('activatePhase').style.display = 'none';
        document.getElementById('successPhase').style.display = 'block';

        const agentType = agentData.agent_type || 'referring_agent';
        const steps = quickStartByType[agentType] || quickStartByType['referring_agent'];

        document.getElementById('quickStartGuide').innerHTML = `
            <h3>Quick Start Guide for ${typeLabels[agentType] || 'Agents'}</h3>
            ${steps.map((step, i) => `
                <div class="quick-start-item">
                    <div class="quick-start-num">${i + 1}</div>
                    <div class="quick-start-text">
                        <strong>${step.title}</strong><br>
                        ${step.desc}
                    </div>
                </div>
            `).join('')}
        `;
    }

    // Start
    init();
</script>
</body>
</html>
