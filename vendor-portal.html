<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JEP3FEBY4V"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date());gtag('config','G-JEP3FEBY4V');</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Program Portal - Alliance Financing Group</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: #F1F5F9; min-height: 100vh; color: #1E293B; }
        :root { --navy: #0D1E3D; --gold: #C9A84C; --green: #10B981; --blue: #2563EB; --danger: #EF4444; }

        .header { background: var(--navy); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header h1 { color: #fff; font-size: 1.1rem; font-weight: 700; }
        .header h1 span { color: var(--gold); }
        .header-vendor { color: var(--gold); font-size: 14px; font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-user { color: #CBD5E1; font-size: 13px; }
        .btn-logout { padding: 6px 14px; background: transparent; border: 1px solid #475569; color: #CBD5E1; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: inherit; }
        .btn-logout:hover { background: rgba(255,255,255,0.1); }

        .nav-tabs { background: white; border-bottom: 1px solid #E2E8F0; padding: 0 2rem; display: flex; gap: 0; }
        .nav-tab { padding: 14px 20px; font-size: 14px; font-weight: 600; color: #64748B; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-tab:hover { color: var(--navy); }
        .nav-tab.active { color: var(--navy); border-bottom-color: var(--gold); }

        .main { max-width: 1100px; margin: 0 auto; padding: 24px; }

        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .stat-label { font-size: 12px; color: #64748B; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--navy); margin-top: 4px; }
        .stat-detail { font-size: 12px; color: #94A3B8; margin-top: 2px; }

        .card { background: white; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 24px; overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid #F1F5F9; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 16px; font-weight: 700; color: var(--navy); }
        .card-body { padding: 20px; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px 14px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #64748B; font-weight: 600; border-bottom: 2px solid #E2E8F0; }
        td { padding: 12px 14px; font-size: 14px; border-bottom: 1px solid #F1F5F9; }

        .status-badge { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .status-new { background: #DBEAFE; color: #1E40AF; }
        .status-review { background: #FEF3C7; color: #92400E; }
        .status-approved { background: #DCFCE7; color: #166534; }
        .status-funded { background: #D1FAE5; color: #065F46; }
        .status-declined { background: #FEE2E2; color: #991B1B; }
        .status-quote { background: #F3E8FF; color: #6B21A8; }
        .status-quoted { background: #E0E7FF; color: #3730A3; }

        .term-tag { display: inline-block; padding: 2px 8px; background: #F1F5F9; border: 1px solid #E2E8F0; border-radius: 4px; font-size: 12px; font-weight: 600; color: var(--navy); margin: 2px; }
        .term-tag.selected { background: var(--navy); color: white; border-color: var(--navy); cursor: pointer; }
        .term-selector { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .term-checkbox { display: none; }
        .term-checkbox + label { display: inline-block; padding: 6px 14px; background: #F1F5F9; border: 2px solid #E2E8F0; border-radius: 6px; font-size: 13px; font-weight: 600; color: #64748B; cursor: pointer; transition: all 0.2s; }
        .term-checkbox:checked + label { background: var(--navy); color: white; border-color: var(--navy); }
        .term-checkbox + label:hover { border-color: var(--gold); }

        .btn { padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.2s; }
        .btn-gold { background: var(--gold); color: white; }
        .btn-gold:hover { background: #b8953f; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-secondary { background: #F1F5F9; color: #475569; border: 1px solid #E2E8F0; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-weight: 600; font-size: 13px; color: var(--navy); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #E2E8F0; border-radius: 6px; font-size: 14px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }

        .page-section { display: none; }
        .page-section.active { display: block; }

        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, var(--navy), #1a3a6b); }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .login-card h2 { font-size: 20px; color: var(--navy); margin-bottom: 6px; text-align: center; }
        .login-card p { font-size: 13px; color: #64748B; text-align: center; margin-bottom: 24px; }

        .empty-state { text-align: center; padding: 40px; color: #94A3B8; font-size: 14px; }
        .footer { text-align: center; padding: 2rem; font-size: 12px; color: #94A3B8; }
        .footer a { color: var(--gold); text-decoration: none; }

        @media (max-width: 768px) {
            .stats-row { grid-template-columns: 1fr 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 8px; text-align: center; }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:28px;">üè≠</div>
        </div>
        <h2>Vendor Program Portal</h2>
        <p>Alliance Financing Group ‚Äî Partner Access</p>
        <div class="form-group">
            <label>Email</label>
            <input type="email" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
            <label>Password</label>
            <input type="password" id="loginPassword" placeholder="Your password" onkeyup="if(event.key==='Enter')handleVendorLogin()">
        </div>
        <button class="btn btn-gold" style="width:100%;padding:12px;" onclick="handleVendorLogin()">Sign In</button>
        <p id="loginError" style="color:var(--danger);font-size:13px;text-align:center;margin-top:10px;display:none;"></p>
    </div>
</div>

<!-- Portal App -->
<div id="portalApp" style="display:none;">
    <div class="header">
        <div class="header-left">
            <h1><span>Alliance</span> Financing Group</h1>
            <div class="header-vendor" id="vendorCompanyName">Vendor Program</div>
        </div>
        <div class="header-right">
            <span class="header-user" id="vendorUserName">User</span>
            <button class="btn-logout" onclick="handleVendorLogout()">Logout</button>
        </div>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="showVendorPage('overview')">Overview</div>
        <div class="nav-tab" onclick="showVendorPage('quote')">Request Quote</div>
        <div class="nav-tab" onclick="showVendorPage('quotes')">My Quotes</div>
        <div class="nav-tab" onclick="showVendorPage('submit')">Submit Deal</div>
        <div class="nav-tab" onclick="showVendorPage('deals')">My Deals</div>
        <div class="nav-tab" id="teamTab" onclick="showVendorPage('team')" style="display:none;">My Team</div>
        <div class="nav-tab" onclick="showVendorPage('documents')">Documents</div>
    </div>

    <div class="main">
        <!-- Overview Page -->
        <div id="vendorOverview" class="page-section active">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Total Deals Submitted</div>
                    <div class="stat-value" id="vStatTotal">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active in Pipeline</div>
                    <div class="stat-value" id="vStatActive">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Approved</div>
                    <div class="stat-value" id="vStatApproved">0</div>
                    <div class="stat-detail">This year</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Funded</div>
                    <div class="stat-value" id="vStatFunded">$0</div>
                </div>
            </div>

            <!-- Quick Quote CTA -->
            <div class="card" style="border-left:4px solid var(--gold);margin-bottom:24px;">
                <div class="card-body" style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;">
                    <div>
                        <div style="font-weight:700;color:var(--navy);font-size:15px;">Need a quick quote for your client?</div>
                        <div style="font-size:13px;color:#64748B;margin-top:2px;">Submit the capital cost and terms ‚Äî we'll send you back pricing to share with your customer.</div>
                    </div>
                    <button class="btn btn-gold" onclick="showVendorPage('quote')" style="white-space:nowrap;">üì® Request Quote</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Recent Deals</div>
                    <button class="btn btn-gold btn-sm" onclick="showVendorPage('submit')">+ Submit New Deal</button>
                </div>
                <div class="card-body" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Deal #</th>
                                <th>Customer</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody id="recentDealsBody">
                            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Submit Deal Page -->
        <div id="vendorSubmit" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Submit New Financing Request</div>
                </div>
                <div class="card-body">
                    <p style="color:#64748B;font-size:14px;margin-bottom:20px;">Submit a financing request on behalf of your customer. Alliance Financing will review and process the application.</p>
                    <form id="vendorDealForm" onsubmit="submitVendorDeal(event)">
                        <div style="font-weight:700;color:var(--navy);font-size:15px;margin-bottom:12px;">Customer Information</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Customer / Business Name *</label>
                                <input type="text" id="vdCompanyName" required>
                            </div>
                            <div class="form-group">
                                <label>Contact Name *</label>
                                <input type="text" id="vdContactName" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Contact Email *</label>
                                <input type="email" id="vdContactEmail" required>
                            </div>
                            <div class="form-group">
                                <label>Contact Phone</label>
                                <input type="tel" id="vdContactPhone">
                            </div>
                        </div>

                        <div style="font-weight:700;color:var(--navy);font-size:15px;margin:20px 0 12px;border-top:1px solid #E2E8F0;padding-top:16px;">Equipment & Financing Details</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Equipment Description *</label>
                                <input type="text" id="vdEquipment" required placeholder="e.g., CNC Machine, Forklift, Medical Equipment">
                            </div>
                            <div class="form-group">
                                <label>Equipment Cost *</label>
                                <input type="number" id="vdAmount" required placeholder="0.00" step="0.01">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Financing Type</label>
                                <select id="vdFinancingType">
                                    <option value="Equipment Leasing">Equipment Leasing</option>
                                    <option value="Equipment Loan">Equipment Loan</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Preferred Term</label>
                                <select id="vdTerm">
                                    <option value="">Select Term</option>
                                    <option value="12">12 Months</option>
                                    <option value="24">24 Months</option>
                                    <option value="36">36 Months</option>
                                    <option value="48">48 Months</option>
                                    <option value="60">60 Months</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Additional Notes</label>
                            <textarea id="vdNotes" rows="3" placeholder="Any additional details about the equipment or customer..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-gold" style="padding:12px 32px;font-size:15px;">Submit Financing Request</button>
                        <p id="submitError" style="color:var(--danger);font-size:13px;margin-top:10px;display:none;"></p>
                        <p id="submitSuccess" style="color:var(--green);font-size:13px;margin-top:10px;display:none;"></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- Deals List Page -->
        <div id="vendorDeals" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Submitted Deals</div>
                </div>
                <div class="card-body" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Deal #</th>
                                <th>Customer</th>
                                <th>Equipment</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Submitted</th>
                            </tr>
                        </thead>
                        <tbody id="allDealsBody">
                            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Team Page (Manager Only) -->
        <div id="vendorTeam" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Sales Team</div>
                    <button class="btn btn-gold btn-sm" onclick="showInviteModal()">+ Invite Salesperson</button>
                </div>
                <div class="card-body" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Deals</th>
                                <th>Pipeline Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="teamBody">
                            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Team Deals Breakdown -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">All Team Deals</div>
                </div>
                <div class="card-body" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Deal #</th>
                                <th>Customer</th>
                                <th>Submitted By</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="teamDealsBody">
                            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Invite Salesperson Modal -->
        <div id="inviteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;display:none;align-items:center;justify-content:center;">
            <div style="background:white;border-radius:12px;max-width:450px;width:90%;padding:28px;box-shadow:0 10px 40px rgba(0,0,0,0.2);">
                <h3 style="font-size:18px;color:var(--navy);margin-bottom:16px;">Invite Salesperson</h3>
                <p style="font-size:13px;color:#64748B;margin-bottom:16px;">Add a salesperson to your vendor program. They'll receive an email to activate their account.</p>
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="inviteName" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="inviteEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="invitePhone">
                </div>
                <div class="form-group">
                    <label>Sales Role / Title</label>
                    <input type="text" id="inviteRole" placeholder="e.g., Account Executive">
                </div>
                <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
                    <button class="btn btn-secondary" onclick="hideInviteModal()">Cancel</button>
                    <button class="btn btn-gold" onclick="inviteSalesperson()">Send Invite</button>
                </div>
                <p id="inviteError" style="color:var(--danger);font-size:13px;margin-top:10px;display:none;"></p>
                <p id="inviteSuccess" style="color:var(--green);font-size:13px;margin-top:10px;display:none;"></p>
            </div>
        </div>

        <!-- Request Quote Page -->
        <div id="vendorQuote" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Request a Quote</div>
                </div>
                <div class="card-body">
                    <p style="color:#64748B;font-size:14px;margin-bottom:20px;">Submit a quick quote request and we'll send you back pricing your client can review. No full application needed ‚Äî just the basics.</p>
                    <form id="quoteRequestForm" onsubmit="submitQuoteRequest(event)">
                        <div style="font-weight:700;color:var(--navy);font-size:15px;margin-bottom:12px;">Client Information</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Company Name *</label>
                                <input type="text" id="qrCompanyName" required placeholder="Client's business name">
                            </div>
                            <div class="form-group">
                                <label>Contact Person *</label>
                                <input type="text" id="qrContactPerson" required placeholder="Full name">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Company Address</label>
                            <input type="text" id="qrCompanyAddress" placeholder="Street address, City, Province, Postal Code">
                        </div>

                        <div style="font-weight:700;color:var(--navy);font-size:15px;margin:20px 0 12px;border-top:1px solid #E2E8F0;padding-top:16px;">Quote Details</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Amount to be Financed (Before Taxes) *</label>
                                <input type="number" id="qrAmount" required placeholder="0.00" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label>Equipment Description <span style="font-weight:400;color:#94A3B8;">(optional)</span></label>
                                <input type="text" id="qrEquipment" placeholder="e.g., CNC Machine, Forklift">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Term Requested * <span style="font-weight:400;color:#94A3B8;">(select all that apply)</span></label>
                            <div class="term-selector">
                                <input type="checkbox" class="term-checkbox" id="term12" value="12"><label for="term12">12 Months</label>
                                <input type="checkbox" class="term-checkbox" id="term24" value="24"><label for="term24">24 Months</label>
                                <input type="checkbox" class="term-checkbox" id="term36" value="36"><label for="term36">36 Months</label>
                                <input type="checkbox" class="term-checkbox" id="term48" value="48"><label for="term48">48 Months</label>
                                <input type="checkbox" class="term-checkbox" id="term60" value="60"><label for="term60">60 Months</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Purchase Option *</label>
                            <select id="qrPurchaseOption" required>
                                <option value="">Select purchase option...</option>
                                <option value="FMV">FMV (Fair Market Value)</option>
                                <option value="True Lease">True Lease ($1 Buyout)</option>
                                <option value="Both">Both ‚Äî FMV & True Lease</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Additional Notes <span style="font-weight:400;color:#94A3B8;">(optional)</span></label>
                            <textarea id="qrNotes" rows="3" placeholder="Any additional details or special requirements..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-gold" style="padding:12px 32px;font-size:15px;">üì® Send Quote Request</button>
                        <p id="quoteError" style="color:var(--danger);font-size:13px;margin-top:10px;display:none;"></p>
                        <p id="quoteSuccess" style="color:var(--green);font-size:13px;margin-top:10px;display:none;"></p>
                    </form>
                </div>
            </div>
        </div>

        <!-- My Quotes Page -->
        <div id="vendorQuotes" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">My Quote Requests</div>
                    <button class="btn btn-gold btn-sm" onclick="showVendorPage('quote')">+ New Quote Request</button>
                </div>
                <div class="card-body" style="padding:0;">
                    <table>
                        <thead>
                            <tr>
                                <th>Quote #</th>
                                <th>Company</th>
                                <th>Amount</th>
                                <th>Terms</th>
                                <th>Purchase Option</th>
                                <th>Status</th>
                                <th>Requested</th>
                            </tr>
                        </thead>
                        <tbody id="quotesBody">
                            <tr><td colspan="7" class="empty-state">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Documents Page -->
        <div id="vendorDocuments" class="page-section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Documents</div>
                </div>
                <div class="card-body">
                    <p style="color:#64748B;font-size:14px;">Documents related to your deals will appear here. You can upload supporting documents for any active deal.</p>
                    <div id="vendorDocsContainer" style="margin-top:16px;">
                        <p class="empty-state">No documents yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>¬© 2025 Alliance Financing Group. All rights reserved.</p>
        <p style="margin-top: 4px;"><a href="https://alliancefinancing.ai">alliancefinancing.ai</a></p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SUPABASE_URL = 'https://uernphejrcsicnkobsdw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlcm5waGVqcmNzaWNua29ic2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzU3ODksImV4cCI6MjA4NjUxMTc4OX0.A2YN3gkaYwR_9nyE3OkWl5Io9tfxe8lTgC913stXmUI';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let vendorUser = null;
    let vendorDeals = [];
    let vendorQuotes = [];
    let isManager = false;
    let teamMembers = [];
    let allTeamDeals = [];

    async function handleVendorLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const errEl = document.getElementById('loginError');
        errEl.style.display = 'none';

        if (!email || !password) {
            errEl.textContent = 'Please enter email and password.';
            errEl.style.display = 'block';
            return;
        }

        try {
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) throw error;

            // Verify user is vendor_program OR vendor_salesperson
            const { data: userData, error: userError } = await db
                .from('users')
                .select('*')
                .ilike('email', email)
                .maybeSingle();

            if (userError) throw userError;
            if (!userData || !['vendor_program', 'vendor_salesperson'].includes(userData.agent_type)) {
                await db.auth.signOut();
                errEl.textContent = 'This portal is for vendor program partners only.';
                errEl.style.display = 'block';
                return;
            }

            vendorUser = userData;
            isManager = userData.agent_type === 'vendor_program';
            showPortal();
        } catch (err) {
            errEl.textContent = err.message || 'Login failed.';
            errEl.style.display = 'block';
        }
    }

    function showPortal() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('portalApp').style.display = 'block';
        document.getElementById('vendorCompanyName').textContent = vendorUser.company_name || 'Vendor Program';
        document.getElementById('vendorUserName').textContent = vendorUser.full_name || vendorUser.email;

        // Show/hide manager-only features
        const teamTab = document.getElementById('teamTab');
        if (teamTab) teamTab.style.display = isManager ? 'block' : 'none';

        loadVendorData();
    }

    async function handleVendorLogout() {
        await db.auth.signOut();
        vendorUser = null;
        isManager = false;
        document.getElementById('portalApp').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
    }

    function showVendorPage(page) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

        const pageMap = { 'overview': 'vendorOverview', 'quote': 'vendorQuote', 'quotes': 'vendorQuotes', 'submit': 'vendorSubmit', 'deals': 'vendorDeals', 'team': 'vendorTeam', 'documents': 'vendorDocuments' };
        const el = document.getElementById(pageMap[page]);
        if (el) el.classList.add('active');

        const labelMap = { 'overview': 'Overview', 'quote': 'Request Quote', 'quotes': 'My Quotes', 'submit': 'Submit Deal', 'deals': 'My Deals', 'team': 'My Team', 'documents': 'Documents' };
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach(t => { if (t.textContent.trim() === labelMap[page]) t.classList.add('active'); });

        if (page === 'deals') loadAllDeals();
        if (page === 'team') loadTeam();
        if (page === 'quotes') loadQuotes();
    }

    function getStatusBadge(status) {
        const map = {
            'New': 'status-new', 'In Review': 'status-review', 'Under Review': 'status-review',
            'Approved': 'status-approved', 'Funded': 'status-funded', 'Declined': 'status-declined',
            'Approval sent': 'status-approved', 'In funding': 'status-approved'
        };
        const cls = map[status] || 'status-new';
        return `<span class="status-badge ${cls}">${status || 'New'}</span>`;
    }

    function formatCurrency(amount) {
        return '$' + Number(amount || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    async function loadVendorData() {
        try {
            // If manager, also load team members and their deals
            if (isManager) {
                const { data: members } = await db
                    .from('users')
                    .select('id, full_name, email, phone, agent_status, program_details')
                    .eq('parent_agent_id', vendorUser.id)
                    .eq('agent_type', 'vendor_salesperson');
                teamMembers = members || [];

                // Get all team agent IDs (manager + salespeople)
                const teamIds = [vendorUser.id, ...teamMembers.map(m => m.id)];

                // Load all deals for the entire team
                const { data: deals } = await db
                    .from('deals')
                    .select('deal_number, company_name, deal_amount, status, created_at, product, source_agent_id')
                    .in('source_agent_id', teamIds)
                    .order('created_at', { ascending: false });

                allTeamDeals = deals || [];
                vendorDeals = allTeamDeals; // Manager overview shows all team deals
            } else {
                // Salesperson sees only their deals
                const { data: deals } = await db
                    .from('deals')
                    .select('deal_number, company_name, deal_amount, status, created_at, product, source_agent_id')
                    .eq('source_agent_id', vendorUser.id)
                    .order('created_at', { ascending: false });

                vendorDeals = deals || [];
                allTeamDeals = vendorDeals;
            }

            // Update stats
            const active = vendorDeals.filter(d => !['Funded', 'Declined', 'Withdrawn'].includes(d.status));
            const approved = vendorDeals.filter(d => ['Approved', 'Approval sent', 'In funding', 'Funded'].includes(d.status));
            const funded = vendorDeals.filter(d => d.status === 'Funded');
            const totalFunded = funded.reduce((sum, d) => sum + (d.deal_amount || 0), 0);

            document.getElementById('vStatTotal').textContent = vendorDeals.length;
            document.getElementById('vStatActive').textContent = active.length;
            document.getElementById('vStatApproved').textContent = approved.length;
            document.getElementById('vStatFunded').textContent = formatCurrency(totalFunded);

            // Recent deals (last 5)
            const recent = vendorDeals.slice(0, 5);
            const tbody = document.getElementById('recentDealsBody');
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No deals submitted yet. Click "Submit New Deal" to get started.</td></tr>';
            } else {
                tbody.innerHTML = recent.map(d => `
                    <tr>
                        <td><strong>${d.deal_number || 'N/A'}</strong></td>
                        <td>${d.company_name || 'N/A'}</td>
                        <td>${formatCurrency(d.deal_amount)}</td>
                        <td>${getStatusBadge(d.status)}</td>
                        <td>${formatDate(d.created_at)}</td>
                    </tr>
                `).join('');
            }
        } catch (err) {
            console.error('Load vendor data error:', err);
        }
    }

    async function loadAllDeals() {
        const tbody = document.getElementById('allDealsBody');
        if (vendorDeals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No deals submitted yet.</td></tr>';
            return;
        }
        tbody.innerHTML = vendorDeals.map(d => `
            <tr>
                <td><strong>${d.deal_number || 'N/A'}</strong></td>
                <td>${d.company_name || 'N/A'}</td>
                <td>${d.product || 'Equipment Leasing'}</td>
                <td>${formatCurrency(d.deal_amount)}</td>
                <td>${getStatusBadge(d.status)}</td>
                <td>${formatDate(d.created_at)}</td>
            </tr>
        `).join('');
    }

    async function submitVendorDeal(event) {
        event.preventDefault();
        const errEl = document.getElementById('submitError');
        const successEl = document.getElementById('submitSuccess');
        errEl.style.display = 'none';
        successEl.style.display = 'none';

        try {
            const companyName = document.getElementById('vdCompanyName').value.trim();
            const contactName = document.getElementById('vdContactName').value.trim();
            const contactEmail = document.getElementById('vdContactEmail').value.trim();
            const contactPhone = document.getElementById('vdContactPhone').value.trim();
            const equipment = document.getElementById('vdEquipment').value.trim();
            const amount = parseFloat(document.getElementById('vdAmount').value);
            const financingType = document.getElementById('vdFinancingType').value;
            const term = document.getElementById('vdTerm').value;
            const notes = document.getElementById('vdNotes').value.trim();

            // Generate deal number
            const dealNumber = 'AF-VP-' + Date.now().toString(36).toUpperCase();

            const { data, error } = await db
                .from('deals')
                .insert([{
                    deal_number: dealNumber,
                    company_name: companyName,
                    deal_amount: amount,
                    product: financingType,
                    status: 'New',
                    source_agent_id: vendorUser.id,
                    source: 'Vendor Portal',
                    notes: JSON.stringify([{
                        text: `üìã Submitted via Vendor Portal by ${vendorUser.company_name || vendorUser.full_name}. Equipment: ${equipment}. Contact: ${contactName} (${contactEmail}${contactPhone ? ', ' + contactPhone : ''}). ${term ? 'Preferred term: ' + term + ' months.' : ''} ${notes ? 'Notes: ' + notes : ''}`,
                        author: vendorUser.full_name || 'Vendor',
                        date: new Date().toISOString(),
                        visible_to_agent: true
                    }]),
                    created_at: new Date().toISOString()
                }])
                .select();

            if (error) throw error;

            // Add client contact
            if (data && data[0]) {
                await db.from('client_contacts').insert([{
                    deal_id: data[0].id,
                    contact_name: contactName,
                    email: contactEmail,
                    phone: contactPhone || null,
                    role: 'Customer',
                    is_primary: true
                }]);
            }

            document.getElementById('vendorDealForm').reset();
            successEl.textContent = 'Deal submitted successfully! Deal #: ' + dealNumber;
            successEl.style.display = 'block';
            loadVendorData();

        } catch (err) {
            console.error('Submit deal error:', err);
            errEl.textContent = err.message || 'Error submitting deal.';
            errEl.style.display = 'block';
        }
    }

    // Team management functions (manager only)
    async function loadTeam() {
        if (!isManager) return;

        // Build name lookup
        const nameLookup = {};
        nameLookup[vendorUser.id] = vendorUser.full_name || vendorUser.email;
        teamMembers.forEach(m => { nameLookup[m.id] = m.full_name || m.email; });

        const tbody = document.getElementById('teamBody');
        if (teamMembers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No salespeople yet. Click "Invite Salesperson" to add your first team member.</td></tr>';
        } else {
            tbody.innerHTML = teamMembers.map(m => {
                const memberDeals = allTeamDeals.filter(d => d.source_agent_id === m.id);
                const pipelineValue = memberDeals.filter(d => !['Funded', 'Declined', 'Withdrawn'].includes(d.status)).reduce((sum, d) => sum + (d.deal_amount || 0), 0);
                const salesRole = m.program_details && m.program_details.sales_role ? m.program_details.sales_role : 'Sales Rep';
                return `
                <tr>
                    <td><strong>${m.full_name || 'N/A'}</strong></td>
                    <td>${m.email || 'N/A'}</td>
                    <td>${salesRole}</td>
                    <td>${memberDeals.length}</td>
                    <td>${formatCurrency(pipelineValue)}</td>
                    <td><span class="status-badge ${m.agent_status === 'Active' ? 'status-approved' : 'status-review'}">${m.agent_status || 'Pending'}</span></td>
                </tr>
            `}).join('');
        }

        // Team deals
        const teamDealsBody = document.getElementById('teamDealsBody');
        if (allTeamDeals.length === 0) {
            teamDealsBody.innerHTML = '<tr><td colspan="6" class="empty-state">No team deals yet.</td></tr>';
        } else {
            teamDealsBody.innerHTML = allTeamDeals.map(d => {
                const submitter = nameLookup[d.source_agent_id] || 'Unknown';
                return `
                <tr>
                    <td><strong>${d.deal_number || 'N/A'}</strong></td>
                    <td>${d.company_name || 'N/A'}</td>
                    <td>${submitter}</td>
                    <td>${formatCurrency(d.deal_amount)}</td>
                    <td>${getStatusBadge(d.status)}</td>
                    <td>${formatDate(d.created_at)}</td>
                </tr>
            `}).join('');
        }
    }

    function showInviteModal() {
        document.getElementById('inviteModal').style.display = 'flex';
        document.getElementById('inviteError').style.display = 'none';
        document.getElementById('inviteSuccess').style.display = 'none';
    }

    function hideInviteModal() {
        document.getElementById('inviteModal').style.display = 'none';
    }

    async function inviteSalesperson() {
        const name = document.getElementById('inviteName').value.trim();
        const email = document.getElementById('inviteEmail').value.trim();
        const phone = document.getElementById('invitePhone').value.trim();
        const role = document.getElementById('inviteRole').value.trim();
        const errEl = document.getElementById('inviteError');
        const successEl = document.getElementById('inviteSuccess');
        errEl.style.display = 'none';
        successEl.style.display = 'none';

        if (!name || !email) {
            errEl.textContent = 'Name and email are required.';
            errEl.style.display = 'block';
            return;
        }

        try {
            const slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            const inviteToken = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));

            const { error } = await db.from('users').insert([{
                full_name: name,
                email: email,
                phone: phone || null,
                role: 'agent',
                agent_type: 'vendor_salesperson',
                parent_agent_id: vendorUser.id,
                company_name: vendorUser.company_name || null,
                referral_slug: slug,
                agent_status: 'Invited',
                onboarding_status: 'invited',
                invite_token: inviteToken,
                invite_sent_at: new Date().toISOString(),
                commission_type: 'none',
                program_details: { sales_role: role || 'Sales Rep' },
                created_at: new Date().toISOString()
            }]);

            if (error) throw error;

            // Open mailto with invite
            const activateUrl = window.location.origin + '/agent-activate.html?token=' + inviteToken;
            const subject = encodeURIComponent(`Welcome to ${vendorUser.company_name || 'Alliance Financing'} ‚Äî Activate Your Account`);
            const body = encodeURIComponent(
`Hi ${name},

You've been invited to join ${vendorUser.company_name || 'our vendor program'} on Alliance Financing Group.

Click below to set up your account and start submitting financing requests:

${activateUrl}

Welcome to the team!

${vendorUser.full_name || 'Your Manager'}
${vendorUser.company_name || 'Alliance Financing Group'}`);
            window.open('mailto:' + email + '?subject=' + subject + '&body=' + body, '_blank');

            successEl.textContent = 'Invite sent to ' + name + '! Email window opened.';
            successEl.style.display = 'block';

            // Clear form
            document.getElementById('inviteName').value = '';
            document.getElementById('inviteEmail').value = '';
            document.getElementById('invitePhone').value = '';
            document.getElementById('inviteRole').value = '';

            // Refresh data
            loadVendorData();
            setTimeout(() => loadTeam(), 1000);

        } catch (err) {
            errEl.textContent = err.message || 'Error sending invite.';
            errEl.style.display = 'block';
        }
    }

    // ===== Quote Request Functions =====
    async function submitQuoteRequest(event) {
        event.preventDefault();
        const errEl = document.getElementById('quoteError');
        const successEl = document.getElementById('quoteSuccess');
        errEl.style.display = 'none';
        successEl.style.display = 'none';

        try {
            const companyName = document.getElementById('qrCompanyName').value.trim();
            const contactPerson = document.getElementById('qrContactPerson').value.trim();
            const companyAddress = document.getElementById('qrCompanyAddress').value.trim();
            const amount = parseFloat(document.getElementById('qrAmount').value);
            const equipment = document.getElementById('qrEquipment').value.trim();
            const purchaseOption = document.getElementById('qrPurchaseOption').value;
            const notes = document.getElementById('qrNotes').value.trim();

            // Collect selected terms
            const selectedTerms = [];
            document.querySelectorAll('.term-checkbox:checked').forEach(cb => selectedTerms.push(parseInt(cb.value)));

            if (selectedTerms.length === 0) {
                errEl.textContent = 'Please select at least one term.';
                errEl.style.display = 'block';
                return;
            }

            if (!purchaseOption) {
                errEl.textContent = 'Please select a purchase option.';
                errEl.style.display = 'block';
                return;
            }

            // Generate quote request number
            const quoteNumber = 'QR-' + Date.now().toString(36).toUpperCase();

            // Create a deal record with type "Quote Request" so it appears in admin pipeline
            const termsLabel = selectedTerms.map(t => t + ' mo').join(', ');
            const noteText = `üìã QUOTE REQUEST from ${vendorUser.company_name || vendorUser.full_name}\n` +
                `Company: ${companyName}\n` +
                `Contact: ${contactPerson}\n` +
                `Address: ${companyAddress || 'N/A'}\n` +
                `Amount (before taxes): $${amount.toLocaleString()}\n` +
                `${equipment ? 'Equipment: ' + equipment + '\n' : ''}` +
                `Terms Requested: ${termsLabel}\n` +
                `Purchase Option: ${purchaseOption}\n` +
                `${notes ? 'Notes: ' + notes : ''}`;

            const { data, error } = await db
                .from('deals')
                .insert([{
                    deal_number: quoteNumber,
                    company_name: companyName,
                    deal_amount: amount,
                    product: 'Quote Request',
                    status: 'Quote Requested',
                    source_agent_id: vendorUser.id,
                    source: 'Vendor Portal ‚Äî Quote Request',
                    notes: JSON.stringify([{
                        text: noteText,
                        author: vendorUser.full_name || 'Vendor',
                        date: new Date().toISOString(),
                        visible_to_agent: true
                    }]),
                    program_details: {
                        quote_request: true,
                        contact_person: contactPerson,
                        company_address: companyAddress,
                        equipment_description: equipment,
                        terms_requested: selectedTerms,
                        purchase_option: purchaseOption,
                        vendor_company: vendorUser.company_name || null,
                        vendor_name: vendorUser.full_name || null
                    },
                    created_at: new Date().toISOString()
                }])
                .select();

            if (error) throw error;

            // Add client contact
            if (data && data[0]) {
                await db.from('client_contacts').insert([{
                    deal_id: data[0].id,
                    contact_name: contactPerson,
                    role: 'Customer',
                    is_primary: true
                }]);
            }

            document.getElementById('quoteRequestForm').reset();
            // Uncheck all term checkboxes
            document.querySelectorAll('.term-checkbox').forEach(cb => cb.checked = false);

            successEl.textContent = '‚úÖ Quote request submitted! Reference #: ' + quoteNumber + '. Our team will send you a quote shortly.';
            successEl.style.display = 'block';

            // Refresh data
            loadVendorData();

        } catch (err) {
            console.error('Quote request error:', err);
            errEl.textContent = err.message || 'Error submitting quote request.';
            errEl.style.display = 'block';
        }
    }

    async function loadQuotes() {
        const tbody = document.getElementById('quotesBody');
        try {
            // Fetch quote requests (deals with product = 'Quote Request')
            let query = db
                .from('deals')
                .select('deal_number, company_name, deal_amount, status, created_at, program_details')
                .eq('product', 'Quote Request')
                .order('created_at', { ascending: false });

            if (isManager) {
                const teamIds = [vendorUser.id, ...teamMembers.map(m => m.id)];
                query = query.in('source_agent_id', teamIds);
            } else {
                query = query.eq('source_agent_id', vendorUser.id);
            }

            const { data: quotes, error } = await query;
            if (error) throw error;

            vendorQuotes = quotes || [];

            if (vendorQuotes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No quote requests yet. Click "Request Quote" to get started.</td></tr>';
                return;
            }

            tbody.innerHTML = vendorQuotes.map(q => {
                const pd = q.program_details || {};
                const terms = (pd.terms_requested || []).map(t => `<span class="term-tag">${t}mo</span>`).join('');
                const statusCls = q.status === 'Quote Requested' ? 'status-quote' :
                                  q.status === 'Quote Sent' ? 'status-quoted' :
                                  q.status === 'Approved' ? 'status-approved' : 'status-new';
                return `
                    <tr>
                        <td><strong>${q.deal_number || 'N/A'}</strong></td>
                        <td>${q.company_name || 'N/A'}</td>
                        <td>${formatCurrency(q.deal_amount)}</td>
                        <td>${terms || 'N/A'}</td>
                        <td>${pd.purchase_option || 'N/A'}</td>
                        <td><span class="status-badge ${statusCls}">${q.status || 'Pending'}</span></td>
                        <td>${formatDate(q.created_at)}</td>
                    </tr>
                `;
            }).join('');

        } catch (err) {
            console.error('Load quotes error:', err);
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Error loading quotes.</td></tr>';
        }
    }

    // Check for existing session on load
    async function checkSession() {
        const { data: { session } } = await db.auth.getSession();
        if (session) {
            const { data: userData } = await db
                .from('users')
                .select('*')
                .ilike('email', session.user.email)
                .maybeSingle();
            if (userData && ['vendor_program', 'vendor_salesperson'].includes(userData.agent_type)) {
                vendorUser = userData;
                isManager = userData.agent_type === 'vendor_program';
                showPortal();
            }
        }
    }
    checkSession();
</script>
</body>
</html>
