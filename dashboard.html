<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alliance Financing AI - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --navy: #0D1E3D;
            --gold: #C9A84C;
            --light-gray: #F5F5F5;
            --border-gray: #E0E0E0;
            --text-dark: #333;
            --text-light: #666;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Arial', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-dark);
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--navy) 0%, #1a2e5a 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            font-size: 24px;
            color: var(--navy);
            margin-bottom: 5px;
        }

        .login-header p {
            font-size: 14px;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
            font-size: 14px;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-gray);
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(201, 168, 76, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--navy);
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary:hover {
            background-color: #051428;
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--text-dark);
            border: 1px solid var(--border-gray);
        }

        .btn-secondary:hover {
            background-color: #e8e8e8;
        }

        .btn-gold {
            background-color: var(--gold);
            color: white;
        }

        .btn-gold:hover {
            background-color: #b8953f;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        .error-message {
            color: var(--danger);
            font-size: 13px;
            margin-top: 5px;
        }

        .success-message {
            background-color: #ECFDF5;
            border: 1px solid #A7F3D0;
            color: #065F46;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: var(--navy);
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .sidebar-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--gold);
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            margin-top: 3px;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 12px;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background-color: var(--gold);
            color: var(--navy);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .user-info {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 15px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: white;
            padding: 20px 30px;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--navy);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* Page Sections */
        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-light);
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--navy);
        }

        .stat-detail {
            font-size: 12px;
            color: var(--text-light);
            margin-top: 8px;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table-header {
            background-color: var(--light-gray);
            padding: 20px;
            border-bottom: 1px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--navy);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-light);
            background-color: var(--light-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-gray);
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-gray);
            font-size: 14px;
        }

        tr:hover {
            background-color: var(--light-gray);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Status Badges */
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background-color: #ECFDF5;
            color: #065F46;
        }

        .badge-warning {
            background-color: #FFFBEB;
            color: #92400E;
        }

        .badge-danger {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        .badge-info {
            background-color: #EFF6FF;
            color: #0C4A6E;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.2s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-gray);
        }

        .modal-header h2 {
            color: var(--navy);
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-close:hover {
            color: var(--text-dark);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .modal-row.full {
            grid-template-columns: 1fr;
        }

        .modal-field {
            display: flex;
            flex-direction: column;
        }

        .modal-field label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--text-dark);
            font-size: 13px;
        }

        .modal-field-value {
            color: var(--text-light);
            padding: 8px 0;
            border-bottom: 1px solid var(--border-gray);
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .spinner {
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--gold);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state p {
            font-size: 16px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
                overflow-x: auto;
                overflow-y: hidden;
                display: flex;
                align-items: center;
                padding: 15px;
            }

            .sidebar-header {
                border: none;
                border-right: 1px solid rgba(255,255,255,0.1);
                margin-right: 20px;
                padding-right: 20px;
                margin-bottom: 0;
            }

            .nav-section {
                display: flex;
                gap: 10px;
                margin: 0;
            }

            .nav-section-title {
                display: none;
            }

            .nav-item {
                white-space: nowrap;
                margin: 0;
            }

            .sidebar-footer {
                margin-left: auto;
                border: none;
                padding: 0;
                margin-top: 0;
            }

            .header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
    <div class="login-card">
        <div class="login-header">
            <img src="alliance-logo-transparent.png" alt="Alliance Financing Group" style="max-width: 280px; height: auto; margin-bottom: 10px;">
            <p>Admin Dashboard</p>
        </div>
        <div id="loginError" class="error-message"></div>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" name="email" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" name="password" required>
            </div>
            <button type="submit" class="btn btn-primary">Sign In</button>
        </form>
        <div style="text-align: center; margin-top: 15px;">
            <a href="#" id="forgotPasswordLink" onclick="showForgotPassword(event)" style="color: var(--gold); text-decoration: none; font-size: 14px;">Forgot your password?</a>
        </div>
        <div id="forgotPasswordForm" style="display: none; margin-top: 15px;">
            <p style="font-size: 14px; color: var(--text-light); margin-bottom: 10px;">Enter your email and we'll send you a password reset link.</p>
            <div class="form-group">
                <label for="resetEmail">Email Address</label>
                <input type="email" id="resetEmail" required>
            </div>
            <button onclick="handleForgotPassword()" class="btn btn-primary">Send Reset Link</button>
            <div style="text-align: center; margin-top: 10px;">
                <a href="#" onclick="hideForgotPassword(event)" style="color: var(--text-light); text-decoration: none; font-size: 13px;">Back to login</a>
            </div>
            <div id="resetMessage" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px; font-size: 14px;"></div>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="appContainer" class="app-container" style="display: none;">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header" style="padding: 15px; text-align: center;">
            <img src="alliance-logo-transparent.png" alt="Alliance Financing Group" style="max-width: 180px; height: auto; filter: brightness(0) invert(1);">
        </div>

        <div class="nav-section">
            <div class="nav-item active" onclick="showPage('dashboard')">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showPage('deals')">
                <span class="nav-icon">üìà</span>
                <span>Deal Pipeline</span>
            </div>
            <div class="nav-item" onclick="showPage('agents')">
                <span class="nav-icon">üë•</span>
                <span>Agents & Partners</span>
            </div>
            <div class="nav-item" onclick="showPage('lenders')">
                <span class="nav-icon">üè¶</span>
                <span>Lenders</span>
            </div>
            <div class="nav-item" onclick="showPage('vendors')">
                <span class="nav-icon">ü§ù</span>
                <span>Vendors</span>
            </div>
            <div class="nav-item" onclick="showPage('contacts')">
                <span class="nav-icon">‚úâÔ∏è</span>
                <span>Contact Submissions</span>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="user-info">
                <div id="userEmailDisplay" style="font-weight: 500; margin-bottom: 10px;"></div>
                <button class="btn btn-secondary" onclick="handleLogout()" style="width: 100%; font-size: 12px;">
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="header-title" id="pageTitle">Dashboard</div>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="openCSVImportModal()" style="margin-right: 10px;">Import CSV</button>
                <span id="currentUser" style="color: var(--text-light); font-size: 14px;"></span>
            </div>
        </div>

        <div class="content-area">

            <!-- Dashboard Page -->
            <div id="dashboard" class="page-section active">
                <div class="stats-grid">
                    <div class="stat-card" id="statCard1">
                        <div class="stat-label">Deals Received This Month</div>
                        <div class="stat-value" id="dealsThisMonth">0</div>
                        <div class="stat-detail" id="dealsMonthLabel">Current month</div>
                    </div>
                    <div class="stat-card" id="statCard2">
                        <div class="stat-label">Active Pipeline Value</div>
                        <div class="stat-value" id="pipelineValue">$0</div>
                        <div class="stat-detail">In progress + pending</div>
                    </div>
                    <div class="stat-card" id="statCard3">
                        <div class="stat-label">Number of Lenders</div>
                        <div class="stat-value" id="totalLenders">0</div>
                        <div class="stat-detail">Total lending partners</div>
                    </div>
                    <div class="stat-card" id="statCard4">
                        <div class="stat-label">Vendor Programs</div>
                        <div class="stat-value" id="totalVendors">0</div>
                        <div class="stat-detail" id="vendorSalesPeople">0 sales contacts</div>
                    </div>
                </div>

                <!-- Agent Referral Link & Marketing Hub (agents only) -->
                <div id="agentReferralCard" class="table-container" style="display: none;">
                    <div class="table-header">
                        <div class="table-title">Your Referral Link & Marketing Hub</div>
                    </div>
                    <div style="padding: 20px; background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-radius: 8px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: #0D1E3D; margin-bottom: 8px;">Your Unique Referral URL:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="agentReferralUrl" readonly
                                    style="flex: 1; padding: 10px 12px; border: 1px solid #CBD5E1; border-radius: 4px; background: white; font-family: monospace; font-size: 13px;">
                                <button class="btn btn-gold btn-sm" onclick="copyReferralLink()">Copy Link</button>
                            </div>
                            <small style="display: block; color: #666; margin-top: 8px;">Share this link with potential clients. They'll be automatically matched to you when they apply.</small>
                        </div>
                        <div style="display: flex; gap: 30px; border-top: 1px solid rgba(13,30,61,0.1); padding-top: 15px;">
                            <div>
                                <label style="display: block; font-weight: 600; color: #0D1E3D; margin-bottom: 4px;">Your Referral Slug:</label>
                                <span id="agentReferralSlug" style="font-family: monospace; font-size: 14px; color: #334155;"></span>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #0D1E3D; margin-bottom: 4px;">Your Branded Landing Page:</label>
                                <a id="agentPartnerLink" href="#" target="_blank" style="font-size: 14px; color: #2563EB; text-decoration: underline;">View your landing page</a>
                            </div>
                        </div>
                        <!-- Application Form Links -->
                        <div style="border-top: 1px solid rgba(13,30,61,0.1); padding-top: 15px; margin-top: 15px;">
                            <label style="display: block; font-weight: 600; color: #0D1E3D; margin-bottom: 10px;">Client Application Forms (share these with your clients):</label>
                            <div id="agentAppFormLinks" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 10px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Referral Applications (agents only) -->
                <div id="agentReferralAppsCard" class="table-container" style="display: none;">
                    <div class="table-header">
                        <div class="table-title">My Referral Applications</div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Application ID</th>
                                    <th>Type</th>
                                    <th>Client Name</th>
                                    <th>Business</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Submitted</th>
                                </tr>
                            </thead>
                            <tbody id="agentReferralAppsBody">
                                <tr><td colspan="7" style="text-align: center; padding: 30px; color: #999;">Loading applications...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Agent Marketing Toolkit (agents only) -->
                <div id="agentMarketingToolkit" class="table-container" style="display: none;">
                    <div class="table-header" style="cursor: pointer;" onclick="toggleMarketingToolkit()">
                        <div class="table-title">Marketing Toolkit</div>
                        <span id="marketingToggleIcon" style="font-size: 18px; color: #666; transition: transform 0.3s;">&#9660;</span>
                    </div>
                    <div id="marketingToolkitBody" style="display: none; padding: 20px;">
                        <!-- Email Template Tabs -->
                        <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                            <button class="btn btn-sm" onclick="showEmailTemplate('mortgage')" id="tabMortgage" style="background: var(--gold); color: white; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-weight: 600;">Mortgage Brokers</button>
                            <button class="btn btn-sm" onclick="showEmailTemplate('insurance')" id="tabInsurance" style="background: #e2e8f0; color: #334155; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer;">Insurance Brokers</button>
                            <button class="btn btn-sm" onclick="showEmailTemplate('accountants')" id="tabAccountants" style="background: #e2e8f0; color: #334155; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer;">Accountants / CFOs</button>
                            <button class="btn btn-sm" onclick="showEmailTemplate('followup')" id="tabFollowup" style="background: #e2e8f0; color: #334155; border: none; padding: 6px 14px; border-radius: 4px; cursor: pointer;">Follow-Up</button>
                        </div>

                        <!-- Subject Line Options -->
                        <div id="emailSubjectLine" style="margin-bottom: 12px; padding: 10px; background: #FEF3C7; border-radius: 6px;">
                            <strong style="color: #92400E;">Subject Line Options:</strong>
                            <div id="emailSubjects" style="margin-top: 6px; color: #78350F; font-size: 13px; line-height: 1.6;"></div>
                        </div>

                        <!-- Email Body -->
                        <div style="position: relative;">
                            <textarea id="emailTemplateBody" readonly style="width: 100%; min-height: 350px; padding: 15px; border: 1px solid #CBD5E1; border-radius: 6px; font-family: Arial, sans-serif; font-size: 13px; line-height: 1.6; background: #f8fafc; resize: vertical;"></textarea>
                            <button onclick="copyEmailTemplate()" style="position: absolute; top: 10px; right: 10px; padding: 6px 14px; background: var(--gold); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px;">Copy Email</button>
                        </div>

                        <!-- PDF One-Pagers -->
                        <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border-radius: 8px;">
                            <div style="font-weight: 600; color: #0D1E3D; margin-bottom: 10px;">PDF One-Pagers (attach to your emails)</div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;" id="pdfAttachments">
                                <span style="color: #666; font-size: 13px;">Loading PDFs...</span>
                            </div>
                        </div>

                        <!-- Usage Tips -->
                        <div style="margin-top: 15px; padding: 12px; background: #f1f5f9; border-radius: 6px; font-size: 12px; color: #64748b; line-height: 1.5;">
                            <strong>Tips:</strong> Personalize the [First Name] before sending. Attach the matching PDF one-pager to each email. All application links include your referral tracking automatically.
                        </div>
                    </div>
                </div>

                <!-- Agent Vendor Programs Section (agents only) -->
                <div id="agentVendorProgramsSection" class="table-container" style="display: none;">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="table-title">Your Vendor Programs</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-gold btn-sm" onclick="openAgentAddVendorModal()">+ Submit Vendor</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Vendor Name</th>
                                <th>Product</th>
                                <th>Country</th>
                                <th>Salespeople</th>
                                <th>Projected Vol.</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentVendorsBody">
                            <tr><td colspan="6" class="empty-state">Loading vendor programs...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Agent Sub-Agents Section (agents only) -->
                <div id="agentSubAgentsSection" class="table-container" style="display: none;">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="table-title">Your Sub-Agents</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-gold btn-sm" onclick="openInviteSubAgentModal()">+ Invite Sub-Agent</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th># Deals</th>
                                <th>Override Earned</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentSubAgentsBody">
                            <tr><td colspan="7" class="empty-state">Loading sub-agents...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Agent Deals Section (agents only) -->
                <div id="agentCommissionsSection" class="table-container" style="display: none;">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="table-title">Your Deals</div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="agentDealSearch" placeholder="Search company, product, status..."
                                oninput="filterAgentDeals()"
                                style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; min-width: 250px;">
                            <button class="btn btn-gold btn-sm" onclick="openAddApplicationModal()">+ Add Application</button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Amount</th>
                                <th>Product</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Fee %</th>
                                <th>Fee $</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="commissionsBody">
                            <tr><td colspan="9" class="empty-state">Loading deals...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-container">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="table-title">Recent Applications (Intake)</div>
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <button class="btn btn-gold btn-sm" onclick="openAddApplicationModal()">+ Add Application</button>
                            <button class="btn btn-secondary btn-sm" onclick="openSendApplicationModal()" style="padding: 4px 12px; font-size: 12px;">Send Application Form</button>
                        </div>
                    </div>
                    <table id="recentApplicationsTable">
                        <thead>
                            <tr>
                                <th>AF #</th>
                                <th>Name</th>
                                <th>Business</th>
                                <th>Amount</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentAppBody">
                            <tr>
                                <td colspan="8" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Deal Pipeline Page -->
            <div id="deals" class="page-section">
                <div class="table-container">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="table-title">Deal Pipeline</div>
                        <!-- Pipeline View Tabs -->
                        <div id="dealTabs" style="display:flex;gap:0;border:1px solid #ccc;border-radius:6px;overflow:hidden;font-size:13px;">
                            <button class="deal-tab active" data-tab="active" onclick="switchDealTab('active')" style="padding:7px 16px;border:none;cursor:pointer;font-size:13px;font-weight:600;background:var(--navy);color:white;transition:all .2s;">Active <span id="dealCountActive" style="background:rgba(255,255,255,0.3);padding:1px 7px;border-radius:10px;font-size:11px;margin-left:4px;"></span></button>
                            <button class="deal-tab" data-tab="booked" onclick="switchDealTab('booked')" style="padding:7px 16px;border:none;border-left:1px solid #ccc;cursor:pointer;font-size:13px;font-weight:500;background:#f8fafc;color:#333;transition:all .2s;">Funded / Booked <span id="dealCountBooked" style="background:#e2e8f0;padding:1px 7px;border-radius:10px;font-size:11px;margin-left:4px;"></span></button>
                            <button class="deal-tab" data-tab="dead" onclick="switchDealTab('dead')" style="padding:7px 16px;border:none;border-left:1px solid #ccc;cursor:pointer;font-size:13px;font-weight:500;background:#f8fafc;color:#333;transition:all .2s;">Declined / Dead <span id="dealCountDead" style="background:#e2e8f0;padding:1px 7px;border-radius:10px;font-size:11px;margin-left:4px;"></span></button>
                            <button class="deal-tab" data-tab="archived" onclick="switchDealTab('archived')" style="padding:7px 16px;border:none;border-left:1px solid #ccc;cursor:pointer;font-size:13px;font-weight:500;background:#f8fafc;color:#666;transition:all .2s;">Archived <span id="dealCountArchived" style="background:#e2e8f0;padding:1px 7px;border-radius:10px;font-size:11px;margin-left:4px;"></span></button>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="dealSearch" placeholder="Search AF#, AFG#, company, product, lender..."
                                oninput="filterDeals()"
                                style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 280px;">
                            <select id="dealStatusFilter" onchange="filterDeals()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <option value="">All Status</option>
                                <option value="Prospect">Prospect</option>
                                <option value="Quote sent">Quote sent</option>
                                <option value="Info received">Info received</option>
                                <option value="In Credit">In Credit</option>
                                <option value="Approved">Approved</option>
                                <option value="Approval sent">Approval sent</option>
                                <option value="Docs requested">Docs requested</option>
                                <option value="Docs out for signing">Docs out for signing</option>
                                <option value="In funding">In funding</option>
                                <option value="Funded">Funded</option>
                                <option value="Declined">Declined</option>
                                <option value="Dead approval">Dead approval</option>
                                <option value="Withdrawn">Withdrawn</option>
                            </select>
                            <select id="dealSourceFilter" onchange="filterDeals()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <option value="">All Sources</option>
                                <option value="Online">Online</option>
                                <option value="Agent Referral">Agent Referral</option>
                                <option value="Direct">Direct</option>
                                <option value="Vendor">Vendor</option>
                                <option value="Repeat Client">Repeat Client</option>
                            </select>
                            <select id="dealProductFilter" onchange="filterDeals()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <option value="">All Products</option>
                                <option value="Equipment Leasing">Equipment Leasing</option>
                                <option value="MCA">MCA</option>
                                <option value="CSBFL">CSBFL</option>
                                <option value="SRED">SRED</option>
                                <option value="Private Debt">Private Debt</option>
                                <option value="Factoring">Factoring</option>
                                <option value="Merchant Advance">Merchant Advance</option>
                                <option value="Commercial Mortgage">Commercial Mortgage</option>
                                <option value="SBA">SBA</option>
                                <option value="Loans">Loans</option>
                                <option value="Trade Finance">Trade Finance</option>
                                <option value="Working Capital Loan">Working Capital Loan</option>
                                <option value="Business Line of Credit">Business Line of Credit</option>
                                <option value="Startup Financing">Startup Financing</option>
                                <option value="Franchise Financing">Franchise Financing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="exportDeals()">Export CSV</button>
                            <button class="btn btn-gold btn-sm" onclick="openAddDealModal()">+ New Deal</button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                    <table id="dealsTable" style="min-width:1100px;">
                        <thead>
                            <tr>
                                <th>AF #</th>
                                <th>AFG #</th>
                                <th>Company</th>
                                <th>Amount</th>
                                <th style="min-width:150px;">Product</th>
                                <th style="min-width:130px;">Source</th>
                                <th style="min-width:140px;">Lender</th>
                                <th style="min-width:140px;">Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dealsBody">
                            <tr>
                                <td colspan="10" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <!-- Agents Page -->
            <div id="agents" class="page-section">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Agents & Partners</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="exportAgents()" style="margin-left: 8px;">Export CSV</button>
                            <button class="btn btn-gold btn-sm" onclick="openAddAgentModal()">+ New Agent</button>
                        </div>
                    </div>
                    <table id="agentsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Parent Agent</th>
                                <th>Status</th>
                                <th>Referral Slug</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsBody">
                            <tr>
                                <td colspan="6" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Lenders Page -->
            <div id="lenders" class="page-section">
                <div class="table-container">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="table-title">Lenders</div>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="lenderSearch" placeholder="Search by name, type, country, currency..."
                                   oninput="filterLenders()"
                                   style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 300px;">
                            <select id="lenderCountryFilter" onchange="filterLenders()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <option value="">All Countries</option>
                                <option value="Canada">Canada</option>
                                <option value="United States">United States</option>
                                <option value="UK">UK</option>
                                <option value="Germany">Germany</option>
                            </select>
                            <select id="lenderStatusFilter" onchange="filterLenders()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="exportLenders()" style="margin-left: 8px;">Export CSV</button>
                            <button class="btn btn-gold btn-sm" onclick="openAddLenderModal()">+ New Lender</button>
                        </div>
                    </div>
                    <table id="lendersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Country</th>
                                <th>Currency</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="lendersBody">
                            <tr>
                                <td colspan="6" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Vendors Page -->
            <div id="vendors" class="page-section">
                <div class="table-container">
                    <div class="table-header" style="flex-wrap: wrap; gap: 12px;">
                        <div class="table-title">Vendors</div>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="text" id="vendorSearch" placeholder="Search by name, type, country, product..."
                                   oninput="filterVendors()"
                                   style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; width: 300px;">
                            <select id="vendorCountryFilter" onchange="filterVendors()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <option value="">All Countries</option>
                                <option value="Canada">Canada</option>
                                <option value="United States">United States</option>
                                <option value="UK">UK</option>
                                <option value="Germany">Germany</option>
                            </select>
                            <select id="vendorStatusFilter" onchange="filterVendors()" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="exportVendors()" style="margin-left: 8px;">Export CSV</button>
                            <button class="btn btn-gold btn-sm" onclick="openAddVendorModal()">+ New Vendor</button>
                        </div>
                    </div>
                    <table id="vendorsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Website</th>
                                <th>Product</th>
                                <th>Country</th>
                                <th>Source Agent</th>
                                <th>Salespeople</th>
                                <th>Projected Vol.</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="vendorsBody">
                            <tr>
                                <td colspan="9" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contact Submissions Page -->
            <div id="contacts" class="page-section">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Contact Submissions</div>
                        <button class="btn btn-secondary btn-sm" onclick="exportContacts()" style="margin-left: 8px;">Export CSV</button>
                    </div>
                    <table id="contactsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Subject</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contactsBody">
                            <tr>
                                <td colspan="6" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Deal Detail Modal -->
<div id="dealModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2>Deal Details</h2>
            <button class="modal-close" onclick="closeDealModal()">‚úï</button>
        </div>
        <div class="modal-body" id="dealModalBody">
        </div>
        <div class="modal-footer" style="display:flex;justify-content:space-between;align-items:center;">
            <div id="dealModalArchiveBtn"></div>
            <button class="btn btn-secondary" onclick="closeDealModal()">Close</button>
        </div>
    </div>
</div>

<!-- Add Vendor Modal (for agents) -->
<div id="agentAddVendorModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Submit a Vendor Program</h3>
            <span class="modal-close" onclick="document.getElementById('agentAddVendorModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Vendor / Company Name *</label>
                <input type="text" id="agentVendorName" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Website</label>
                <input type="text" id="agentVendorWebsite" placeholder="www.example.com" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Product Description *</label>
                <input type="text" id="agentVendorProduct" placeholder="e.g. Computer equipment, office furniture..." style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Country</label>
                <select id="agentVendorCountry" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                    <option value="Canada">Canada</option>
                    <option value="United States">United States</option>
                    <option value="UK">UK</option>
                    <option value="Germany">Germany</option>
                </select>
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Estimated Annual Volume ($)</label>
                <input type="number" id="agentVendorVolume" placeholder="500000" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <button class="btn btn-gold" onclick="handleAgentAddVendor()" style="width: 100%; margin-top: 10px;">Submit Vendor Program</button>
        </div>
    </div>
</div>

<!-- Agent Vendor Detail Modal -->
<div id="agentVendorDetailModal" class="modal">
    <div class="modal-content" style="max-width: 650px;">
        <div class="modal-header">
            <h3 id="agentVendorDetailTitle">Vendor Details</h3>
            <span class="modal-close" onclick="document.getElementById('agentVendorDetailModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body" id="agentVendorDetailBody">
            Loading...
        </div>
    </div>
</div>

<!-- Invite Sub-Agent Modal (for agents) -->
<div id="inviteSubAgentModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Invite a Sub-Agent</h3>
            <span class="modal-close" onclick="document.getElementById('inviteSubAgentModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body">
            <p style="color: #64748b; font-size: 13px; margin-bottom: 15px;">Add someone under your agent network. They'll be linked to you and you'll earn overrides on their deals.</p>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Full Name *</label>
                <input type="text" id="subAgentName" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Email *</label>
                <input type="email" id="subAgentEmail" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Phone</label>
                <input type="text" id="subAgentPhone" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 12px;">
                <label style="font-weight: 600; display: block; margin-bottom: 4px;">Business Type</label>
                <select id="subAgentBusinessType" style="width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                    <option value="">Select...</option>
                    <option value="Mortgage Agent">Mortgage Agent</option>
                    <option value="Mortgage Broker">Mortgage Broker</option>
                    <option value="Insurance">Insurance</option>
                    <option value="Consulting">Consulting</option>
                    <option value="Accounting">Accounting</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <button class="btn btn-gold" onclick="handleInviteSubAgent()" style="width: 100%; margin-top: 10px;">Invite Sub-Agent</button>
        </div>
    </div>
</div>

<!-- View Sub-Agent Modal (for agents) -->
<div id="viewSubAgentModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="subAgentDetailTitle">Sub-Agent Details</h3>
            <span class="modal-close" onclick="document.getElementById('viewSubAgentModal').style.display='none'">&times;</span>
        </div>
        <div class="modal-body" id="subAgentModalBody">
            Loading...
        </div>
    </div>
</div>

<!-- Add Application Modal (for agents) -->
<div id="addApplicationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Application</h2>
            <button class="modal-close" onclick="closeAddApplicationModal()">&times;</button>
        </div>
        <form id="addApplicationForm" onsubmit="handleAddApplication(event)">
            <div class="modal-row">
                <div class="modal-field">
                    <label>Full Name <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="appFullName" required>
                </div>
                <div class="modal-field">
                    <label>Email <span style="color: var(--danger);">*</span></label>
                    <input type="email" id="appEmail" required>
                </div>
            </div>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Phone <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="appPhone" required>
                </div>
                <div class="modal-field">
                    <label>Business Name <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="appBusinessName" required>
                </div>
            </div>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Time in Business <span style="color: var(--danger);">*</span></label>
                    <select id="appTimeInBusiness" required>
                        <option value="">Select</option>
                        <option value="Less than 1 Year">Less than 1 Year</option>
                        <option value="1 - 2 years">1 - 2 years</option>
                        <option value="2 - 5 years">2 - 5 years</option>
                        <option value="5 - 10 years">5 - 10 years</option>
                        <option value="Over 10 years">Over 10 years</option>
                    </select>
                </div>
                <div class="modal-field">
                    <label>Annual Revenue <span style="color: var(--danger);">*</span></label>
                    <select id="appAnnualRevenue" required>
                        <option value="">Select</option>
                        <option value="Under $500k">Under $500k</option>
                        <option value="$500k - $1m">$500k - $1m</option>
                        <option value="$1m - $5M">$1m - $5M</option>
                        <option value="$5M - $10M">$5M - $10M</option>
                        <option value="$10M - $25M">$10M - $25M</option>
                        <option value="Over $25m">Over $25m</option>
                    </select>
                </div>
            </div>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Funding Amount <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="appFundingAmount" required placeholder="e.g., $50,000">
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px;">Financing Type(s) <span style="color: var(--danger);">*</span></label>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Equipment Leasing"> Equipment Leasing
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="MCA"> MCA
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="CSBFL"> CSBFL
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="SRED"> SRED
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Private Debt"> Private Debt
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Factoring"> Factoring
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Merchant Advance"> Merchant Advance
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Commercial Mortgage"> Commercial Mortgage
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="SBA"> SBA
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Loans"> Loans
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Trade Finance"> Trade Finance
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: normal;">
                        <input type="checkbox" name="app_financing_type" value="Working Capital Loan"> Working Capital
                    </label>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 8px;">Description</label>
                <textarea id="appDescription" style="width: 100%; min-height: 80px; resize: vertical; padding: 8px; border: 1px solid #D1D5DB; border-radius: 4px;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddApplicationModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Submit Application</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Deal Modal -->
<div id="addDealModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Deal</h2>
            <button class="modal-close" onclick="closeAddDealModal()">‚úï</button>
        </div>
        <div class="modal-body" id="addDealModalBody">
            <form id="addDealForm" onsubmit="handleAddDeal(event)">
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Company Name</label>
                        <input type="text" id="companyName" required>
                    </div>
                    <div class="modal-field">
                        <label>Deal Amount</label>
                        <input type="number" id="dealAmount" step="0.01" required>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Currency</label>
                        <select id="dealCurrency">
                            <option value="CAD">CAD</option>
                            <option value="USD" selected>USD</option>
                            <option value="GBP">GBP</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Product Type</label>
                        <select id="productType" required>
                            <option value="">Select Product</option>
                            <option value="Equipment Leasing">Equipment Leasing</option>
                            <option value="MCA">MCA</option>
                            <option value="CSBFL">CSBFL</option>
                            <option value="SRED">SRED</option>
                            <option value="Private Debt">Private Debt</option>
                            <option value="Factoring">Factoring</option>
                            <option value="Merchant Advance">Merchant Advance</option>
                            <option value="Commercial Mortgage">Commercial Mortgage</option>
                            <option value="SBA">SBA</option>
                            <option value="Loans">Loans</option>
                            <option value="Trade Finance">Trade Finance</option>
                            <option value="Working Capital Loan">Working Capital Loan</option>
                            <option value="Business Line of Credit">Business Line of Credit</option>
                            <option value="Startup Financing">Startup Financing</option>
                            <option value="Franchise Financing">Franchise Financing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Source</label>
                        <select id="dealSource">
                            <option value="Direct">Direct</option>
                            <option value="Online">Online</option>
                            <option value="Agent Referral">Agent Referral</option>
                            <option value="Vendor">Vendor</option>
                            <option value="Repeat Client">Repeat Client</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <select id="dealStatus" required>
                            <option value="Prospect" selected>Prospect</option>
                            <option value="Quote sent">Quote sent</option>
                            <option value="Info received">Info received</option>
                            <option value="In Credit">In Credit</option>
                            <option value="Approved">Approved</option>
                            <option value="Approval sent">Approval sent</option>
                            <option value="Docs requested">Docs requested</option>
                            <option value="Docs out for signing">Docs out for signing</option>
                            <option value="In funding">In funding</option>
                            <option value="Funded">Funded</option>
                            <option value="Declined">Declined</option>
                            <option value="Dead approval">Dead approval</option>
                            <option value="Withdrawn">Withdrawn</option>
                        </select>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Assign Lender</label>
                        <select id="dealLender">
                            <option value="">None</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>&nbsp;</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddDealModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Deal</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Application Detail Modal -->
<div id="applicationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Application Details</h2>
            <button class="modal-close" onclick="closeApplicationModal()">‚úï</button>
        </div>
        <div class="modal-body" id="applicationModalBody">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeApplicationModal()">Close</button>
        </div>
    </div>
</div>

<!-- Contact Detail Modal -->
<div id="contactModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Contact Details</h2>
            <button class="modal-close" onclick="closeContactModal()">‚úï</button>
        </div>
        <div class="modal-body" id="contactModalBody">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeContactModal()">Close</button>
        </div>
    </div>
</div>

<!-- Add Agent Modal -->
<div id="addAgentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Agent</h2>
            <button class="modal-close" onclick="closeAddAgentModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <form id="addAgentForm" onsubmit="handleAddAgent(event)">
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Full Name <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="agentName" required>
                    </div>
                    <div class="modal-field">
                        <label>Email <span style="color: var(--danger);">*</span></label>
                        <input type="email" id="agentEmail" required>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Phone</label>
                        <input type="text" id="agentPhone">
                    </div>
                    <div class="modal-field">
                        <label>Role</label>
                        <select id="agentRole">
                            <option value="agent">Agent</option>
                        </select>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Business Type</label>
                        <select id="agentBusinessType">
                            <option value="">Select Business Type</option>
                            <option value="Mortgage Agent">Mortgage Agent</option>
                            <option value="Mortgage Broker">Mortgage Broker</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Consulting">Consulting</option>
                            <option value="Accounting">Accounting</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <select id="agentStatus">
                            <option value="">Select Status</option>
                            <option value="AIA">AIA</option>
                            <option value="MOU">MOU</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>
                </div>
                <div class="modal-row full">
                    <div class="modal-field">
                        <label>Referral Slug</label>
                        <input type="text" id="agentSlug" readonly style="background-color: var(--light-gray); cursor: not-allowed;">
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 5px;">Auto-generated from name</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddAgentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Agent</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Lender Modal -->
<div id="addLenderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Lender</h2>
            <button class="modal-close" onclick="closeAddLenderModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <form id="addLenderForm" onsubmit="handleAddLender(event)">
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Name <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="lenderName" required>
                    </div>
                    <div class="modal-field">
                        <label>Lender ID</label>
                        <input type="text" id="lenderId" placeholder="e.g., L-001">
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Type</label>
                        <select id="lenderType">
                            <option value="">Select Type</option>
                            <option value="Lender">Lender</option>
                            <option value="Broker">Broker</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Countries</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="lenderCountries" value="Canada"> Canada
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="lenderCountries" value="United States"> United States
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="lenderCountries" value="UK"> UK
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="lenderCountries" value="Germany"> Germany
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Currency</label>
                        <select id="lenderCurrency">
                            <option value="">Select Currency</option>
                            <option value="CAD">CAD</option>
                            <option value="USD">USD</option>
                            <option value="GBP">GBP</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <select id="lenderStatus">
                            <option value="">Select Status</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div style="border-top: 1px solid var(--border-gray); margin: 20px 0 15px; padding-top: 15px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy);">Primary Contact (optional)</label>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Contact Name</label>
                        <input type="text" id="lenderContactName" class="lenderContact">
                    </div>
                    <div class="modal-field">
                        <label>Contact Email</label>
                        <input type="email" id="lenderContactEmail" class="lenderContact">
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Contact Phone</label>
                        <input type="tel" id="lenderContactPhone" class="lenderContact">
                    </div>
                    <div class="modal-field">
                        <label>Contact Role/Title</label>
                        <input type="text" id="lenderContactRole" class="lenderContact">
                    </div>
                </div>

                <!-- Extra Contacts Container -->
                <div id="lenderExtraContacts"></div>

                <!-- Add Another Contact Button -->
                <div style="margin-top: 15px; text-align: center;">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="addLenderContactField()" style="padding: 6px 12px;">+ Add Another Contact</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddLenderModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Lender</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Vendor Modal -->
<div id="addVendorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>New Vendor</h2>
            <button class="modal-close" onclick="closeAddVendorModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <form id="addVendorForm" onsubmit="handleAddVendor(event)">
                <div class="modal-row">
                    <div class="modal-field full">
                        <label>Name <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="vendorName" required>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Website</label>
                        <input type="url" id="vendorWebsite" placeholder="https://example.com">
                    </div>
                    <div class="modal-field">
                        <label>Countries</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="vendorCountries" value="Canada"> Canada
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="vendorCountries" value="United States"> United States
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="vendorCountries" value="UK"> UK
                            </label>
                            <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                <input type="checkbox" name="vendorCountries" value="Germany"> Germany
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Product Description</label>
                        <input type="text" id="vendorProduct">
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <select id="vendorStatus">
                            <option value="">Select Status</option>
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-gray);">
                    <h3 style="font-size: 14px; font-weight: 600; color: var(--navy); margin-bottom: 15px;">Primary Contact (Optional)</h3>
                    <div class="modal-row">
                        <div class="modal-field">
                            <label>Contact Name</label>
                            <input type="text" id="vendorContactName" class="vendorContact">
                        </div>
                        <div class="modal-field">
                            <label>Contact Email</label>
                            <input type="email" id="vendorContactEmail" class="vendorContact">
                        </div>
                    </div>
                    <div class="modal-row">
                        <div class="modal-field">
                            <label>Contact Phone</label>
                            <input type="text" id="vendorContactPhone" class="vendorContact">
                        </div>
                        <div class="modal-field">
                            <label>Contact Role/Title</label>
                            <input type="text" id="vendorContactRole" class="vendorContact">
                        </div>
                    </div>

                    <!-- Extra Contacts Container -->
                    <div id="vendorExtraContacts"></div>

                    <!-- Add Another Contact Button -->
                    <div style="margin-top: 15px; text-align: center;">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addVendorContactField()" style="padding: 6px 12px;">+ Add Another Contact</button>
                    </div>
                </div>
                <div class="modal-footer" style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddVendorModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Vendor</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- CSV Import Modal -->
<div id="csvImportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Import CSV Data</h2>
            <button class="modal-close" onclick="closeCSVImportModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <form id="csvImportForm" onsubmit="handleCSVImport(event)">
                <div class="modal-row full">
                    <div class="modal-field">
                        <label>Select Target Table <span style="color: var(--danger);">*</span></label>
                        <select id="csvTargetTable" required>
                            <option value="">Choose table...</option>
                            <option value="users">Agents</option>
                            <option value="lenders">Lenders</option>
                            <option value="vendors">Vendors</option>
                            <option value="applications">Applications</option>
                        </select>
                    </div>
                </div>
                <div class="modal-row full">
                    <div class="modal-field">
                        <label>CSV File <span style="color: var(--danger);">*</span></label>
                        <input type="file" id="csvFile" accept=".csv" required>
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 5px;">Upload a CSV file. First row should contain column headers.</small>
                    </div>
                </div>
                <div id="csvPreview" style="display: none; margin-top: 20px;">
                    <h3 style="font-size: 14px; font-weight: 600; color: var(--navy); margin-bottom: 10px;">Preview (First 5 rows)</h3>
                    <div style="overflow-x: auto; max-height: 300px; border: 1px solid var(--border-gray); border-radius: 4px;">
                        <table id="csvPreviewTable" style="font-size: 12px; width: 100%;">
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCSVImportModal()">Cancel</button>
                    <button type="submit" id="csvSubmitBtn" class="btn btn-primary" style="display: none;">Import Data</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Send Application Form Modal -->
<div id="sendApplicationModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>Send Application Form</h2>
            <button class="modal-close" onclick="closeSendApplicationModal()">‚úï</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <p style="color: var(--text-light); font-size: 14px; margin-bottom: 20px;">Select an application form type below. You can copy the link to share directly, or enter a client's email to send it to them.</p>

            <div style="display: grid; gap: 12px; margin-bottom: 20px;">
                <div id="sendAppLeasing" class="send-app-card" onclick="selectSendAppType('leasing')" style="display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid #E2E8F0; border-radius: 8px; cursor: pointer; transition: all .2s;">
                    <span style="font-size: 24px;">üèóÔ∏è</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--navy); font-size: 14px;">Equipment Leasing</div>
                        <div style="font-size: 12px; color: var(--text-light);">Full equipment lease application with principal info</div>
                    </div>
                </div>
                <div id="sendAppMca" class="send-app-card" onclick="selectSendAppType('mca')" style="display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid #E2E8F0; border-radius: 8px; cursor: pointer; transition: all .2s;">
                    <span style="font-size: 24px;">üí∞</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--navy); font-size: 14px;">Merchant Cash Advance</div>
                        <div style="font-size: 12px; color: var(--text-light);">MCA application with revenue, bank statements upload</div>
                    </div>
                </div>
                <div id="sendAppWc" class="send-app-card" onclick="selectSendAppType('wc')" style="display: flex; align-items: center; gap: 12px; padding: 14px; border: 2px solid #E2E8F0; border-radius: 8px; cursor: pointer; transition: all .2s;">
                    <span style="font-size: 24px;">üìä</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--navy); font-size: 14px;">Working Capital & Factoring</div>
                        <div style="font-size: 12px; color: var(--text-light);">Working capital, factoring, term loans, credit lines</div>
                    </div>
                </div>
            </div>

            <div id="sendAppLinkSection" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px;">Application Link:</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="sendAppLinkUrl" readonly style="flex: 1; padding: 8px 10px; border: 1px solid var(--border-gray); border-radius: 4px; font-family: monospace; font-size: 12px; background: #F8FAFC;">
                        <button class="btn btn-gold btn-sm" onclick="copySendAppLink()">Copy Link</button>
                    </div>
                </div>

                <div style="border-top: 1px solid var(--border-gray); padding-top: 15px;">
                    <label style="display: block; font-weight: 600; color: var(--navy); margin-bottom: 6px;">Or email the form to a client:</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <input type="email" id="sendAppClientEmail" placeholder="client@company.com" style="flex: 1; padding: 8px 10px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px;">
                        <input type="text" id="sendAppClientName" placeholder="Client name (optional)" style="flex: 1; padding: 8px 10px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px;">
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="emailSendAppLink()" style="width: 100%;">Open Email to Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Document Upload Modal -->
<div id="documentUploadModal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
        <div class="modal-header">
            <h2>Upload Document</h2>
            <button class="modal-close" onclick="closeDocumentUploadModal()">‚úï</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <div class="modal-field" style="margin-bottom: 15px;">
                <label>Document Type <span style="color: var(--danger);">*</span></label>
                <select id="docTypeSelect" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px;">
                    <option value="">Select Type...</option>
                    <option value="bank_statement">Bank Statement</option>
                    <option value="processing_statement">Processing Statement</option>
                    <option value="photo_id">Photo ID</option>
                    <option value="void_cheque">Void Cheque</option>
                    <option value="business_license">Business License</option>
                    <option value="tax_return">Tax Return</option>
                    <option value="financial_statements">Financial Statements</option>
                    <option value="credit_report">Credit Report</option>
                    <option value="equipment_quote">Equipment Quote / Invoice</option>
                    <option value="ap_ar_aging">AP / AR Aging Report</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="modal-field" style="margin-bottom: 15px;">
                <label>File <span style="color: var(--danger);">*</span></label>
                <input type="file" id="docFileInput" accept=".pdf,.png,.jpg,.jpeg" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px;">
                <small style="color: var(--text-light); font-size: 12px; margin-top: 5px; display: block;">PDF, PNG, JPG ‚Äî max 10MB</small>
            </div>
            <div class="modal-field" style="margin-bottom: 15px;">
                <label>Notes (optional)</label>
                <textarea id="docNotesInput" rows="3" style="width: 100%; padding: 8px 10px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px; resize: vertical;"></textarea>
            </div>
            <div id="docUploadProgress" style="display: none; margin-bottom: 15px;">
                <div style="width: 100%; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                    <div id="docUploadProgressBar" style="width: 0%; height: 100%; background: #10B981; transition: width 0.3s;"></div>
                </div>
                <p id="docUploadProgressText" style="margin-top: 5px; font-size: 12px; color: #666;">Uploading...</p>
            </div>
        </div>
        <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid var(--border-gray); display: flex; gap: 10px; justify-content: flex-end;">
            <button class="btn btn-secondary" onclick="closeDocumentUploadModal()">Cancel</button>
            <button class="btn btn-primary" id="docUploadBtn" onclick="submitDocumentUpload()">Upload Document</button>
        </div>
    </div>
</div>

<!-- Vendor Detail Modal -->
<div id="vendorDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="vendorDetailTitle">Vendor Details</h2>
            <button class="modal-close" onclick="closeVendorDetailModal()">‚úï</button>
        </div>
        <div class="modal-body" id="vendorModalBody">
        </div>
    </div>
</div>

<!-- Lender Detail Modal -->
<div id="lenderDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="lenderDetailTitle">Lender Details</h2>
            <button class="modal-close" onclick="closeLenderDetailModal()">‚úï</button>
        </div>
        <div class="modal-body" id="lenderModalBody">
        </div>
    </div>
</div>

<!-- Agent Detail Modal -->
<div id="agentDetailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="agentDetailTitle">Agent Details</h2>
            <button class="modal-close" onclick="closeAgentDetailModal()">‚úï</button>
        </div>
        <div class="modal-body" id="agentModalBody">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
    // ============================================
    // BERNIE: Paste your Supabase anon key below
    // ============================================
    const SUPABASE_URL = 'https://uernphejrcsicnkobsdw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVlcm5waGVqcmNzaWNua29ic2R3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MzU3ODksImV4cCI6MjA4NjUxMTc4OX0.A2YN3gkaYwR_9nyE3OkWl5Io9tfxe8lTgC913stXmUI';

    // Initialize Supabase client
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    let currentUser = null;
    let currentPage = 'dashboard';
    let allLenders = [];
    let allVendors = [];
    let allDeals = [];
    let cachedLenders = [];
    let cachedVendors = [];
    let cachedAgents = [];
    let cachedVendorContacts = [];  // For salespeople tracking
    let lenderContactCount = 1;
    let vendorContactCount = 1;

    // Role-based access control
    let currentUserRole = 'agent';  // default to most restricted
    let currentUserId = null;       // the user's ID from the users table (NOT auth_id)
    let currentUserName = 'Admin';  // display name from users table

    // ============================================
    // Authentication
    // ============================================

    function showForgotPassword(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('forgotPasswordLink').style.display = 'none';
        document.getElementById('forgotPasswordForm').style.display = 'block';
        document.getElementById('loginError').textContent = '';
    }

    function hideForgotPassword(e) {
        e.preventDefault();
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('forgotPasswordLink').style.display = 'inline';
        document.getElementById('forgotPasswordForm').style.display = 'none';
        document.getElementById('resetMessage').style.display = 'none';
    }

    async function handleForgotPassword() {
        const email = document.getElementById('resetEmail').value;
        const msgEl = document.getElementById('resetMessage');
        if (!email) {
            msgEl.style.display = 'block';
            msgEl.style.background = '#FEE2E2';
            msgEl.style.color = '#DC2626';
            msgEl.textContent = 'Please enter your email address.';
            return;
        }
        try {
            const { error } = await db.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin + '/dashboard.html'
            });
            msgEl.style.display = 'block';
            if (error) {
                msgEl.style.background = '#FEE2E2';
                msgEl.style.color = '#DC2626';
                msgEl.textContent = 'Error: ' + error.message;
            } else {
                msgEl.style.background = '#D1FAE5';
                msgEl.style.color = '#065F46';
                msgEl.textContent = 'Password reset link sent! Check your email.';
            }
        } catch (err) {
            msgEl.style.display = 'block';
            msgEl.style.background = '#FEE2E2';
            msgEl.style.color = '#DC2626';
            msgEl.textContent = 'Something went wrong. Please try again.';
        }
    }

    async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorEl = document.getElementById('loginError');

        try {
            errorEl.textContent = '';
            const { data, error } = await db.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            currentUser = data.user;

            // Get user name and role from database (optional - dashboard works even if this fails)
            let displayName = email;
            let displayRole = 'admin';
            try {
                const { data: userData } = await db
                    .from('users')
                    .select('id, role, full_name')
                    .ilike('email', email)
                    .maybeSingle();
                if (userData) {
                    displayName = userData.full_name || email;
                    displayRole = userData.role || 'admin';
                    currentUserRole = userData.role || 'admin';
                    currentUserId = userData.id;
                    currentUserName = userData.full_name || email;
                }
            } catch (e) {
                console.log('User lookup optional, continuing...', e);
            }

            // Show app
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('userEmailDisplay').textContent = email;
            document.getElementById('currentUser').textContent = `${displayName} (${displayRole})`;

            // Apply role-based access
            applyRoleAccess();

            // Load dashboard
            loadDashboard();
        } catch (error) {
            errorEl.textContent = error.message || 'Login failed';
        }
    }

    async function handleLogout() {
        try {
            await db.auth.signOut();
            currentUser = null;
            currentUserRole = 'agent';
            currentUserId = null;
            // Re-show all nav items in case an admin logs out and agent logs in
            document.querySelectorAll('.nav-item').forEach(item => {
                item.style.display = 'flex';
            });
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginForm').reset();
            document.getElementById('loginError').textContent = '';
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    // ============================================
    // Role-Based Access Control
    // ============================================

    function applyRoleAccess() {
        const isAdmin = ['super_admin', 'admin'].includes(currentUserRole);

        // Hide/show nav items based on role
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            const label = item.querySelector('span:last-child').textContent.trim();
            // Agents can only see Dashboard and Deal Pipeline
            if (!isAdmin) {
                if (['Agents & Partners', 'Lenders', 'Vendors', 'Contact Submissions'].includes(label)) {
                    item.style.display = 'none';
                } else {
                    item.style.display = 'flex';
                }
            } else {
                item.style.display = 'flex';
            }
        });

        // Show all 4 stat cards for both roles (agents get different labels/values set in loadDashboard)
        const card3 = document.getElementById('statCard3');
        const card4 = document.getElementById('statCard4');
        if (card3) card3.style.display = 'block';
        if (card4) card4.style.display = 'block';
    }

    // ============================================
    // Agent Portal: Referral Link & Marketing Hub
    // ============================================

    let agentProfile = null; // stores agent's full profile for marketing templates

    async function displayAgentReferralCard() {
        const isAgent = !['super_admin', 'admin'].includes(currentUserRole) && currentUserId;
        const referralCard = document.getElementById('agentReferralCard');
        const marketingToolkit = document.getElementById('agentMarketingToolkit');
        if (!isAgent) {
            if (referralCard) referralCard.style.display = 'none';
            if (marketingToolkit) marketingToolkit.style.display = 'none';
            return;
        }
        try {
            const { data, error } = await db
                .from('users')
                .select('id, full_name, email, phone, referral_slug')
                .eq('id', currentUserId)
                .single();
            if (error) throw error;
            agentProfile = data;
            if (data && data.referral_slug) {
                const referralUrl = window.location.origin + '/application.html?ref=' + data.referral_slug;
                const landingPageUrl = window.location.origin + '/' + data.referral_slug;
                document.getElementById('agentReferralUrl').value = referralUrl;
                document.getElementById('agentReferralSlug').textContent = data.referral_slug;
                const partnerLink = document.getElementById('agentPartnerLink');
                partnerLink.href = landingPageUrl;
                partnerLink.textContent = 'View your landing page';

                // Populate application form links
                const slug = data.referral_slug;
                const baseUrl = window.location.origin;
                const formLinks = [
                    { name: 'Equipment Leasing', url: baseUrl + '/apply-leasing.html?ref=' + slug, icon: 'üèóÔ∏è', color: '#059669' },
                    { name: 'Merchant Cash Advance', url: baseUrl + '/apply-merchant-advance.html?ref=' + slug, icon: 'üí∞', color: '#D97706' },
                    { name: 'Working Capital & Factoring', url: baseUrl + '/apply-working-capital.html?ref=' + slug, icon: 'üìä', color: '#2563EB' }
                ];
                const linksContainer = document.getElementById('agentAppFormLinks');
                if (linksContainer) {
                    linksContainer.innerHTML = formLinks.map(f => `
                        <div style="background: white; border: 1px solid #E2E8F0; border-radius: 8px; padding: 12px 15px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 20px;">${f.icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 13px; color: #0D1E3D;">${f.name}</div>
                                <a href="${f.url}" target="_blank" style="font-size: 11px; color: ${f.color}; word-break: break-all;">Open Form</a>
                            </div>
                            <button class="btn btn-sm" onclick="navigator.clipboard.writeText('${f.url}');this.textContent='Copied!';this.style.background='#10B981';setTimeout(()=>{this.textContent='Copy';this.style.background=''},2000)" style="padding: 4px 10px; font-size: 11px; background: #E2E8F0; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Copy</button>
                        </div>
                    `).join('');
                }
            }
            referralCard.style.display = 'block';
            if (marketingToolkit) {
                marketingToolkit.style.display = 'block';
                populateMarketingTemplates();
                populateAgentPDFs();
                showEmailTemplate('mortgage');
            }
        } catch (err) {
            console.error('Error loading referral data:', err);
        }
    }

    function copyReferralLink() {
        const urlInput = document.getElementById('agentReferralUrl');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(urlInput.value).then(() => {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#10B981';
            setTimeout(() => { btn.textContent = originalText; btn.style.background = ''; }, 2000);
        }).catch(() => {
            document.execCommand('copy');
        });
    }

    // ============================================
    // Agent Portal: Marketing Toolkit
    // ============================================

    function toggleMarketingToolkit() {
        const body = document.getElementById('marketingToolkitBody');
        const icon = document.getElementById('marketingToggleIcon');
        if (body.style.display === 'none') {
            body.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
        } else {
            body.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
        }
    }

    function getAgentSignature() {
        if (!agentProfile) return '';
        const name = agentProfile.full_name || 'Agent Name';
        const email = agentProfile.email || '';
        const phone = agentProfile.phone || '1-877-660-3660';
        const slug = agentProfile.referral_slug || '';
        const pageUrl = window.location.origin + '/' + slug;
        return name + '\nSenior Technology & Commercial Finance Consultant\nAlliance Financing Group Ltd.\n' + phone + '\n' + email;
    }

    function getAgentLink() {
        if (!agentProfile) return 'alliancefinancing.ai';
        return 'alliancefinancing.ai/' + (agentProfile.referral_slug || '');
    }

    function getAgentAppLink() {
        if (!agentProfile) return '';
        return window.location.origin + '/application.html?ref=' + (agentProfile.referral_slug || '');
    }

    function populateAgentPDFs() {
        const container = document.getElementById('pdfAttachments');
        if (!container || !agentProfile) return;

        const slug = agentProfile.referral_slug || '';
        const btnStyle = 'display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: white; border: 1px solid #CBD5E1; border-radius: 6px; text-decoration: none; color: #0D1E3D; font-size: 13px; font-weight: 500; transition: all 0.2s;';

        // Agent-specific PDF mappings
        const agentPDFs = {
            'paul-morrison': [
                { file: 'pdfs/Alliance_Overview-Pj.pdf', label: 'Alliance Overview' },
                { file: 'pdfs/paul-morrison-mortgage-brokers-a9b08ec8.pdf', label: 'Mortgage Brokers One-Pager' },
                { file: 'pdfs/paul-morrison-insurance-brokers-a626986e.pdf', label: 'Insurance Brokers One-Pager' },
                { file: 'pdfs/paul-morrison-accountants-cfos-164326bd.pdf', label: 'Accountants & CFOs One-Pager' }
            ],
            'lee-harrison': [
                { file: 'pdfs/Alliance_Overview_LH.pdf', label: 'Alliance Overview' },
                { file: 'pdfs/lee-harrison-mortgage-brokers.pdf', label: 'Mortgage Brokers One-Pager' },
                { file: 'pdfs/lee-harrison-insurance-brokers.pdf', label: 'Insurance Brokers One-Pager' },
                { file: 'pdfs/lee-harrison-accountants-cfos.pdf', label: 'Accountants & CFOs One-Pager' }
            ]
        };

        const pdfs = agentPDFs[slug] || [];
        if (pdfs.length === 0) {
            container.innerHTML = '<span style="color: #666; font-size: 13px;">No PDFs available yet. Contact admin to upload your materials.</span>';
            return;
        }

        container.innerHTML = pdfs.map(p =>
            '<a href="' + p.file + '" target="_blank" download style="' + btnStyle + '" ' +
            'onmouseover="this.style.borderColor=\'#C5A572\';this.style.background=\'#FFFBF0\'" ' +
            'onmouseout="this.style.borderColor=\'#CBD5E1\';this.style.background=\'white\'">' +
            'üìÑ ' + p.label + '</a>'
        ).join('');
    }

    function populateMarketingTemplates() {
        const name = agentProfile ? agentProfile.full_name : 'Agent Name';
        const sig = getAgentSignature();
        const link = getAgentLink();

        window.emailTemplates = {
            mortgage: {
                subjects: [
                    'Your mortgage clients need more than a mortgage ‚Äî are you capturing that revenue?',
                    'A referral fee on every equipment or working capital deal your clients close',
                    'The financing deals your clients are doing without you'
                ],
                body: 'Hi [First Name],\n\nAs a Senior Technology & Commercial Finance Consultant, I partner with Alliance Financing Group \u2014 a Canadian commercial finance company with 35+ years in the business and relationships with over 70 lenders across Canada and the US.\n\nHere\u2019s the opportunity: many of your commercial mortgage clients also need equipment financing, working capital, factoring, or merchant advances. Right now those deals are walking out the door to someone else. Alliance lets you refer those clients and earn a fee on every funded deal \u2014 with zero additional licensing required.\n\nWhat your clients get access to:\n\u2022 Equipment leasing & financing ($2,500 \u2013 $10M+)\n\u2022 Working capital, factoring, and accounts receivable financing\n\u2022 Merchant cash advances (funded in 24-48 hours)\n\u2022 Lines of credit, term loans, and SBA/SBL programs\n\nWhat you get:\n\u2022 Referral fees on every funded transaction\n\u2022 A dedicated team that handles the entire process\n\u2022 Your client relationship stays 100% intact\n\nI\u2019ve attached a one-page overview with more detail. If this makes sense for your practice, I\u2019d welcome a quick 10-minute call to walk through how it works.\n\nYou can also see the full product suite and submit applications directly at: ' + link + '\n\nBest regards,\n' + sig
            },
            insurance: {
                subjects: [
                    'You insure the business \u2014 why not finance it too?',
                    'Your clients are buying equipment. Are you getting paid for the referral?',
                    'A new revenue stream from your existing book of business'
                ],
                body: 'Hi [First Name],\n\nI wanted to connect because I think there\u2019s a natural fit between what you do and what I can offer.\n\nAs a commercial insurance agent, you already know when your clients are growing \u2014 they\u2019re adding equipment, expanding locations, buying vehicles, or building out inventory. Every one of those moments is also a financing opportunity.\n\nI\u2019m a Senior Technology & Commercial Finance Consultant working with Alliance Financing Group, a 35-year-old commercial finance company with 70+ lending partners. When you refer a client who needs financing, I handle everything from application to funding \u2014 and you earn a referral fee on every deal that closes.\n\nThink about your recent client interactions:\n\u2022 A client purchasing new equipment that needs to be insured\n\u2022 A business owner mentioning cash flow challenges\n\u2022 A client expanding or opening a new location\n\u2022 A policy renewal conversation that reveals growth plans\n\nEach of these is a referral opportunity. One introduction. That\u2019s all it takes.\n\nProducts available for your clients:\n\u2022 Equipment leasing & financing ($2,500 \u2013 $10M+)\n\u2022 Working capital, factoring, and AR financing\n\u2022 Merchant cash advances (24-48 hour funding)\n\u2022 Sale-leasebacks to unlock capital in owned equipment\n\u2022 Business acquisition financing\n\nI\u2019ve attached a one-pager with more details. Happy to jump on a quick call to explain how the referral process works \u2014 it\u2019s simpler than you\u2019d expect.\n\nDirect link: ' + link + '\n\nBest regards,\n' + sig
            },
            accountants: {
                subjects: [
                    'Your clients ask you about financing \u2014 here\u2019s a better answer',
                    'A referral partnership that makes your advisory practice more valuable',
                    'Capital access for your clients. Revenue for your practice.'
                ],
                body: 'Hi [First Name],\n\nAs an accountant or fractional CFO, you\u2019re often the first person a business owner turns to when they need capital \u2014 whether it\u2019s for growth, equipment, working capital, or restructuring.\n\nThe challenge is that most accounting professionals don\u2019t have a reliable financing partner to refer to. That\u2019s where I come in.\n\nI\u2019m a Senior Technology & Commercial Finance Consultant working with Alliance Financing Group \u2014 35 years in commercial finance, 70+ lending partners, and an AI-powered platform that matches businesses with the right funding source. When you introduce a client, I manage the entire process from application to close \u2014 and you earn a referral fee on every funded deal.\n\nWhere this fits into your practice:\n\u2022 Financial review reveals a client needs working capital or bridge financing\n\u2022 Business planning identifies equipment or expansion capital requirements\n\u2022 Tax planning uncovers lease vs. buy optimization opportunities\n\u2022 A client needs to restructure or consolidate business debt\n\u2022 Your fractional CFO engagement requires sourcing growth capital\n\nThe full product suite includes:\n\u2022 Equipment leasing & financing ($2,500 \u2013 $10M+)\n\u2022 Working capital: factoring, AR financing, inventory financing, term loans\n\u2022 Merchant cash advances for cash-flow-intensive businesses\n\u2022 Lines of credit and revolving operating facilities\n\u2022 Commercial mortgages, SBA/SBL loans, and business acquisition financing\n\nThe process is confidential, professional, and designed to strengthen your client relationship \u2014 not compete with it.\n\nI\u2019ve attached a one-pager for your reference. I\u2019d welcome a 10-minute call to walk you through how the referral partnership works and answer any questions.\n\nDirect link: ' + link + '\n\nBest regards,\n' + sig
            },
            followup: {
                subjects: [
                    'Following up \u2014 quick question'
                ],
                body: 'Hi [First Name],\n\nI sent a note last week about a referral partnership with Alliance Financing Group. I know your inbox is busy, so I\u2019ll keep this short:\n\nIf you have clients who need equipment financing, working capital, or any form of business funding \u2014 I can handle the entire process and you earn a referral fee. No extra work on your end.\n\nWorth a 10-minute call? Happy to work around your schedule.\n\nBest,\n' + sig
            }
        };
    }

    function showEmailTemplate(templateKey) {
        if (!window.emailTemplates || !window.emailTemplates[templateKey]) return;
        const template = window.emailTemplates[templateKey];

        // Update subjects
        const subjectsDiv = document.getElementById('emailSubjects');
        subjectsDiv.innerHTML = template.subjects.map(s => '\u2022 ' + s).join('<br>');

        // Update body
        document.getElementById('emailTemplateBody').value = template.body;

        // Update tab styling
        ['mortgage', 'insurance', 'accountants', 'followup'].forEach(key => {
            const tab = document.getElementById('tab' + key.charAt(0).toUpperCase() + key.slice(1));
            if (tab) {
                if (key === templateKey) {
                    tab.style.background = 'var(--gold)';
                    tab.style.color = 'white';
                    tab.style.fontWeight = '600';
                } else {
                    tab.style.background = '#e2e8f0';
                    tab.style.color = '#334155';
                    tab.style.fontWeight = 'normal';
                }
            }
        });
    }

    function copyEmailTemplate() {
        const textarea = document.getElementById('emailTemplateBody');
        textarea.select();
        textarea.setSelectionRange(0, 999999);
        navigator.clipboard.writeText(textarea.value).then(() => {
            const btn = event.target;
            const orig = btn.textContent;
            btn.textContent = 'Copied!';
            btn.style.background = '#10B981';
            setTimeout(() => { btn.textContent = orig; btn.style.background = ''; }, 2000);
        }).catch(() => {
            document.execCommand('copy');
        });
    }

    // ============================================
    // Agent Portal: Application Submission
    // ============================================

    function openAddApplicationModal() {
        document.getElementById('addApplicationModal').style.display = 'flex';
    }

    function closeAddApplicationModal() {
        document.getElementById('addApplicationModal').style.display = 'none';
        document.getElementById('addApplicationForm').reset();
    }

    async function handleAddApplication(event) {
        event.preventDefault();
        const fullName = document.getElementById('appFullName').value.trim();
        const email = document.getElementById('appEmail').value.trim();
        const phone = document.getElementById('appPhone').value.trim();
        const businessName = document.getElementById('appBusinessName').value.trim();
        const timeInBusiness = document.getElementById('appTimeInBusiness').value;
        const annualRevenue = document.getElementById('appAnnualRevenue').value;
        const fundingAmount = document.getElementById('appFundingAmount').value.trim();
        const description = document.getElementById('appDescription').value.trim();

        const financingTypes = Array.from(document.querySelectorAll('input[name="app_financing_type"]:checked')).map(cb => cb.value);
        if (financingTypes.length === 0) {
            alert('Please select at least one financing type.');
            return;
        }

        const isAgent = !['super_admin', 'admin'].includes(currentUserRole);

        try {
            // Get agent's referral_slug for tracking
            let agentSlug = null;
            if (isAgent && currentUserId) {
                const { data: agentData } = await db.from('users').select('referral_slug').eq('id', currentUserId).single();
                if (agentData) agentSlug = agentData.referral_slug;
            }

            const { data: appData, error: appError } = await db
                .from('applications')
                .insert([{
                    full_name: fullName,
                    email: email,
                    phone: phone,
                    business_name: businessName,
                    time_in_business: timeInBusiness,
                    annual_revenue: annualRevenue,
                    funding_amount_text: fundingAmount,
                    description: description,
                    source_agent_id: isAgent ? currentUserId : null,
                    source_channel: isAgent ? 'Agent' : 'Direct',
                    referral_slug: agentSlug,
                    status: 'Application Received'
                }])
                .select();

            if (appError) throw appError;
            if (!appData || appData.length === 0) throw new Error('Failed to create application');

            const appRecord = appData[0];

            // Insert financing products into junction table
            const productInserts = financingTypes.map(p => ({
                application_id: appRecord.id,
                product: p
            }));
            if (productInserts.length > 0) {
                const { error: prodError } = await db.from('application_products').insert(productInserts);
                if (prodError) console.warn('Product insert warning:', prodError);
            }

            alert('Application created successfully! ID: ' + (appRecord.application_id || appRecord.id));
            closeAddApplicationModal();
            loadDashboard();
        } catch (err) {
            console.error('Error creating application:', err);
            alert('Error creating application: ' + (err.message || 'Unknown error'));
        }
    }

    // ============================================
    // Agent Portal: Commission Tracking
    // ============================================

    let agentDealsCache = [];

    async function loadAgentCommissions() {
        const isAgent = !['super_admin', 'admin'].includes(currentUserRole) && currentUserId;
        const section = document.getElementById('agentCommissionsSection');
        if (!isAgent) {
            if (section) section.style.display = 'none';
            return;
        }
        section.style.display = 'block';

        window.archivedAppIds = [];
        try {
            const { data: agentDeals, error: dealsErr } = await db
                .from('deals')
                .select('*')
                .eq('source_agent_id', currentUserId)
                .order('date_submitted', { ascending: false });

            if (dealsErr) {
                console.error('Agent deals query error:', dealsErr);
                renderAgentDealsTable([]);
                return;
            }

            if (agentDeals) {
                // Filter out archived deals from agent view
                var visibleDeals = agentDeals.filter(function(d) { return !d.is_archived; });
                // Track archived deal application IDs to hide from referral apps
                window.archivedAppIds = agentDeals.filter(function(d) { return d.is_archived && d.application_id; }).map(function(d) { return d.application_id; });
                agentDealsCache = visibleDeals;
                renderAgentDealsTable(visibleDeals);
            } else {
                renderAgentDealsTable([]);
            }
        } catch (err) {
            console.error('Error loading agent deals:', err);
            renderAgentDealsTable([]);
        }
    }

    function renderAgentDealsTable(deals) {
        const tbody = document.getElementById('commissionsBody');
        if (!deals || deals.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No deals yet. Use "+ Add Application" to submit a new deal.</td></tr>';
            return;
        }
        const statusColors = {
            'Prospect': '#6B7280', 'Quote sent': '#3B82F6', 'Info received': '#8B5CF6',
            'In Credit': '#F59E0B', 'Approved': '#10B981', 'Approval sent': '#10B981',
            'Docs requested': '#F59E0B', 'Docs out for signing': '#F59E0B',
            'In funding': '#3B82F6', 'Funded': '#10B981', 'Declined': '#EF4444', 'Dead approval': '#EF4444', 'Withdrawn': '#9F1239'
        };
        const sourceIcons = {
            'Agent': 'üë§', 'Agent Referral': 'üîó', 'Vendor': 'üè¢', 'Online': 'üåê', 'Direct': 'üìû', 'Repeat Client': 'üîÑ'
        };
        tbody.innerHTML = deals.map(d => {
            const isArchived = d.is_archived;
            const st = isArchived ? 'Archived' : (d.status || 'Prospect');
            const color = isArchived ? '#9CA3AF' : (statusColors[d.status] || '#6B7280');
            const src = d.source_channel || d.source || '-';
            const srcIcon = sourceIcons[src] || '';
            return '<tr style="' + (isArchived ? 'opacity:0.5;' : '') + '">' +
                '<td><strong>' + (d.company_name || 'N/A') + '</strong></td>' +
                '<td>' + formatCurrency(d.deal_amount || 0) + '</td>' +
                '<td>' + (d.product_type || '-') + '</td>' +
                '<td><span style="font-size:12px;">' + srcIcon + ' ' + src + '</span></td>' +
                '<td><span style="background:' + color + '20;color:' + color + ';padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500;">' + st + '</span></td>' +
                '<td>' + (d.agent_fee_pct ? d.agent_fee_pct.toFixed(2) + '%' : '-') + '</td>' +
                '<td>' + (d.agent_fee_amount ? formatCurrency(d.agent_fee_amount) : '-') + '</td>' +
                '<td>' + formatDate(d.date_submitted) + '</td>' +
                '<td><button class="btn btn-secondary btn-sm" onclick="viewDeal(\'' + d.id + '\')">View</button></td>' +
                '</tr>';
        }).join('');
    }

    function filterAgentDeals() {
        const term = (document.getElementById('agentDealSearch').value || '').toLowerCase();
        if (!term) { renderAgentDealsTable(agentDealsCache); return; }
        const filtered = agentDealsCache.filter(d =>
            (d.company_name || '').toLowerCase().includes(term) ||
            (d.product_type || '').toLowerCase().includes(term) ||
            (d.status || '').toLowerCase().includes(term) ||
            (d.source || '').toLowerCase().includes(term)
        );
        renderAgentDealsTable(filtered);
    }

    // ============================================
    // Agent Vendor Programs
    // ============================================

    async function loadAgentVendors() {
        const section = document.getElementById('agentVendorProgramsSection');
        if (!section) return;
        section.style.display = 'block';

        try {
            const { data: vendors, error } = await db
                .from('vendors')
                .select('id, name, product_description, country, projected_volume, status')
                .eq('source_agent_id', currentUserId)
                .order('name', { ascending: true });

            if (error) throw error;

            // Fetch salespeople counts for agent's vendors
            const vendorIds = (vendors || []).map(v => v.id);
            let vendorSPCounts = {};
            if (vendorIds.length > 0) {
                const { data: vcData } = await db.from('vendor_contacts').select('id, vendor_id, status').in('vendor_id', vendorIds);
                (vcData || []).forEach(vc => {
                    if (vc.status !== 'Left Company') {
                        vendorSPCounts[vc.vendor_id] = (vendorSPCounts[vc.vendor_id] || 0) + 1;
                    }
                });
            }

            const tbody = document.getElementById('agentVendorsBody');
            if (!vendors || vendors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No vendor programs yet. Submit one above!</td></tr>';
                return;
            }

            tbody.innerHTML = vendors.map(v => `
                <tr>
                    <td><strong>${v.name || 'N/A'}</strong></td>
                    <td>${v.product_description || 'N/A'}</td>
                    <td>${v.country || 'N/A'}</td>
                    <td style="text-align: center;"><span style="background: ${(vendorSPCounts[v.id] || 0) > 0 ? '#EFF6FF' : '#f5f5f5'}; color: ${(vendorSPCounts[v.id] || 0) > 0 ? '#3B82F6' : '#999'}; padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 13px;">${vendorSPCounts[v.id] || 0}</span></td>
                    <td>${v.projected_volume ? formatCurrency(v.projected_volume) : '-'}</td>
                    <td>${getStatusBadge(v.status || 'Pending')}</td>
                    <td><button class="btn btn-secondary btn-sm" onclick="viewAgentVendor('${v.id}')">View</button></td>
                </tr>
            `).join('');
        } catch (err) {
            console.error('Load agent vendors error:', err);
        }
    }

    function openAgentAddVendorModal() {
        document.getElementById('agentAddVendorModal').style.display = 'flex';
    }

    async function handleAgentAddVendor() {
        const name = document.getElementById('agentVendorName').value.trim();
        const product = document.getElementById('agentVendorProduct').value.trim();
        if (!name || !product) { alert('Please fill in the vendor name and product description.'); return; }

        try {
            const { error } = await db.from('vendors').insert({
                name: name,
                website: document.getElementById('agentVendorWebsite').value.trim() || null,
                product_description: product,
                country: document.getElementById('agentVendorCountry').value,
                projected_volume: document.getElementById('agentVendorVolume').value ? parseFloat(document.getElementById('agentVendorVolume').value) : null,
                source_agent_id: currentUserId,
                status: 'Active'
            });

            if (error) throw error;

            document.getElementById('agentAddVendorModal').style.display = 'none';
            // Clear form
            document.getElementById('agentVendorName').value = '';
            document.getElementById('agentVendorWebsite').value = '';
            document.getElementById('agentVendorProduct').value = '';
            document.getElementById('agentVendorVolume').value = '';
            alert('Vendor program submitted successfully!');
            loadAgentVendors();
        } catch (err) {
            console.error('Add vendor error:', err);
            alert('Error submitting vendor: ' + err.message);
        }
    }

    // ============================================
    // Agent Vendor Detail (Salespeople)
    // ============================================

    async function viewAgentVendor(vendorId) {
        try {
            const { data: vendor, error: vErr } = await db.from('vendors').select('*').eq('id', vendorId).single();
            if (vErr) throw vErr;

            const { data: contacts, error: cErr } = await db.from('vendor_contacts').select('*').eq('vendor_id', vendorId).order('contact_name');

            document.getElementById('agentVendorDetailTitle').textContent = vendor.name || 'Vendor Details';

            const contactsHtml = (contacts && contacts.length > 0)
                ? contacts.map(c => {
                    const statusColor = (c.status === 'Left Company') ? 'var(--danger)' : (c.status === 'Inactive') ? 'var(--warning)' : 'var(--success)';
                    const contactStatus = c.status || 'Active';
                    return `
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e2e8f0; ${contactStatus === 'Left Company' ? 'opacity: 0.6;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 600; color: var(--navy);">${c.contact_name || 'N/A'}</span>
                                    <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}; color: white;">${contactStatus}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-light); margin-top: 4px;">
                                    ${c.email ? '<div>Email: <a href="mailto:' + c.email + '">' + c.email + '</a></div>' : ''}
                                    ${c.phone ? '<div>Phone: ' + c.phone + '</div>' : ''}
                                    ${c.role_title ? '<div>Role: ' + c.role_title + '</div>' : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 6px; flex-shrink: 0;">
                                <select onchange="agentUpdateContactStatus('${c.id}', '${vendorId}', this.value)" style="padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 11px; cursor: pointer;">
                                    ${'Active,Inactive,Left Company'.split(',').map(s => '<option value="' + s + '"' + (contactStatus === s ? ' selected' : '') + '>' + s + '</option>').join('')}
                                </select>
                            </div>
                        </div>
                    </div>`;
                }).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No salespeople added yet.</p>';

            document.getElementById('agentVendorDetailBody').innerHTML = `
                <div style="margin-bottom: 15px; padding: 12px; background: #F8FAFC; border-radius: 6px; border: 1px solid #E2E8F0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                        <div><strong>Product:</strong> ${vendor.product_description || 'N/A'}</div>
                        <div><strong>Country:</strong> ${vendor.country || 'N/A'}</div>
                        <div><strong>Website:</strong> ${vendor.website ? '<a href="' + (vendor.website.startsWith('http') ? vendor.website : 'https://' + vendor.website) + '" target="_blank">' + vendor.website + '</a>' : 'N/A'}</div>
                        <div><strong>Status:</strong> ${vendor.status || 'N/A'}</div>
                    </div>
                </div>
                <div style="border-top: 2px solid var(--border-gray); padding-top: 15px; margin-bottom: 10px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy);">Salespeople / Contacts (${(contacts || []).filter(c => c.status !== 'Left Company').length} active)</label>
                </div>
                <div id="agentVendorContactsList">${contactsHtml}</div>
                <div style="background: #f9f9f9; padding: 12px; border-radius: 6px; border: 1px solid var(--border-gray); margin-top: 15px;">
                    <h4 style="font-size: 13px; font-weight: 600; color: var(--navy); margin-bottom: 10px;">Add New Salesperson</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="agentNewContactName" placeholder="Name *" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                        <input type="email" id="agentNewContactEmail" placeholder="Email" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="agentNewContactPhone" placeholder="Phone" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                        <input type="text" id="agentNewContactRole" placeholder="Role/Title" style="padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                    </div>
                    <button class="btn btn-gold btn-sm" onclick="agentAddVendorContact('${vendorId}')" style="margin-top: 10px;">Add Salesperson</button>
                </div>
            `;

            document.getElementById('agentVendorDetailModal').style.display = 'flex';
        } catch (error) {
            console.error('View agent vendor error:', error);
            alert('Error loading vendor details: ' + error.message);
        }
    }

    async function agentAddVendorContact(vendorId) {
        const name = document.getElementById('agentNewContactName').value.trim();
        if (!name) { alert('Please enter the salesperson name.'); return; }

        try {
            const { error } = await db.from('vendor_contacts').insert({
                vendor_id: vendorId,
                contact_name: name,
                email: document.getElementById('agentNewContactEmail').value.trim() || null,
                phone: document.getElementById('agentNewContactPhone').value.trim() || null,
                role_title: document.getElementById('agentNewContactRole').value.trim() || null,
                status: 'Active'
            });
            if (error) throw error;
            await viewAgentVendor(vendorId);
            loadAgentVendors();
        } catch (err) {
            console.error('Add contact error:', err);
            alert('Error adding salesperson: ' + err.message);
        }
    }

    async function agentUpdateContactStatus(contactId, vendorId, newStatus) {
        try {
            const { error } = await db.from('vendor_contacts').update({ status: newStatus }).eq('id', contactId);
            if (error) throw error;
            await viewAgentVendor(vendorId);
            loadAgentVendors();
        } catch (err) {
            console.error('Update contact status error:', err);
            alert('Error updating status: ' + err.message);
        }
    }

    // ============================================
    // Agent Sub-Agents
    // ============================================

    async function loadAgentSubAgents() {
        const section = document.getElementById('agentSubAgentsSection');
        if (!section) return;
        section.style.display = 'block';

        try {
            // Get sub-agents (users with parent_agent_id = current user)
            const { data: subAgents, error } = await db
                .from('users')
                .select('id, full_name, email, phone, agent_status, business_type, referral_slug, created_at')
                .eq('parent_agent_id', currentUserId)
                .eq('role', 'agent');

            if (error) throw error;

            const tbody = document.getElementById('agentSubAgentsBody');
            if (!subAgents || subAgents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No sub-agents yet. Invite one above!</td></tr>';
                return;
            }

            // For each sub-agent, get their deals and overrides
            const rows = [];
            for (const sa of subAgents) {
                const { data: saDeals } = await db
                    .from('deals')
                    .select('id, parent_override_amount')
                    .eq('source_agent_id', sa.id);

                const dealCount = saDeals ? saDeals.length : 0;
                const totalOverride = saDeals
                    ? saDeals.reduce((sum, d) => sum + (parseFloat(d.parent_override_amount) || 0), 0)
                    : 0;

                rows.push(`
                    <tr>
                        <td><strong>${sa.full_name || 'N/A'}</strong></td>
                        <td>${sa.email || 'N/A'}</td>
                        <td>${sa.phone || '-'}</td>
                        <td>${getStatusBadge(sa.agent_status || 'Pending')}</td>
                        <td>${dealCount}</td>
                        <td>${totalOverride > 0 ? formatCurrency(totalOverride) : '-'}</td>
                        <td><button class="btn btn-secondary btn-sm" onclick="viewSubAgent('${sa.id}')">View</button></td>
                    </tr>
                `);
            }

            tbody.innerHTML = rows.join('');
        } catch (err) {
            console.error('Load sub-agents error:', err);
        }
    }

    function openInviteSubAgentModal() {
        document.getElementById('inviteSubAgentModal').style.display = 'flex';
    }

    async function handleInviteSubAgent() {
        const name = document.getElementById('subAgentName').value.trim();
        const email = document.getElementById('subAgentEmail').value.trim();
        if (!name || !email) { alert('Please fill in the name and email.'); return; }

        try {
            // Create a user record for the sub-agent (they'll be set up in Supabase Auth separately by admin)
            const { error } = await db.from('users').insert({
                full_name: name,
                email: email,
                phone: document.getElementById('subAgentPhone').value.trim() || null,
                business_type: document.getElementById('subAgentBusinessType').value || null,
                role: 'agent',
                agent_status: 'Pending',
                parent_agent_id: currentUserId
            });

            if (error) throw error;

            document.getElementById('inviteSubAgentModal').style.display = 'none';
            document.getElementById('subAgentName').value = '';
            document.getElementById('subAgentEmail').value = '';
            document.getElementById('subAgentPhone').value = '';
            document.getElementById('subAgentBusinessType').value = '';
            alert('Sub-agent invited successfully! Admin will complete their account setup.');
            loadAgentSubAgents();
        } catch (err) {
            console.error('Invite sub-agent error:', err);
            alert('Error inviting sub-agent: ' + err.message);
        }
    }

    // ============================================
    // Agent Portal: My Referral Applications
    // ============================================
    async function loadAgentReferralApps() {
        const card = document.getElementById('agentReferralAppsCard');
        const tbody = document.getElementById('agentReferralAppsBody');
        if (!card || !tbody) return;
        if (['super_admin', 'admin'].includes(currentUserRole)) { card.style.display = 'none'; return; }

        try {
            // Get agent's referral slug
            const { data: agent } = await db.from('users').select('referral_slug').eq('id', currentUserId).single();
            if (!agent || !agent.referral_slug) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#999;">No referral slug configured. Contact admin.</td></tr>';
                card.style.display = 'block';
                return;
            }

            // Fetch applications with this referral slug
            const { data: apps, error } = await db
                .from('applications')
                .select('id, application_id, form_type, full_name, business_name, funding_amount_text, funding_amount_requested, status, submitted_at')
                .eq('referral_slug', agent.referral_slug)
                .order('submitted_at', { ascending: false });

            if (error) throw error;

            const formTypeLabels = {
                'leasing': 'Equipment Leasing',
                'merchant-advance': 'Merchant Advance',
                'working-capital': 'Working Capital'
            };

            // Filter out applications whose linked deals are archived
            // First check cached archivedAppIds, then also query deals table for any archived deals linked to these apps
            var appIds = (apps || []).map(function(a) { return a.id; });
            var extraArchivedIds = [];
            if (appIds.length > 0) {
                try {
                    var { data: archivedDeals } = await db.from('deals').select('application_id').eq('is_archived', true).in('application_id', appIds);
                    if (archivedDeals) {
                        extraArchivedIds = archivedDeals.map(function(d) { return d.application_id; });
                    }
                } catch(e) { console.log('Archive check optional:', e); }
            }
            var allArchivedAppIds = (window.archivedAppIds || []).concat(extraArchivedIds);
            var visibleApps = (apps || []).filter(function(a) {
                return !allArchivedAppIds.includes(a.id);
            });

            if (visibleApps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#999;">No applications yet. Share your referral links to get started!</td></tr>';
            } else {
                tbody.innerHTML = visibleApps.map(a => {
                    const formLabel = formTypeLabels[a.form_type] || a.form_type || 'Standard';
                    const amount = a.funding_amount_requested ? formatCurrency(a.funding_amount_requested) : (a.funding_amount_text || 'N/A');
                    const submitted = a.submitted_at ? new Date(a.submitted_at).toLocaleDateString() : 'N/A';
                    return `<tr style="cursor:pointer" onclick="viewApplication('${a.id}')">
                        <td><strong>${a.application_id || 'N/A'}</strong></td>
                        <td><span style="background:#EFF6FF;color:#3B82F6;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600;">${formLabel}</span></td>
                        <td>${a.full_name || 'N/A'}</td>
                        <td>${a.business_name || 'N/A'}</td>
                        <td>${amount}</td>
                        <td>${getStatusBadge(a.status)}</td>
                        <td>${submitted}</td>
                    </tr>`;
                }).join('');
            }

            card.style.display = 'block';
        } catch (err) {
            console.error('Load agent referral apps error:', err);
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#c00;">Error loading applications</td></tr>';
            card.style.display = 'block';
        }
    }

    async function viewSubAgent(subAgentId) {
        try {
            const { data: sa, error } = await db
                .from('users')
                .select('*')
                .eq('id', subAgentId)
                .single();

            if (error) throw error;
            if (!sa) { alert('Sub-agent not found'); return; }

            // Get their deals
            const { data: deals } = await db
                .from('deals')
                .select('id, deal_number, company_name, deal_amount, status, parent_override_amount, date_submitted')
                .eq('source_agent_id', subAgentId)
                .order('date_submitted', { ascending: false });

            const totalDeals = deals ? deals.length : 0;
            const totalOverride = deals ? deals.reduce((s, d) => s + (parseFloat(d.parent_override_amount) || 0), 0) : 0;
            const fundedDeals = deals ? deals.filter(d => d.status === 'Funded') : [];
            const fundedOverride = fundedDeals.reduce((s, d) => s + (parseFloat(d.parent_override_amount) || 0), 0);

            const dealsHtml = deals && deals.length > 0
                ? deals.map(d => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; font-size: 13px;">
                        <span><strong>${d.deal_number || d.company_name || 'N/A'}</strong> ‚Äî ${d.company_name || ''}</span>
                        <span>${getStatusBadge(d.status)} ${d.deal_amount ? formatCurrency(d.deal_amount) : ''} ${d.parent_override_amount ? '<span style="color: var(--gold); font-weight: 600;">(Override: ' + formatCurrency(d.parent_override_amount) + ')</span>' : ''}</span>
                    </div>
                `).join('')
                : '<p style="color: #94a3b8; font-size: 14px;">No deals yet.</p>';

            document.getElementById('subAgentDetailTitle').textContent = sa.full_name || 'Sub-Agent Details';
            document.getElementById('subAgentModalBody').innerHTML = `
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Full Name</label>
                        <div class="modal-field-value">${sa.full_name || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Email</label>
                        <div class="modal-field-value"><a href="mailto:${sa.email}">${sa.email || 'N/A'}</a></div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Phone</label>
                        <div class="modal-field-value">${sa.phone || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Business Type</label>
                        <div class="modal-field-value">${sa.business_type || 'N/A'}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Status</label>
                        <div class="modal-field-value">${getStatusBadge(sa.agent_status || 'Pending')}</div>
                    </div>
                    <div class="modal-field">
                        <label>Referral Slug</label>
                        <div class="modal-field-value" style="font-family: monospace;">${sa.referral_slug || 'Not set'}</div>
                    </div>
                </div>

                <!-- Override Summary -->
                <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border: 1px solid #bbf7d0; border-radius: 8px;">
                    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                        <div>
                            <div style="font-size: 12px; color: #64748b;">Total Deals</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--navy);">${totalDeals}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b;">Your Total Override</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--gold);">${formatCurrency(totalOverride)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b;">Funded Override</div>
                            <div style="font-size: 20px; font-weight: 700; color: #16a34a;">${formatCurrency(fundedOverride)}</div>
                        </div>
                    </div>
                </div>

                <div style="border-top: 2px solid #e2e8f0; margin: 20px 0 15px; padding-top: 15px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy);">Their Deals (${totalDeals})</label>
                </div>
                <div style="max-height: 300px; overflow-y: auto;">${dealsHtml}</div>
            `;

            document.getElementById('viewSubAgentModal').style.display = 'flex';
        } catch (err) {
            console.error('View sub-agent error:', err);
            alert('Error loading sub-agent details');
        }
    }

    // ============================================
    // Navigation
    // ============================================

    function showPage(pageName) {
        // Hide all pages
        document.querySelectorAll('.page-section').forEach(el => {
            el.classList.remove('active');
        });

        // Hide all nav items active state
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.remove('active');
        });

        // Show selected page
        document.getElementById(pageName).classList.add('active');

        // Update nav item
        event.target.closest('.nav-item').classList.add('active');

        // Update header title
        const titles = {
            'dashboard': 'Dashboard',
            'deals': 'Deal Pipeline',
            'agents': 'Agents & Partners',
            'lenders': 'Lenders',
            'vendors': 'Vendors',
            'contacts': 'Contact Submissions'
        };
        document.getElementById('pageTitle').textContent = titles[pageName] || 'Dashboard';
        currentPage = pageName;

        // Load page data
        loadPageData(pageName);
    }

    // ============================================
    // Data Loading
    // ============================================

    async function loadDashboard() {
        try {
            // Load applications with role-based filtering
            let appQuery = db.from('applications').select('*').order('submitted_at', { ascending: false });
            if (!['super_admin', 'admin'].includes(currentUserRole) && currentUserId) {
                appQuery = appQuery.eq('source_agent_id', currentUserId);
            }
            const { data: allApps, error: appError } = await appQuery;

            const applications = allApps || [];

            // Load lenders
            const { data: lenders, error: lendersError } = await db
                .from('lenders')
                .select('id, name');

            // Load vendors
            const { data: vendors, error: vendorsError } = await db
                .from('vendors')
                .select('id');

            // Load vendor contacts
            const { data: vendorContacts, error: vendorContactsError } = await db
                .from('vendor_contacts')
                .select('id');

            // Calculate deals received this month
            if (!appError && applications.length >= 0) {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const dealsThisMonth = applications
                    .filter(app => {
                        if (!app.submitted_at) return false;
                        const submittedDate = new Date(app.submitted_at);
                        return submittedDate.getMonth() === currentMonth && submittedDate.getFullYear() === currentYear;
                    })
                    .length;
                document.getElementById('dealsThisMonth').textContent = dealsThisMonth;

                // Set month label
                const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                document.getElementById('dealsMonthLabel').textContent = monthName;
            }

            // Calculate pipeline value (active deals) with role-based filtering
            let dealsQuery = db.from('deals').select('deal_amount, currency, status');
            if (!['super_admin', 'admin'].includes(currentUserRole) && currentUserId) {
                dealsQuery = dealsQuery.eq('source_agent_id', currentUserId);
            }
            const { data: deals, error: dealsError } = await dealsQuery;

            if (!dealsError && deals) {
                const activeDealStatuses = ['Prospect', 'Quote sent', 'Info received', 'In Credit', 'Approved', 'Approval sent', 'Docs requested', 'Docs out for signing', 'In funding'];
                const activeDealValue = deals
                    .filter(d => activeDealStatuses.includes(d.status))
                    .reduce((sum, d) => sum + (d.deal_amount || 0), 0);
                document.getElementById('pipelineValue').textContent = formatCurrency(activeDealValue);
            }

            // Set lender count
            if (!lendersError && lenders) {
                document.getElementById('totalLenders').textContent = lenders.length;
            }

            // Set vendor count and contacts
            if (!vendorsError && vendors) {
                document.getElementById('totalVendors').textContent = vendors.length;
            }
            if (!vendorContactsError && vendorContacts) {
                document.getElementById('vendorSalesPeople').textContent = vendorContacts.length + ' sales contacts';
            }

            // Load recent applications for intake table - only show ones NOT moved to pipeline
            if (!appError) {
                const recentApps = applications.filter(app => app.status !== 'Moved to Pipeline').slice(0, 15);
                const tbody = document.getElementById('recentAppBody');
                const isAdmin = ['super_admin', 'admin'].includes(currentUserRole);

                tbody.innerHTML = recentApps.map(app => {
                    const moveButtonHtml = (isAdmin && app.status !== 'Moved to Pipeline')
                        ? `<button class="btn btn-gold btn-sm" onclick="moveToPipeline('${app.id}')">Move to Pipeline</button>`
                        : '';

                    // For agents, show status as badge instead of dropdown
                    const statusHtml = isAdmin
                        ? `<select class="status-dropdown" onchange="updateAppStatus('${app.id}', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; cursor: pointer;">
                            <option value="Application Received" ${app.status === 'Application Received' ? 'selected' : ''}>Application Received</option>
                            <option value="Under Review" ${app.status === 'Under Review' ? 'selected' : ''}>Under Review</option>
                            <option value="Info Requested" ${app.status === 'Info Requested' ? 'selected' : ''}>Info Requested</option>
                            <option value="Moved to Pipeline" ${app.status === 'Moved to Pipeline' ? 'selected' : ''}>Moved to Pipeline</option>
                            <option value="Declined" ${app.status === 'Declined' ? 'selected' : ''}>Declined</option>
                        </select>`
                        : `<span style="padding: 5px 8px; border-radius: 4px; background: #F3F4F6; font-size: 13px;">${app.status}</span>`;

                    return `
                        <tr>
                            <td><strong>${app.application_id || 'N/A'}</strong></td>
                            <td>${app.full_name || 'N/A'}</td>
                            <td>${app.business_name || 'N/A'}</td>
                            <td>${app.funding_amount_requested ? formatCurrency(app.funding_amount_requested) : (app.funding_amount_text || 'N/A')}</td>
                            <td>${app.source_channel || 'Online'}</td>
                            <td>${statusHtml}</td>
                            <td>${formatDate(app.submitted_at)}</td>
                            <td>${moveButtonHtml}</td>
                        </tr>
                    `;
                }).join('');
            }

            // === Agent Portal Features ===
            const isAgentUser = !['super_admin', 'admin'].includes(currentUserRole) && currentUserId;

            if (isAgentUser) {
                // ---- Agent-specific stat cards ----
                const { data: agentDeals, error: adErr } = await db
                    .from('deals')
                    .select('*')
                    .eq('source_agent_id', currentUserId);

                if (adErr) console.warn('Agent deals query error:', adErr);

                // Also get override earnings from sub-agent deals (where this agent is the parent)
                let subAgentDeals = [];
                try {
                    const { data: sad } = await db
                        .from('deals')
                        .select('id, status, parent_override_amount')
                        .not('sub_agent_id', 'is', null);
                    // Filter to deals where the sub-agent's parent is this user
                    // For now, get all deals with a sub_agent and check parent_override
                    subAgentDeals = sad || [];
                } catch(e) { console.warn('Sub-agent deals query skipped:', e); }

                // NOTE: parent_override_amount on sub-agent deals is what goes to the parent (this user)

                const ad = agentDeals || [];
                const sad = subAgentDeals || [];
                const fundedDeals = ad.filter(d => d.status === 'Funded');
                const activeDeals = ad.filter(d => d.status !== 'Funded' && d.status !== 'Declined' && d.status !== 'Dead approval');
                const projectedFees = activeDeals.reduce((s, d) => s + (d.agent_fee_amount || 0), 0);
                const closedFees = fundedDeals.reduce((s, d) => s + (d.agent_fee_amount || 0), 0);
                const fundedVolume = fundedDeals.reduce((s, d) => s + (d.deal_amount || 0), 0);

                // Add override earnings from sub-agent deals
                const overrideEarnings = sad.reduce((s, d) => s + (parseFloat(d.parent_override_amount) || 0), 0);
                const fundedOverrides = sad.filter(d => d.status === 'Funded').reduce((s, d) => s + (parseFloat(d.parent_override_amount) || 0), 0);

                // Relabel and populate agent stat cards
                const c1 = document.getElementById('statCard1');
                const c2 = document.getElementById('statCard2');
                const c3 = document.getElementById('statCard3');
                const c4 = document.getElementById('statCard4');
                // Get sub-agent and vendor counts for this agent
                let subAgentCount = 0;
                let vendorProgramCount = 0;
                try {
                    const { data: mySubAgents } = await db.from('users').select('id').eq('parent_agent_id', currentUserId).eq('role', 'agent');
                    subAgentCount = mySubAgents ? mySubAgents.length : 0;
                } catch(e) {}
                try {
                    const { data: myVendors } = await db.from('vendors').select('id').eq('source_agent_id', currentUserId);
                    vendorProgramCount = myVendors ? myVendors.length : 0;
                } catch(e) {}

                if (c1) { c1.querySelector('.stat-label').textContent = 'Total Deals'; c1.querySelector('.stat-value').textContent = ad.length; c1.querySelector('.stat-detail').textContent = sad.length > 0 ? '+ ' + sad.length + ' sub-agent deals' : 'All your deals'; }
                if (c2) { c2.querySelector('.stat-label').textContent = 'Projected Fees'; c2.querySelector('.stat-value').textContent = formatCurrency(projectedFees + overrideEarnings); c2.querySelector('.stat-detail').textContent = overrideEarnings > 0 ? 'Incl. ' + formatCurrency(overrideEarnings) + ' overrides' : 'Active deals'; }
                if (c3) { c3.querySelector('.stat-label').textContent = 'Closed Fees'; c3.querySelector('.stat-value').textContent = formatCurrency(closedFees + fundedOverrides); c3.querySelector('.stat-detail').textContent = fundedOverrides > 0 ? 'Incl. ' + formatCurrency(fundedOverrides) + ' overrides' : 'Funded deals'; }
                if (c4) { c4.querySelector('.stat-label').textContent = 'Your Network'; c4.querySelector('.stat-value').textContent = subAgentCount + vendorProgramCount; c4.querySelector('.stat-detail').textContent = subAgentCount + ' sub-agents, ' + vendorProgramCount + ' vendor programs'; }

                // Hide the Recent Applications table for agents
                const appTableContainer = document.getElementById('recentApplicationsTable');
                if (appTableContainer && appTableContainer.closest('.table-container')) {
                    appTableContainer.closest('.table-container').style.display = 'none';
                }
            }

            // Show/hide agent referral card
            await displayAgentReferralCard();

            // Load agent sections
            await loadAgentCommissions();
            await loadAgentVendors();
            await loadAgentSubAgents();
            await loadAgentReferralApps();

        } catch (error) {
            console.error('Dashboard load error:', error);
        }
    }

    async function loadDeals() {
        try {
            // Load lenders cache if needed
            if (cachedLenders.length === 0) {
                const { data: lenderList } = await db
                    .from('lenders')
                    .select('id, name')
                    .order('name');
                cachedLenders = lenderList || [];
            }

            // Fetch deals with role-based filtering
            let dealsQuery = db
                .from('deals')
                .select('*, applications(application_id, full_name), lenders(name)')
                .order('date_submitted', { ascending: false });

            if (!['super_admin', 'admin'].includes(currentUserRole) && currentUserId) {
                dealsQuery = dealsQuery.eq('source_agent_id', currentUserId);
            }

            const { data, error } = await dealsQuery;

            if (error) throw error;

            allDeals = data || [];
            updateDealTabCounts();
            filterDeals();
        } catch (error) {
            console.error('Load deals error:', error);
        }
    }

    // Status color map for badges
    var dealStatusColors = {
        'Prospect': { bg: '#EFF6FF', text: '#1D4ED8', border: '#93C5FD' },
        'Quote sent': { bg: '#F0F9FF', text: '#0369A1', border: '#7DD3FC' },
        'Info received': { bg: '#ECFDF5', text: '#047857', border: '#6EE7B7' },
        'In Credit': { bg: '#FFFBEB', text: '#B45309', border: '#FCD34D' },
        'Approved': { bg: '#F0FDF4', text: '#15803D', border: '#86EFAC' },
        'Approval sent': { bg: '#F0FDF4', text: '#166534', border: '#4ADE80' },
        'Docs requested': { bg: '#FFF7ED', text: '#C2410C', border: '#FDBA74' },
        'Docs out for signing': { bg: '#FEF3C7', text: '#92400E', border: '#FCD34D' },
        'In funding': { bg: '#EDE9FE', text: '#6D28D9', border: '#C4B5FD' },
        'Funded': { bg: '#DCFCE7', text: '#14532D', border: '#22C55E' },
        'Declined': { bg: '#FEF2F2', text: '#991B1B', border: '#FCA5A5' },
        'Dead approval': { bg: '#F1F5F9', text: '#475569', border: '#94A3B8' },
        'Withdrawn': { bg: '#FFF1F2', text: '#9F1239', border: '#FDA4AF' }
    };

    function getStatusBadge(status) {
        var colors = dealStatusColors[status] || { bg: '#F1F5F9', text: '#475569', border: '#94A3B8' };
        return '<span style="display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px;font-weight:600;background:' + colors.bg + ';color:' + colors.text + ';border:1px solid ' + colors.border + ';white-space:nowrap;">' + (status || 'N/A') + '</span>';
    }

    // Deal tab categories
    var activeDealStatuses = ['Prospect', 'Quote sent', 'Info received', 'In Credit', 'Approved', 'Approval sent', 'Docs requested', 'Docs out for signing', 'In funding'];
    var bookedDealStatuses = ['Funded'];
    var deadDealStatuses = ['Declined', 'Dead approval', 'Withdrawn'];
    var currentDealTab = 'active';

    function switchDealTab(tab) {
        currentDealTab = tab;
        // Update tab button styles
        document.querySelectorAll('#dealTabs .deal-tab').forEach(function(btn) {
            if (btn.dataset.tab === tab) {
                btn.style.background = 'var(--navy)';
                btn.style.color = 'white';
                btn.style.fontWeight = '600';
            } else {
                btn.style.background = '#f8fafc';
                btn.style.color = '#333';
                btn.style.fontWeight = '500';
            }
        });
        filterDeals();
    }

    function updateDealTabCounts() {
        var active = 0, booked = 0, dead = 0, archived = 0;
        (allDeals || []).forEach(function(d) {
            if (d.is_archived) { archived++; }
            else if (bookedDealStatuses.includes(d.status)) { booked++; }
            else if (deadDealStatuses.includes(d.status)) { dead++; }
            else { active++; }
        });
        var elA = document.getElementById('dealCountActive'); if (elA) elA.textContent = active;
        var elB = document.getElementById('dealCountBooked'); if (elB) elB.textContent = booked;
        var elD = document.getElementById('dealCountDead'); if (elD) elD.textContent = dead;
        var elAr = document.getElementById('dealCountArchived'); if (elAr) elAr.textContent = archived;
    }

    // Status priority for sorting within Active tab
    var statusPriority = {
        'In funding': 1, 'Docs out for signing': 2, 'Docs requested': 3,
        'Approval sent': 4, 'Approved': 5, 'In Credit': 6,
        'Info received': 7, 'Quote sent': 8, 'Prospect': 9,
        'Funded': 10, 'Declined': 11, 'Dead approval': 12, 'Withdrawn': 13
    };

    function renderDealsTable(data) {
        const tbody = document.getElementById('dealsBody');
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="empty-state">No deals found in this view.</td></tr>';
            return;
        }

        const isAdmin = ['super_admin', 'admin'].includes(currentUserRole);

        // Sort by status priority then date
        data.sort(function(a, b) {
            var pa = statusPriority[a.status] || 99;
            var pb = statusPriority[b.status] || 99;
            if (pa !== pb) return pa - pb;
            return new Date(b.date_submitted || 0) - new Date(a.date_submitted || 0);
        });

        tbody.innerHTML = data.map(deal => {
            const afNumber = deal.applications?.application_id || deal.deal_number || 'N/A';
            const afgNumber = deal.afg_number || '';
            const company = deal.company_name || 'N/A';
            const amount = formatCurrency(deal.deal_amount || 0) + ' ' + (deal.currency || 'USD');
            const lenderName = deal.lenders?.name || '';
            const isArchived = deal.is_archived;

            // Product column - read-only for agents
            const productHtml = isAdmin
                ? `<select class="pipeline-select" onchange="updateDealField('${deal.id}', 'product_type', this.value)" style="padding:5px 10px;border-radius:4px;border:1px solid #d1d5db;font-size:13px;cursor:pointer;min-width:140px;background:#fff;color:#1f2937;font-weight:500;appearance:auto;">
                    ${['Equipment Leasing','MCA','CSBFL','SRED','Private Debt','Factoring','Merchant Advance','Commercial Mortgage','SBA','Loans','Trade Finance','Working Capital Loan','Business Line of Credit','Startup Financing','Franchise Financing','Other'].map(pt => `<option value="${pt}" ${deal.product_type === pt ? 'selected' : ''}>${pt}</option>`).join('')}
                </select>`
                : `<span style="font-size:13px;font-weight:500;color:#1f2937;">${deal.product_type || 'N/A'}</span>`;

            // Source column - read-only for agents
            const sourceHtml = isAdmin
                ? `<select class="pipeline-select" onchange="updateDealField('${deal.id}', 'source', this.value)" style="padding:5px 10px;border-radius:4px;border:1px solid #d1d5db;font-size:13px;cursor:pointer;min-width:120px;background:#fff;color:#1f2937;font-weight:500;appearance:auto;">
                    <option value="Online" ${deal.source === 'Online' ? 'selected' : ''}>Online</option>
                    <option value="Agent Referral" ${deal.source === 'Agent Referral' ? 'selected' : ''}>Agent Referral</option>
                    <option value="Direct" ${deal.source === 'Direct' ? 'selected' : ''}>Direct</option>
                    <option value="Vendor" ${deal.source === 'Vendor' ? 'selected' : ''}>Vendor</option>
                    <option value="Repeat Client" ${deal.source === 'Repeat Client' ? 'selected' : ''}>Repeat Client</option>
                </select>`
                : `<span style="font-size:13px;font-weight:500;color:#1f2937;">${deal.source || 'N/A'}</span>`;

            // Lender column - read-only for agents
            const lenderHtml = isAdmin
                ? `<select class="pipeline-select" onchange="updateDealField('${deal.id}', 'assigned_lender_id', this.value)" style="padding:5px 10px;border-radius:4px;border:1px solid #d1d5db;font-size:13px;cursor:pointer;min-width:130px;background:#fff;color:#1f2937;font-weight:500;appearance:auto;">
                    <option value="">Select Lender</option>
                    ${cachedLenders.map(lender => `<option value="${lender.id}" ${deal.assigned_lender_id === lender.id ? 'selected' : ''}>${lender.name}</option>`).join('')}
                </select>`
                : `<span style="font-size:13px;font-weight:500;color:#1f2937;">${lenderName || 'N/A'}</span>`;

            // Archive button for admins
            const archiveBtn = isAdmin
                ? (isArchived
                    ? `<button class="btn btn-sm" onclick="toggleArchiveDeal('${deal.id}', false)" style="padding:3px 8px;font-size:11px;background:#f0fdf4;color:#166534;border:1px solid #86efac;border-radius:3px;cursor:pointer;" title="Unarchive">Restore</button>`
                    : `<button class="btn btn-sm" onclick="toggleArchiveDeal('${deal.id}', true)" style="padding:3px 8px;font-size:11px;background:#f8fafc;color:#64748b;border:1px solid #cbd5e1;border-radius:3px;cursor:pointer;" title="Archive this deal">Archive</button>`)
                : '';

            return `
                <tr style="${isArchived ? 'opacity:0.6;' : ''}">
                    <td><strong>${afNumber}</strong></td>
                    <td style="font-size:12px;color:#6D28D9;font-weight:600;">${afgNumber ? afgNumber : '<span style="color:#ccc;font-weight:400;">‚Äî</span>'}</td>
                    <td>${company}</td>
                    <td>${amount}</td>
                    <td>${productHtml}</td>
                    <td>${sourceHtml}</td>
                    <td>${lenderHtml}</td>
                    <td>${isAdmin ? `<select class="pipeline-select" onchange="updateDealField('${deal.id}', 'status', this.value)" style="padding:5px 10px;border-radius:4px;border:1px solid #d1d5db;font-size:13px;cursor:pointer;min-width:130px;background:#fff;color:#1f2937;font-weight:500;appearance:auto;">${getDealStatusOptions(deal.status)}</select>` : getStatusBadge(deal.status)}</td>
                    <td>${formatDate(deal.date_submitted)}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn btn-secondary btn-sm" onclick="viewDeal('${deal.id}')">View</button>
                        ${archiveBtn}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function filterDeals() {
        const searchTerm = document.getElementById('dealSearch')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('dealStatusFilter')?.value || '';
        const sourceFilter = document.getElementById('dealSourceFilter')?.value || '';
        const productFilter = document.getElementById('dealProductFilter')?.value || '';

        const filtered = allDeals.filter(deal => {
            // Tab filter first
            var isArchived = deal.is_archived;
            if (currentDealTab === 'archived') {
                if (!isArchived) return false;
            } else if (currentDealTab === 'booked') {
                if (isArchived || !bookedDealStatuses.includes(deal.status)) return false;
            } else if (currentDealTab === 'dead') {
                if (isArchived || !deadDealStatuses.includes(deal.status)) return false;
            } else { // active
                if (isArchived || bookedDealStatuses.includes(deal.status) || deadDealStatuses.includes(deal.status)) return false;
            }

            const afNumber = (deal.applications?.application_id || deal.deal_number || '').toLowerCase();
            const afgNumber = (deal.afg_number || '').toLowerCase();
            const company = (deal.company_name || '').toLowerCase();
            const product = (deal.product_type || '').toLowerCase();
            const source = (deal.source || '').toLowerCase();
            const lenderName = (deal.lenders?.name || '').toLowerCase();

            const matchesSearch = !searchTerm ||
                afNumber.includes(searchTerm) ||
                afgNumber.includes(searchTerm) ||
                company.includes(searchTerm) ||
                product.includes(searchTerm) ||
                source.includes(searchTerm) ||
                lenderName.includes(searchTerm);

            const matchesStatus = !statusFilter || deal.status === statusFilter;
            const matchesSource = !sourceFilter || deal.source === sourceFilter;
            const matchesProduct = !productFilter || deal.product_type === productFilter;

            return matchesSearch && matchesStatus && matchesSource && matchesProduct;
        });

        renderDealsTable(filtered);
    }

    async function toggleArchiveDeal(dealId, archive) {
        var action = archive ? 'archive' : 'restore';
        if (!confirm('Are you sure you want to ' + action + ' this deal?')) return;
        try {
            const { error } = await db.from('deals').update({ is_archived: archive }).eq('id', dealId);
            if (error) throw error;
            // Update local cache
            var deal = allDeals.find(d => d.id === dealId);
            if (deal) deal.is_archived = archive;
            updateDealTabCounts();
            filterDeals();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    async function moveToPipeline(applicationId) {
        try {
            // Fetch the application
            const { data: application, error: appError } = await db
                .from('applications')
                .select('*, application_products(product)')
                .eq('id', applicationId)
                .single();

            if (appError) throw appError;
            if (!application) {
                alert('Application not found');
                return;
            }

            // Determine product type from application_products or default
            let productType = 'Other';
            if (application.application_products && application.application_products.length > 0) {
                productType = application.application_products[0].product || 'Other';
            }

            // Create new deal
            const { data: newDeal, error: dealError } = await db
                .from('deals')
                .insert({
                    company_name: application.business_name,
                    deal_amount: application.funding_amount_requested,
                    application_id: application.id,
                    source: application.source_channel || 'Online',
                    source_agent_id: application.source_agent_id || null,
                    product_type: productType,
                    date_submitted: new Date().toISOString(),
                    status: 'Prospect'
                })
                .select()
                .single();

            if (dealError) throw dealError;

            // Update application status
            const { error: updateError } = await db
                .from('applications')
                .update({ status: 'Moved to Pipeline' })
                .eq('id', applicationId);

            if (updateError) throw updateError;

            // Link any application documents to the new deal
            if (newDeal && newDeal.id) {
                const { error: docLinkError } = await db
                    .from('documents')
                    .update({ deal_id: newDeal.id })
                    .eq('application_id', applicationId);
                if (docLinkError) console.warn('Could not link documents to deal:', docLinkError);
            }

            // Refresh dashboard and deals
            await loadDashboard();
            await loadDeals();

            alert('Application moved to pipeline successfully!');
        } catch (error) {
            console.error('Move to pipeline error:', error);
            alert('Error moving application to pipeline: ' + error.message);
        }
    }

    async function updateDealField(dealId, field, value) {
        try {
            const { error } = await db
                .from('deals')
                .update({ [field]: value || null })
                .eq('id', dealId);

            if (error) throw error;

            // Refresh the deals table
            await loadDeals();
        } catch (error) {
            console.error('Update deal field error:', error);
            alert('Error updating deal: ' + error.message);
        }
    }

    async function updateAppStatus(appId, newStatus) {
        try {
            const { error } = await db
                .from('applications')
                .update({ status: newStatus })
                .eq('id', appId);

            if (error) throw error;

            await loadDashboard();
        } catch (error) {
            console.error('Update app status error:', error);
            alert('Error updating status: ' + error.message);
        }
    }

    async function loadAgents() {
        try {
            const { data, error } = await db
                .from('users')
                .select('*')
                .eq('role', 'agent')
                .order('full_name', { ascending: true });

            if (error) throw error;

            const tbody = document.getElementById('agentsBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No agents found.</td></tr>';
                return;
            }

            // Build lookup for parent agent names
            const agentLookup = {};
            data.forEach(a => { agentLookup[a.id] = a.full_name || a.email || 'Unknown'; });

            tbody.innerHTML = data.map(agent => {
                const parentName = agent.parent_agent_id ? (agentLookup[agent.parent_agent_id] || 'Unknown') : '-';
                return `
                <tr>
                    <td><strong>${agent.full_name || 'N/A'}</strong></td>
                    <td>${agent.email || 'N/A'}</td>
                    <td>${agent.phone || 'N/A'}</td>
                    <td>${parentName}</td>
                    <td>
                        <select onchange="updateAgentStatus('${agent.id}', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 13px; cursor: pointer;">
                            ${'AIA,MOU,Active,Inactive,Pending'.split(',').map(s => `<option value="${s}" ${(agent.agent_status || '') === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                    <td>${agent.referral_slug || 'N/A'}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewAgent('${agent.id}')">View</button>
                    </td>
                </tr>
            `}).join('');
        } catch (error) {
            console.error('Load agents error:', error);
        }
    }

    async function loadLenders() {
        try {
            const { data, error } = await db
                .from('lenders')
                .select('*')
                .order('name', { ascending: true });

            if (error) throw error;

            allLenders = data || [];
            renderLendersTable(allLenders);
        } catch (error) {
            console.error('Load lenders error:', error);
        }
    }

    function renderLendersTable(data) {
        const tbody = document.getElementById('lendersBody');
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No lenders found.</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(lender => `
            <tr>
                <td><strong>${lender.lender_id || 'N/A'}</strong></td>
                <td>${lender.name || 'N/A'}</td>
                <td>${lender.lender_type || 'N/A'}</td>
                <td>${lender.country || 'N/A'}</td>
                <td>${lender.currency || 'N/A'}</td>
                <td>
                    <select onchange="updateLenderStatus('${lender.id}', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                        ${'Active,Inactive'.split(',').map(s => `<option value="${s}" ${(lender.status || '') === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <button class="btn btn-secondary btn-sm" onclick="viewLender('${lender.id}')">View</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadVendors() {
        try {
            // Ensure agents are cached for source agent lookup
            if (cachedAgents.length === 0) {
                const { data: agts } = await db.from('users').select('id, full_name').eq('role', 'agent');
                cachedAgents = agts || [];
            }
            // Fetch all vendor contacts for salespeople counts
            const { data: vcData } = await db.from('vendor_contacts').select('id, vendor_id, contact_name, status');
            cachedVendorContacts = vcData || [];

            const { data, error } = await db
                .from('vendors')
                .select('*')
                .order('name', { ascending: true });

            if (error) throw error;

            allVendors = data || [];
            renderVendorsTable(allVendors);
        } catch (error) {
            console.error('Load vendors error:', error);
        }
    }

    function renderVendorsTable(data) {
        const tbody = document.getElementById('vendorsBody');
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="empty-state">No vendors found.</td></tr>';
            return;
        }

        tbody.innerHTML = data.map(vendor => {
            let websiteUrl = vendor.website || '#';
            if (websiteUrl !== '#' && !websiteUrl.startsWith('http://') && !websiteUrl.startsWith('https://')) {
                websiteUrl = 'https://' + websiteUrl;
            }
            const agentName = vendor.source_agent_id && cachedAgents.length > 0
                ? (cachedAgents.find(a => a.id === vendor.source_agent_id) || {}).full_name || 'Unknown'
                : '-';
            // Count salespeople (active vendor contacts) for this vendor
            const spCount = cachedVendorContacts.filter(vc => vc.vendor_id === vendor.id && vc.status !== 'Left Company').length;

            return `
            <tr>
                <td><strong>${vendor.name || 'N/A'}</strong></td>
                <td><a href="${websiteUrl}" target="_blank">${vendor.website ? 'Visit' : 'N/A'}</a></td>
                <td>${vendor.product_description || 'N/A'}</td>
                <td>${vendor.country || 'N/A'}</td>
                <td>${agentName}</td>
                <td style="text-align: center;"><span style="background: ${spCount > 0 ? '#EFF6FF' : '#f5f5f5'}; color: ${spCount > 0 ? '#3B82F6' : '#999'}; padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 13px;">${spCount}</span></td>
                <td>${vendor.projected_volume ? formatCurrency(vendor.projected_volume) : 'N/A'}</td>
                <td>
                    <select onchange="updateVendorStatus('${vendor.id}', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                        ${'Active,Inactive'.split(',').map(s => `<option value="${s}" ${(vendor.status || '') === s ? 'selected' : ''}>${s}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <button class="btn btn-secondary btn-sm" onclick="viewVendor('${vendor.id}')">View</button>
                </td>
            </tr>
        `;
        }).join('');
    }

    function filterLenders() {
        const search = document.getElementById('lenderSearch').value.toLowerCase();
        const countryFilter = document.getElementById('lenderCountryFilter').value;
        const statusFilter = document.getElementById('lenderStatusFilter').value;

        let filtered = allLenders.filter(lender => {
            const matchesSearch = !search ||
                (lender.name || '').toLowerCase().includes(search) ||
                (lender.lender_type || '').toLowerCase().includes(search) ||
                (lender.country || '').toLowerCase().includes(search) ||
                (lender.currency || '').toLowerCase().includes(search) ||
                (lender.lender_id || '').toLowerCase().includes(search);
            const matchesCountry = !countryFilter || (lender.country || '').includes(countryFilter);
            const matchesStatus = !statusFilter || lender.status === statusFilter;
            return matchesSearch && matchesCountry && matchesStatus;
        });

        renderLendersTable(filtered);
    }

    function filterVendors() {
        const search = document.getElementById('vendorSearch').value.toLowerCase();
        const countryFilter = document.getElementById('vendorCountryFilter').value;
        const statusFilter = document.getElementById('vendorStatusFilter').value;

        let filtered = allVendors.filter(vendor => {
            const matchesSearch = !search ||
                (vendor.name || '').toLowerCase().includes(search) ||
                (vendor.product_description || '').toLowerCase().includes(search) ||
                (vendor.country || '').toLowerCase().includes(search);
            const matchesCountry = !countryFilter || (vendor.country || '').includes(countryFilter);
            const matchesStatus = !statusFilter || vendor.status === statusFilter;
            return matchesSearch && matchesCountry && matchesStatus;
        });

        renderVendorsTable(filtered);
    }

    function generateCountryCheckboxes(currentCountry, fieldName, onChangeCallback) {
        const countries = ['Canada', 'United States', 'UK', 'Germany'];
        const currentCountries = currentCountry ? currentCountry.split(',').map(c => c.trim()) : [];

        return `
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                ${countries.map(country => `
                    <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                        <input type="checkbox" name="${fieldName}" value="${country}" ${currentCountries.includes(country) ? 'checked' : ''} onchange="${onChangeCallback}"> ${country}
                    </label>
                `).join('')}
            </div>
        `;
    }

    async function loadContacts() {
        try {
            const { data, error } = await db
                .from('contact_submissions')
                .select('*')
                .order('submitted_at', { ascending: false });

            if (error) throw error;

            const tbody = document.getElementById('contactsBody');
            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No contact submissions found.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(contact => `
                <tr>
                    <td><strong>${contact.name || 'N/A'}</strong></td>
                    <td>${contact.email || 'N/A'}</td>
                    <td>${contact.subject || 'N/A'}</td>
                    <td>${formatDate(contact.submitted_at)}</td>
                    <td>${getContactStatusBadge(contact.status || 'New')}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="viewContact('${contact.id}')">View</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Load contacts error:', error);
        }
    }

    async function loadPageData(pageName) {
        switch (pageName) {
            case 'dashboard':
                await loadDashboard();
                break;
            case 'deals':
                await loadDeals();
                break;
            case 'applications':
                // Redirect applications to deals
                await loadDeals();
                break;
            case 'agents':
                await loadAgents();
                break;
            case 'lenders':
                await loadLenders();
                break;
            case 'vendors':
                await loadVendors();
                break;
            case 'contacts':
                await loadContacts();
                break;
        }
    }

    // ============================================
    // Deal Management
    // ============================================

    async function viewDeal(dealId) {
        try {
            // Fetch deal with joined data
            const { data: deal, error } = await db
                .from('deals')
                .select('*, applications(application_id), lenders(name)')
                .eq('id', dealId)
                .single();

            if (error) throw error;
            if (!deal) { alert('Deal not found'); return; }

            // Fetch client contacts for this deal
            const { data: clientContacts } = await db
                .from('client_contacts')
                .select('*')
                .eq('deal_id', dealId);

            // Fetch syndication entries for this deal
            const { data: syndications } = await db
                .from('deal_syndication')
                .select('*, lenders(name)')
                .eq('deal_id', dealId);

            // Fetch documents for this deal
            const { data: dealDocuments } = await db
                .from('documents')
                .select('*')
                .eq('deal_id', dealId)
                .order('uploaded_at', { ascending: false });

            // Load cached lookups
            if (cachedLenders.length === 0) {
                const { data: lenderList } = await db.from('lenders').select('id, name').order('name');
                cachedLenders = lenderList || [];
            }
            if (cachedVendors.length === 0) {
                const { data: vendorList } = await db.from('vendors').select('id, name').order('name');
                cachedVendors = vendorList || [];
            }
            if (cachedAgents.length === 0) {
                const { data: agentList } = await db.from('users').select('id, full_name').eq('role', 'agent').order('full_name');
                cachedAgents = agentList || [];
            }

            // Check if agent viewing (read-only for most fields)
            const isAgentView = !['super_admin', 'admin'].includes(currentUserRole);
            const roField = (val) => `<div style="padding: 6px 10px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 14px; min-height: 20px;">${val || '-'}</div>`;

            // Build product type options
            const productTypes = ['Equipment Leasing', 'MCA', 'CSBFL', 'SRED', 'Private Debt', 'Factoring', 'Merchant Advance', 'Commercial Mortgage', 'SBA', 'Loans', 'Trade Finance', 'Working Capital Loan', 'Business Line of Credit', 'Startup Financing', 'Franchise Financing', 'Other'];
            const productTypeOptions = productTypes.map(pt => `<option value="${pt}" ${deal.product_type === pt ? 'selected' : ''}>${pt}</option>`).join('');

            // Build source options
            const sourceOptions = ['Online', 'Agent Referral', 'Direct', 'Vendor', 'Repeat Client'].map(s => `<option value="${s}" ${deal.source === s ? 'selected' : ''}>${s}</option>`).join('');

            // Build currency options
            const currencyOptions = ['CAD', 'USD', 'GBP', 'EUR'].map(c => `<option value="${c}" ${deal.currency === c ? 'selected' : ''}>${c}</option>`).join('');

            // Parse notes
            let notes = [];
            try {
                notes = deal.notes ? JSON.parse(deal.notes) : [];
            } catch (e) {
                notes = deal.notes ? [{ text: deal.notes, author: 'System', date: 'Previously' }] : [];
            }

            // Build syndication entries HTML
            const syndicationRows = (syndications || []).map(s => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 8px;">
                    <div>
                        <div style="font-weight: 600;">${s.lenders?.name || 'Unknown Lender'}</div>
                        <div style="font-size: 12px; color: #666;">Amount: ${s.amount_contributed ? formatCurrency(s.amount_contributed) : 'N/A'} | Participation: ${s.participation_pct || 'N/A'}% | Status: ${s.status || 'Pending'}</div>
                    </div>
                    <button onclick="removeSyndication('${s.id}', '${dealId}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Remove</button>
                </div>
            `).join('');

            // Build client contacts HTML
            const contactRows = (clientContacts || []).map(c => `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${c.contact_name || 'Unknown'}</div>
                        <div style="font-size: 12px; color: #666; line-height: 1.4;">
                            ${c.title ? `<div>Title: ${c.title}</div>` : ''}
                            ${c.email ? `<div>Email: ${c.email}</div>` : ''}
                            ${c.phone ? `<div>Phone: ${c.phone}</div>` : ''}
                            ${c.cell ? `<div>Cell: ${c.cell}</div>` : ''}
                            ${c.address ? `<div>Address: ${c.address}</div>` : ''}
                        </div>
                    </div>
                    <button onclick="deleteDealClientContact('${c.id}', '${dealId}', '${c.contact_name}')" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px;">Delete</button>
                </div>
            `).join('');

            // Build notes HTML
            const notesRows = notes.map((n, idx) => `
                <div style="padding: 10px; background: #f5f5f5; border-radius: 4px; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: var(--navy); margin-bottom: 4px;">${n.author || 'Unknown'} - ${n.date || 'Unknown'}</div>
                    <div style="font-size: 13px; color: #333; line-height: 1.4;">${n.text}</div>
                </div>
            `).join('');

            const lenderName = deal.lenders?.name || cachedLenders.find(l => l.id === deal.assigned_lender_id)?.name || 'None';
            const modalBody = document.getElementById('dealModalBody');
            modalBody.innerHTML = `
                <!-- Row 1: AF #, AFG # and Company Name -->
                <div class="modal-row" style="grid-template-columns: 1fr 1fr 2fr;">
                    <div class="modal-field">
                        <label>AF #</label>
                        <div style="padding: 6px 10px;">${deal.applications?.application_id || deal.deal_number || 'Auto-generated'}</div>
                    </div>
                    <div class="modal-field">
                        <label>AFG # <span style="font-weight:400;color:#6D28D9;font-size:11px;">(Booking #)</span></label>
                        ${isAgentView ? roField(deal.afg_number || 'Not yet assigned') : `<input type="text" value="${deal.afg_number || ''}" placeholder="Enter when booked" onblur="updateDealField('${dealId}', 'afg_number', this.value)" style="padding: 6px 10px; border: 1px solid #c4b5fd; border-radius: 4px; font-size: 14px; width: 100%; background: #faf5ff;">`}
                    </div>
                    <div class="modal-field">
                        <label>Company Name</label>
                        ${isAgentView ? roField(deal.company_name) : `<input type="text" value="${deal.company_name || ''}" onblur="updateDealField('${dealId}', 'company_name', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">`}
                    </div>
                </div>

                <!-- Referring Agent Banner (if from agent referral) -->
                ${deal.source_agent_id ? `<div id="dealAgentBanner" style="background:#FEF3C7;border:1px solid #FCD34D;border-radius:8px;padding:12px 16px;margin-bottom:12px;display:flex;align-items:center;gap:12px;">
                    <span style="font-size:20px;">üë§</span>
                    <div id="dealAgentBannerInfo" style="font-size:13px;color:#92400E;line-height:1.5;"><strong>Referring Agent:</strong> Loading...</div>
                </div>` : ''}

                <!-- Row 2: Deal Amount and Currency -->
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Deal Amount</label>
                        ${isAgentView ? roField(deal.deal_amount ? formatCurrency(deal.deal_amount) : '') : `<input type="number" value="${deal.deal_amount || ''}" onblur="updateDealField('${dealId}', 'deal_amount', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">`}
                    </div>
                    <div class="modal-field">
                        <label>Currency</label>
                        ${isAgentView ? roField(deal.currency || 'CAD') : `<select onchange="updateDealField('${dealId}', 'currency', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">${currencyOptions}</select>`}
                    </div>
                </div>

                <!-- Row 3: Product Type and Status -->
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Product Type</label>
                        ${isAgentView ? roField(deal.product_type) : `<select onchange="updateDealField('${dealId}', 'product_type', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;"><option value="">Select Product Type</option>${productTypeOptions}</select>`}
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        ${isAgentView ? roField(deal.status) : `<select onchange="updateDealField('${dealId}', 'status', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">${getDealStatusOptions(deal.status)}</select>`}
                    </div>
                </div>

                <!-- Row 4: Source and Assigned Lender -->
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Source</label>
                        ${isAgentView ? roField((deal.source_channel || deal.source || 'N/A') + (deal.source === 'Vendor' ? ' (Vendor Program)' : deal.source === 'Agent Referral' ? ' (Referral Link)' : deal.source === 'Direct' ? ' (Direct)' : '')) : `<select id="dealDetailSource" onchange="updateDealSource('${dealId}', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">${sourceOptions}</select>
                        <div id="dealSourceVendor" style="display: ${deal.source === 'Vendor' ? 'block' : 'none'}; margin-top: 8px;">
                            <label style="font-size: 13px;">Select Vendor:</label>
                            <select id="dealVendorSelect" onchange="updateDealField('${dealId}', 'source_vendor_id', this.value); loadVendorSalespeople('${dealId}', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">
                                <option value="">Select Vendor</option>
                                ${cachedVendors.map(v => `<option value="${v.id}" ${deal.source_vendor_id === v.id ? 'selected' : ''}>${v.name}</option>`).join('')}
                            </select>
                            <div id="dealSalespersonContainer" style="margin-top: 8px; display: ${deal.source_vendor_id ? 'block' : 'none'};">
                                <label style="font-size: 13px;">Salesperson:</label>
                                <select id="dealSalespersonSelect" onchange="updateDealField('${dealId}', 'vendor_salesperson_id', this.value || null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">
                                    <option value="">Select Salesperson</option>
                                </select>
                            </div>
                        </div>
                        <div id="dealSourceAgent" style="display: ${deal.source === 'Agent Referral' ? 'block' : 'none'}; margin-top: 8px;">
                            <label style="font-size: 13px;">Select Agent:</label>
                            <select onchange="updateDealField('${dealId}', 'source_agent_id', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">
                                <option value="">Select Agent</option>
                                ${cachedAgents.map(a => `<option value="${a.id}" ${deal.source_agent_id === a.id ? 'selected' : ''}>${a.full_name}</option>`).join('')}
                            </select>
                        </div>`}
                    </div>
                    <div class="modal-field">
                        ${isAgentView ? (() => {
                            const vendorName = deal.source_vendor_id ? (cachedVendors.find(v => v.id === deal.source_vendor_id)?.name || 'N/A') : 'None';
                            return '<label>Vendor</label>' + roField(vendorName);
                        })() : `<label>Assigned Lender</label><select onchange="updateDealField('${dealId}', 'assigned_lender_id', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">
                            <option value="">None</option>
                            ${cachedLenders.map(l => `<option value="${l.id}" ${deal.assigned_lender_id === l.id ? 'selected' : ''}>${l.name}</option>`).join('')}
                        </select>`}
                    </div>
                </div>

                <!-- Row 5: Expected Close and Dates -->
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Expected Close Month</label>
                        ${isAgentView ? roField(deal.expected_close_month) : `<input type="text" value="${deal.expected_close_month || ''}" onblur="updateDealField('${dealId}', 'expected_close_month', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">`}
                    </div>
                    <div class="modal-field">
                        <label>Date Submitted</label>
                        ${isAgentView ? roField(formatDate(deal.date_submitted)) : `<input type="date" value="${deal.date_submitted ? deal.date_submitted.split('T')[0] : ''}" onblur="updateDealField('${dealId}', 'date_submitted', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">`}
                    </div>
                </div>

                <!-- Row 6: Commission Info (read-only for agents, editable for admins) -->
                <div style="margin-top: 15px; padding: 15px; background: ${isAgentView ? '#f0fdf4' : '#fff'}; border: 1px solid ${isAgentView ? '#bbf7d0' : 'transparent'}; border-radius: 8px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy); margin-bottom: 10px; display: block;">${isAgentView ? 'Your Commission' : 'Fee Details & Commission Split'}</label>
                    <div class="modal-row">
                        <div class="modal-field">
                            <label>${isAgentView ? 'Your Fee %' : 'Agent Fee %'}</label>
                            ${isAgentView ? roField(deal.agent_fee_pct ? deal.agent_fee_pct + '%' : 'Not set') : `<input type="number" step="0.01" value="${deal.agent_fee_pct || ''}" onblur="updateDealField('${dealId}', 'agent_fee_pct', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">`}
                        </div>
                        <div class="modal-field">
                            <label>${isAgentView ? 'Your Fee Amount' : 'Agent Fee Amount'}</label>
                            ${isAgentView ? roField(deal.agent_fee_amount ? formatCurrency(deal.agent_fee_amount) : 'Not set') : `<input type="number" step="0.01" value="${deal.agent_fee_amount || ''}" onblur="updateDealField('${dealId}', 'agent_fee_amount', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">`}
                        </div>
                    </div>
                    ${!isAgentView ? `
                    <!-- Sub-Agent Commission (admin only) -->
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px dashed #e2e8f0;">
                        <label style="font-size: 13px; font-weight: 600; color: #64748b; margin-bottom: 8px; display: block;">Sub-Agent Split</label>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Sub-Agent</label>
                                <select onchange="updateDealField('${dealId}', 'sub_agent_id', this.value || null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                                    <option value="">None</option>
                                    ${cachedAgents.map(a => '<option value="' + a.id + '"' + (deal.sub_agent_id === a.id ? ' selected' : '') + '>' + (a.full_name || 'Agent') + '</option>').join('')}
                                </select>
                            </div>
                            <div class="modal-field">
                                <label>Sub-Agent Fee %</label>
                                <input type="number" step="0.01" value="${deal.sub_agent_fee_pct || ''}" onblur="updateDealField('${dealId}', 'sub_agent_fee_pct', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Sub-Agent Fee $</label>
                                <input type="number" step="0.01" value="${deal.sub_agent_fee_amount || ''}" onblur="updateDealField('${dealId}', 'sub_agent_fee_amount', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                            <div class="modal-field">
                                <label>Parent Override %</label>
                                <input type="number" step="0.01" value="${deal.parent_override_pct || ''}" onblur="updateDealField('${dealId}', 'parent_override_pct', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Parent Override $</label>
                                <input type="number" step="0.01" value="${deal.parent_override_amount || ''}" onblur="updateDealField('${dealId}', 'parent_override_amount', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                            <div class="modal-field">
                                <label>Alliance Fee %</label>
                                <input type="number" step="0.01" value="${deal.alliance_fee_pct || ''}" onblur="updateDealField('${dealId}', 'alliance_fee_pct', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                    </div>
                    <!-- Gross Fee & Alliance Net -->
                    <div class="modal-row" style="margin-top: 12px;">
                        <div class="modal-field">
                            <label>Gross Fee %</label>
                            <input type="number" step="0.01" value="${deal.gross_fee_pct || ''}" onblur="updateDealField('${dealId}', 'gross_fee_pct', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                        </div>
                        <div class="modal-field">
                            <label>Alliance Net Fee</label>
                            <input type="number" step="0.01" value="${deal.alliance_net_fee || ''}" onblur="updateDealField('${dealId}', 'alliance_net_fee', this.value ? parseFloat(this.value) : null)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                        </div>
                    </div>
                    <!-- Commission Summary -->
                    ${(() => {
                        const amt = deal.deal_amount || 0;
                        const agentFee = deal.agent_fee_amount || 0;
                        const subFee = deal.sub_agent_fee_amount || 0;
                        const parentOvr = deal.parent_override_amount || 0;
                        const allianceNet = deal.alliance_net_fee || 0;
                        if (agentFee || subFee || parentOvr || allianceNet) {
                            return '<div style="margin-top: 12px; padding: 10px; background: #f8fafc; border-radius: 6px; font-size: 13px;">' +
                                '<strong>Commission Summary:</strong> ' +
                                'Agent: ' + formatCurrency(agentFee) +
                                (subFee ? ' | Sub-Agent: ' + formatCurrency(subFee) : '') +
                                (parentOvr ? ' | Parent Override: ' + formatCurrency(parentOvr) : '') +
                                (allianceNet ? ' | Alliance Net: ' + formatCurrency(allianceNet) : '') +
                                '</div>';
                        }
                        return '';
                    })()}
                    ` : ''}
                </div>

                ${!isAgentView ? `
                <!-- Admin-only: Syndicated and additional dates -->
                <div class="modal-row" style="margin-top: 15px;">
                    <div class="modal-field">
                        <label style="display: flex; align-items: center;">
                            <input type="checkbox" ${deal.is_syndicated ? 'checked' : ''} onchange="updateDealField('${dealId}', 'is_syndicated', this.checked)" style="margin-right: 8px; cursor: pointer;">
                            Syndicated
                        </label>
                    </div>
                    <div class="modal-field">
                        <label>Close Date</label>
                        <input type="date" value="${deal.close_date ? deal.close_date.split('T')[0] : ''}" onblur="updateDealField('${dealId}', 'close_date', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Start Date</label>
                        <input type="date" value="${deal.start_date ? deal.start_date.split('T')[0] : ''}" onblur="updateDealField('${dealId}', 'start_date', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                    </div>
                    <div class="modal-field">
                        <label>End Date</label>
                        <input type="date" value="${deal.end_date ? deal.end_date.split('T')[0] : ''}" onblur="updateDealField('${dealId}', 'end_date', this.value)" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                    </div>
                </div>

                <!-- Syndication Section (admin only) -->
                <div id="syndicationSection" style="display: ${deal.is_syndicated ? 'block' : 'none'}; margin-top: 20px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px; display: block;">Syndication Partners</label>
                    ${syndicationRows || '<div style="color: #999; padding: 10px;">No syndication entries yet.</div>'}
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; border: 1px solid var(--border-gray);">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--navy);">Add Syndication Entry</div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Lender</label>
                                <select id="newSyndLender" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; cursor: pointer;">
                                    <option value="">Select Lender</option>
                                    ${cachedLenders.map(l => `<option value="${l.id}">${l.name}</option>`).join('')}
                                </select>
                            </div>
                            <div class="modal-field">
                                <label>Amount Contributed</label>
                                <input type="number" id="newSyndAmount" placeholder="0" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Participation %</label>
                                <input type="number" id="newSyndPct" step="0.01" placeholder="0" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                            <div class="modal-field">
                                <label>&nbsp;</label>
                                <button onclick="addSyndication('${dealId}')" style="padding: 8px 16px; background: var(--gold); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; width: 100%;">Add Syndication</button>
                            </div>
                        </div>
                    </div>
                </div>` : ''}

                <!-- Client Contacts Section -->
                <div style="margin-top: 20px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px; display: block;">Client Contacts</label>

                    ${contactRows || '<div style="color: #999; padding: 10px;">No client contacts yet.</div>'}

                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; border: 1px solid var(--border-gray);">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--navy);">Add Client Contact</div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Name</label>
                                <input type="text" id="newClientName" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                            <div class="modal-field">
                                <label>Title</label>
                                <input type="text" id="newClientTitle" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Email</label>
                                <input type="email" id="newClientEmail" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                            <div class="modal-field">
                                <label>Phone</label>
                                <input type="text" id="newClientPhone" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field">
                                <label>Cell</label>
                                <input type="text" id="newClientCell" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                            <div class="modal-field">
                                <label>Address</label>
                                <input type="text" id="newClientAddress" style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%;">
                            </div>
                        </div>
                        <div class="modal-row">
                            <div class="modal-field full">
                                <button onclick="addDealClientContact('${dealId}')" style="padding: 8px 16px; background: var(--gold); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; width: 100%;">Add Contact</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div style="margin-top: 20px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px; display: block;">Notes</label>

                    ${notesRows || '<div style="color: #999; padding: 10px;">No notes yet.</div>'}

                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; border: 1px solid var(--border-gray);">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--navy);">Add Note</div>
                        <textarea id="newDealNoteText" placeholder="Enter note text..." style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; min-height: 80px; font-family: Arial, sans-serif; margin-bottom: 10px;"></textarea>
                        <button onclick="addDealNote('${dealId}')" style="padding: 8px 16px; background: var(--gold); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Add Note</button>
                    </div>
                </div>

                ${buildDocumentsHtml(dealDocuments || [], dealId, null)}
            `;

            // Archive/Restore button in modal footer
            var archiveBtnEl = document.getElementById('dealModalArchiveBtn');
            if (archiveBtnEl && !isAgentView) {
                if (deal.is_archived) {
                    archiveBtnEl.innerHTML = '<button class="btn btn-sm" onclick="toggleArchiveDeal(\'' + dealId + '\', false); closeDealModal();" style="padding:6px 16px;background:#f0fdf4;color:#166534;border:1px solid #86efac;border-radius:4px;cursor:pointer;">Restore from Archive</button>';
                } else {
                    archiveBtnEl.innerHTML = '<button class="btn btn-sm" onclick="toggleArchiveDeal(\'' + dealId + '\', true); closeDealModal();" style="padding:6px 16px;background:#fef2f2;color:#991b1b;border:1px solid #fca5a5;border-radius:4px;cursor:pointer;">Archive Deal</button>';
                }
            } else if (archiveBtnEl) {
                archiveBtnEl.innerHTML = '';
            }

            document.getElementById('dealModal').classList.add('active');

            // Load referring agent info banner
            if (deal.source_agent_id) {
                (async function() {
                    try {
                        var { data: agentInfo } = await db.from('users').select('full_name, email, phone').eq('id', deal.source_agent_id).maybeSingle();
                        var bannerEl = document.getElementById('dealAgentBannerInfo');
                        if (bannerEl && agentInfo) {
                            var html = '<strong>Referring Agent:</strong> ' + (agentInfo.full_name || 'Unknown');
                            if (agentInfo.email) html += ' &nbsp;|&nbsp; ' + agentInfo.email;
                            if (agentInfo.phone) html += ' &nbsp;|&nbsp; ' + agentInfo.phone;
                            bannerEl.innerHTML = html;
                        }
                    } catch(e) { console.warn('Agent banner load error:', e); }
                })();
            }

            // Auto-load salesperson dropdown if deal has a vendor source
            if (deal.source === 'Vendor' && deal.source_vendor_id) {
                loadVendorSalespeople(dealId, deal.source_vendor_id);
            }
        } catch (error) {
            console.error('View deal error:', error);
            alert('Error loading deal details: ' + error.message);
        }
    }

    function getDealStatusOptions(currentStatus) {
        const statuses = ['Prospect', 'Quote sent', 'Info received', 'In Credit', 'Approved', 'Approval sent', 'Docs requested', 'Docs out for signing', 'In funding', 'Funded', 'Declined', 'Dead approval', 'Withdrawn'];
        return statuses.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s}</option>`).join('');
    }

    async function updateDealStatus(dealId, newStatus) {
        try {
            const { error } = await db
                .from('deals')
                .update({ status: newStatus })
                .eq('id', dealId);

            if (error) throw error;

            // Refresh the deals table and dashboard stats
            await loadDeals();
            await loadDashboard();
        } catch (error) {
            console.error('Update status error:', error);
            alert('Error updating status: ' + error.message);
        }
    }

    function closeDealModal() {
        document.getElementById('dealModal').classList.remove('active');
    }

    async function updateDealSource(dealId, source) {
        await updateDealField(dealId, 'source', source);
        document.getElementById('dealSourceVendor').style.display = source === 'Vendor' ? 'block' : 'none';
        document.getElementById('dealSourceAgent').style.display = source === 'Agent Referral' ? 'block' : 'none';
        // Hide salesperson dropdown when source changes away from Vendor
        const spContainer = document.getElementById('dealSalespersonContainer');
        if (spContainer && source !== 'Vendor') spContainer.style.display = 'none';
    }

    async function loadVendorSalespeople(dealId, vendorId) {
        const container = document.getElementById('dealSalespersonContainer');
        const select = document.getElementById('dealSalespersonSelect');
        if (!container || !select) return;

        if (!vendorId) {
            container.style.display = 'none';
            return;
        }

        container.style.display = 'block';
        select.innerHTML = '<option value="">Loading...</option>';

        try {
            const { data: contacts } = await db.from('vendor_contacts')
                .select('id, contact_name, role_title, status')
                .eq('vendor_id', vendorId)
                .order('contact_name');

            const activeContacts = (contacts || []).filter(c => c.status !== 'Left Company');

            // Get current deal's salesperson
            const { data: deal } = await db.from('deals').select('vendor_salesperson_id').eq('id', dealId).single();
            const currentSpId = deal?.vendor_salesperson_id || '';

            select.innerHTML = '<option value="">No Salesperson</option>' +
                activeContacts.map(c =>
                    `<option value="${c.id}" ${currentSpId === c.id ? 'selected' : ''}>${c.contact_name}${c.role_title ? ' (' + c.role_title + ')' : ''}</option>`
                ).join('');

            if (activeContacts.length === 0) {
                select.innerHTML = '<option value="">No salespeople for this vendor</option>';
            }
        } catch (err) {
            console.error('Load vendor salespeople error:', err);
            select.innerHTML = '<option value="">Error loading salespeople</option>';
        }
    }

    async function addSyndication(dealId) {
        const lenderId = document.getElementById('newSyndLender').value;
        const amount = document.getElementById('newSyndAmount').value;
        const pct = document.getElementById('newSyndPct').value;
        if (!lenderId) { alert('Please select a lender'); return; }
        try {
            const { error } = await db.from('deal_syndication').insert({
                deal_id: dealId,
                lender_id: lenderId,
                amount_contributed: amount ? parseFloat(amount) : null,
                participation_pct: pct ? parseFloat(pct) : null,
                status: 'Pending'
            });
            if (error) throw error;
            await viewDeal(dealId);
        } catch (error) {
            alert('Error adding syndication: ' + error.message);
        }
    }

    async function removeSyndication(syndId, dealId) {
        if (!confirm('Remove this syndication entry?')) return;
        try {
            const { error } = await db.from('deal_syndication').delete().eq('id', syndId);
            if (error) throw error;
            await viewDeal(dealId);
        } catch (error) {
            alert('Error removing syndication: ' + error.message);
        }
    }

    async function addDealClientContact(dealId) {
        const name = document.getElementById('newClientName').value.trim();
        if (!name) { alert('Please enter a contact name'); return; }
        try {
            const { error } = await db.from('client_contacts').insert({
                deal_id: dealId,
                contact_name: name,
                title: document.getElementById('newClientTitle').value.trim() || null,
                email: document.getElementById('newClientEmail').value.trim() || null,
                phone: document.getElementById('newClientPhone').value.trim() || null,
                cell: document.getElementById('newClientCell').value.trim() || null,
                address: document.getElementById('newClientAddress').value.trim() || null,
                is_primary: false
            });
            if (error) throw error;
            await viewDeal(dealId);
        } catch (error) {
            alert('Error adding client contact: ' + error.message);
        }
    }

    async function deleteDealClientContact(contactId, dealId, name) {
        if (!confirm(`Delete contact "${name}"?`)) return;
        try {
            const { error } = await db.from('client_contacts').delete().eq('id', contactId);
            if (error) throw error;
            await viewDeal(dealId);
        } catch (error) {
            alert('Error deleting contact: ' + error.message);
        }
    }

    async function addDealNote(dealId) {
        const noteText = document.getElementById('newDealNoteText').value.trim();
        if (!noteText) return;
        try {
            const { data: deal } = await db.from('deals').select('notes').eq('id', dealId).single();
            let notes = [];
            try { notes = deal.notes ? JSON.parse(deal.notes) : []; } catch(e) { notes = deal.notes ? [{ text: deal.notes, author: 'System', date: 'Previously' }] : []; }
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;
            notes.push({ text: noteText, author: userEmail, date: dateStr });
            const { error } = await db.from('deals').update({ notes: JSON.stringify(notes) }).eq('id', dealId);
            if (error) throw error;
            await viewDeal(dealId);
        } catch (error) {
            alert('Error adding note: ' + error.message);
        }
    }

    async function openAddDealModal() {
        document.getElementById('addDealForm').reset();
        // Populate lender dropdown
        if (cachedLenders.length === 0) {
            const { data: lenderList } = await db.from('lenders').select('id, name').order('name');
            cachedLenders = lenderList || [];
        }
        const lenderSelect = document.getElementById('dealLender');
        lenderSelect.innerHTML = '<option value="">None</option>' +
            cachedLenders.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        document.getElementById('addDealModal').classList.add('active');
    }

    function closeAddDealModal() {
        document.getElementById('addDealModal').classList.remove('active');
    }

    async function handleAddDeal(event) {
        event.preventDefault();

        try {
            const lenderVal = document.getElementById('dealLender').value;
            const { data, error } = await db
                .from('deals')
                .insert([{
                    company_name: document.getElementById('companyName').value,
                    deal_amount: parseFloat(document.getElementById('dealAmount').value),
                    currency: document.getElementById('dealCurrency').value,
                    product_type: document.getElementById('productType').value,
                    source: document.getElementById('dealSource').value,
                    status: document.getElementById('dealStatus').value,
                    assigned_lender_id: lenderVal || null,
                    date_submitted: new Date().toISOString()
                }])
                .select();

            if (error) throw error;

            closeAddDealModal();
            await loadDeals();
        } catch (error) {
            console.error('Add deal error:', error);
            alert('Error creating deal: ' + error.message);
        }
    }

    // ============================================
    // Application Management
    // ============================================

    async function viewApplication(appId) {
        try {
            const { data: app, error } = await db
                .from('applications')
                .select('*')
                .eq('id', appId)
                .single();

            if (error) throw error;

            // Fetch documents for this application
            const { data: appDocuments } = await db
                .from('documents')
                .select('*')
                .eq('application_id', appId)
                .order('uploaded_at', { ascending: false });

            // Format form type display
            const formTypeLabels = {
                'leasing': 'Equipment Leasing',
                'merchant-advance': 'Merchant Cash Advance',
                'working-capital': 'Working Capital & Factoring'
            };
            const formTypeDisplay = formTypeLabels[app.form_type] || app.form_type || 'Standard';

            // Build full application data view from form_data JSONB
            let fullDataHtml = '';
            if (app.form_data && typeof app.form_data === 'object') {
                const fd = app.form_data;
                // Nice field labels
                const labels = {
                    equipmentDescription: 'Equipment Description', equipmentCost: 'Equipment Cost',
                    vendorName: 'Vendor/Supplier', equipmentCondition: 'Condition',
                    businessLegalName: 'Business Legal Name', legalName: 'Business Legal Name',
                    tradeName: 'Trade Name', businessPhone: 'Business Phone', bizPhone: 'Business Phone',
                    businessEmail: 'Business Email', bizEmail: 'Business Email',
                    businessAddress: 'Business Address', bizAddress: 'Business Address',
                    city: 'City', bizCity: 'City', province: 'Province/State', bizProv: 'Province/State',
                    postalCode: 'Postal/Zip', bizPostal: 'Postal/Zip', country: 'Country', bizCountry: 'Country',
                    contactName: 'Contact Name', contactTitle: 'Contact Title',
                    businessDescription: 'Business Description', bizDescription: 'Business Description',
                    businessStartDate: 'Business Start Date', dateIncorporated: 'Date Incorporated',
                    structure: 'Business Structure',
                    principal1Name: 'Principal 1 Name', principal1Title: 'Principal 1 Title',
                    principal1Ownership: 'Principal 1 Ownership %', principal1DOB: 'Principal 1 DOB',
                    principal1Phone: 'Principal 1 Phone', principal1Address: 'Principal 1 Address',
                    principal1City: 'Principal 1 City', principal1Prov: 'Principal 1 Prov/State',
                    principal1Postal: 'Principal 1 Postal',
                    principal2Name: 'Principal 2 Name', principal2Title: 'Principal 2 Title',
                    principal2Ownership: 'Principal 2 Ownership %', principal2DOB: 'Principal 2 DOB',
                    principal2Phone: 'Principal 2 Phone', principal2Address: 'Principal 2 Address',
                    insuranceBroker: 'Insurance Broker', insuranceContact: 'Insurance Contact',
                    insurancePhone: 'Insurance Phone', landlord: 'Landlord',
                    landlordContact: 'Landlord Contact', landlordPhone: 'Landlord Phone',
                    advanceAmount: 'Advance Amount', fundsPurpose: 'Purpose of Funds',
                    industry: 'Industry', timeInBusiness: 'Time in Business',
                    monthlyRevenue: 'Monthly Revenue', cardSales: 'Monthly Card Sales',
                    annualRevenue: 'Annual Revenue', annualSales: 'Annual Sales',
                    processor: 'Merchant Processor', bankName: 'Bank Name',
                    currentMCA: 'Current MCA?', mcaBalance: 'MCA Balance',
                    existingLoans: 'Existing Loans?', loanPayment: 'Loan Payment',
                    taxLiens: 'Tax Liens?', taxArrears: 'Tax Arrears?',
                    ownerName: 'Owner Name', ownerTitle: 'Owner Title',
                    ownerPct: 'Ownership %', ownerDOB: 'Owner DOB',
                    ownerPhone: 'Owner Phone', ownerAddress: 'Owner Address', ownerEmail: 'Owner Email',
                    o1Name: 'Owner 1 Name', o1Title: 'Owner 1 Title', o1Pct: 'Owner 1 %',
                    o1DOB: 'Owner 1 DOB', o1Phone: 'Owner 1 Phone', o1Address: 'Owner 1 Address',
                    financingType: 'Financing Type', amountRequested: 'Amount Requested',
                    useOfFunds: 'Use of Funds', numEmployees: 'Employees',
                    bank1Name: 'Bank Name', bank1Officer: 'Bank Officer', bank1Phone: 'Bank Phone',
                    arOutstanding: 'AR Outstanding', arTerms: 'AR Terms',
                    arMonthlySales: 'AR Monthly Sales', arInvoiceSell: 'AR Invoice Amount',
                    gstFedId: 'GST / Federal ID Number', taxId: 'GST / Federal ID Number',
                    ownerSinSsn: 'SIN / SSN', principal1SinSsn: 'Principal 1 SIN / SSN', o1SinSsn: 'Owner 1 SIN / SSN',
                    ownerHomeStatus: 'Home Status',
                    agentName: 'Referring Agent', agentEmail: 'Agent Email', agentPhone: 'Agent Phone'
                };
                // Skip internal/meta fields
                const skipFields = ['formType', 'applicationId', 'submittedAt', 'referralSource', 'signatureName', 'signatureTimestamp'];
                const entries = Object.entries(fd).filter(([k, v]) => v && v.toString().trim() && !skipFields.includes(k));
                if (entries.length > 0) {
                    fullDataHtml = '<div style="margin-top: 20px; border-top: 2px solid var(--border-gray); padding-top: 15px;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">' +
                        '<label style="font-size: 15px; font-weight: 600; color: var(--navy);">Full Application Data</label>' +
                        '<button class="btn btn-secondary btn-sm" onclick="this.parentElement.nextElementSibling.style.display=this.parentElement.nextElementSibling.style.display===\'none\'?\'block\':\'none\';this.textContent=this.textContent===\'Show Details\'?\'Hide Details\':\'Show Details\'" style="padding: 4px 12px; font-size: 12px;">Show Details</button>' +
                        '</div>' +
                        '<div style="display: none;">' +
                        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">' +
                        entries.map(([k, v]) => {
                            const label = labels[k] || k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
                            return '<div style="padding: 6px 10px; background: #f8fafc; border-radius: 4px; font-size: 13px;">' +
                                '<span style="color: var(--text-light); font-size: 11px; display: block;">' + label + '</span>' +
                                '<span style="color: var(--text-dark); font-weight: 500;">' + String(v) + '</span></div>';
                        }).join('') +
                        '</div></div></div>';
                }
            }

            // Build signature section
            let signatureHtml = '';
            if (app.signature_name) {
                signatureHtml = `
                <div style="margin-top: 15px; padding: 12px; background: #EFF6FF; border: 1px solid #BFDBFE; border-radius: 8px;">
                    <label style="font-size: 13px; font-weight: 600; color: #1E40AF; display: block; margin-bottom: 6px;">Electronic Signature</label>
                    <div style="font-size: 15px; font-weight: 600; color: var(--navy); font-style: italic;">"${app.signature_name}"</div>
                    <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Signed: ${app.signature_timestamp ? new Date(app.signature_timestamp).toLocaleString() : 'N/A'}</div>
                </div>`;
            }

            const modalBody = document.getElementById('applicationModalBody');
            modalBody.innerHTML = `
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Application ID</label>
                        <div class="modal-field-value">${app.application_id || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Form Type</label>
                        <div class="modal-field-value"><span style="background: #EFF6FF; color: #3B82F6; padding: 3px 10px; border-radius: 12px; font-weight: 600; font-size: 13px;">${formTypeDisplay}</span></div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Full Name</label>
                        <div class="modal-field-value">${app.full_name || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Email</label>
                        <div class="modal-field-value"><a href="mailto:${app.email}">${app.email || 'N/A'}</a></div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Phone</label>
                        <div class="modal-field-value">${app.phone || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Business Name</label>
                        <div class="modal-field-value">${app.business_name || 'N/A'}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Time in Business</label>
                        <div class="modal-field-value">${app.time_in_business || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Annual Revenue</label>
                        <div class="modal-field-value">${app.annual_revenue ? formatCurrency(app.annual_revenue) : 'N/A'}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Funding Amount Requested</label>
                        <div class="modal-field-value">${app.funding_amount_requested ? formatCurrency(app.funding_amount_requested) : (app.funding_amount_text || 'N/A')}</div>
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <div class="modal-field-value">${app.status || 'N/A'}</div>
                    </div>
                </div>
                <div class="modal-row full">
                    <div class="modal-field">
                        <label>Description</label>
                        <div class="modal-field-value">${app.description || 'No description'}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Submitted</label>
                        <div class="modal-field-value">${formatDate(app.submitted_at)}</div>
                    </div>
                    <div class="modal-field">
                        <label>Source</label>
                        <div class="modal-field-value">${app.source_channel || 'N/A'}${app.referral_slug ? ' (Ref: ' + app.referral_slug + ')' : ''}</div>
                    </div>
                </div>
                ${app.source_agent_id ? await (async function() {
                    var { data: agentInfo } = await db.from('users').select('full_name, email, phone').eq('id', app.source_agent_id).maybeSingle();
                    if (!agentInfo) return '';
                    return '<div style="margin-top: 12px; padding: 12px; background: #FEF3C7; border: 1px solid #FCD34D; border-radius: 8px;">' +
                        '<label style="font-size: 13px; font-weight: 600; color: #92400E; display: block; margin-bottom: 6px;">Referring Agent</label>' +
                        '<div style="font-size: 14px; color: #333;"><strong>' + (agentInfo.full_name || 'N/A') + '</strong>' +
                        (agentInfo.email ? ' &nbsp;|&nbsp; <a href="mailto:' + agentInfo.email + '">' + agentInfo.email + '</a>' : '') +
                        (agentInfo.phone ? ' &nbsp;|&nbsp; ' + agentInfo.phone : '') +
                        '</div></div>';
                })() : ''}
                ${signatureHtml}
                ${['super_admin','admin'].includes(currentUserRole) && app.signature_name ? `
                <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="generateLenderPackage('${app.id}')" style="background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üìã Generate Lender Package (Print / PDF)
                    </button>
                    <button onclick="downloadLenderZip('${app.id}')" id="zipDownloadBtn" style="background: #059669; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                        üì¶ Download Complete Package (ZIP)
                    </button>
                </div>` : ''}
                ${fullDataHtml}
                ${buildDocumentsHtml(appDocuments || [], null, appId)}
            `;

            // Store app data for lender package generation
            window._currentAppData = app;

            document.getElementById('applicationModal').classList.add('active');
        } catch (error) {
            console.error('View application error:', error);
            alert('Error loading application details');
        }
    }

    // ============================================
    // Generate Lender Package ‚Äî printable/PDF-ready
    // ============================================
    async function generateLenderPackage(appId) {
        var app = window._currentAppData;
        if (!app) { alert('Application data not available. Please reopen the application.'); return; }

        // Fetch documents for this application
        var appDocsList = [];
        try {
            var { data: docs } = await db.from('documents').select('*').eq('application_id', app.id).order('uploaded_at', { ascending: false });
            if (docs && docs.length > 0) {
                for (var di = 0; di < docs.length; di++) {
                    var doc = docs[di];
                    var signedUrl = '';
                    try {
                        var { data: urlData } = await db.storage.from('deal-documents').createSignedUrl(doc.file_path, 604800);
                        if (urlData) signedUrl = urlData.signedUrl;
                    } catch(e) { console.warn('Could not sign URL for', doc.file_name); }
                    appDocsList.push({ name: doc.file_name, type: doc.document_type, size: doc.file_size_bytes, url: signedUrl, uploadedAt: doc.uploaded_at });
                }
            }
        } catch(e) { console.warn('Could not fetch application documents:', e); }

        var fd = app.form_data || {};
        var formTypeLabels = {
            'merchant-advance': 'Merchant Cash Advance',
            'leasing': 'Equipment Leasing',
            'working-capital': 'Working Capital & Factoring'
        };
        var formTypeDisplay = formTypeLabels[app.form_type] || app.form_type || 'N/A';

        // Build field label map
        var labelMap = {
            advanceAmount:'Advance Amount Requested',fundsPurpose:'Purpose of Funds',legalName:'Legal Business Name',tradeName:'Trade Name / DBA',
            bizAddress:'Business Address',bizCity:'City',bizProv:'Province/State',bizPostal:'Postal/Zip',bizCountry:'Country',bizPhone:'Business Phone',
            bizEmail:'Business Email',gstFedId:'GST / Federal ID Number',taxId:'GST / Federal ID Number',industry:'Industry',timeInBusiness:'Time in Business',
            numEmployees:'Number of Employees',monthlyRevenue:'Monthly Revenue',cardSales:'Monthly Card Sales',annualRevenue:'Annual Revenue',
            processor:'Credit Card Processor',bankName:'Bank Name',currentMCA:'Current MCA?',mcaBalance:'MCA Balance',existingLoans:'Existing Loans?',
            loanPayment:'Loan Payment',taxLiens:'Tax Liens?',taxArrears:'Tax Arrears?',
            ownerName:'Owner Full Name',ownerTitle:'Owner Title',ownerPct:'Ownership %',ownerDOB:'Date of Birth',ownerPhone:'Phone',
            ownerAddress:'Home Address',ownerEmail:'Email',ownerSinSsn:'SIN / SSN',
            owner2Name:'Second Owner Name',owner2Title:'Second Owner Title',owner2Pct:'Second Owner %',owner2DOB:'Second Owner DOB',owner2Phone:'Second Owner Phone',
            equipmentDescription:'Equipment Description',equipmentCost:'Equipment Cost',vendorName:'Vendor Name',equipmentCondition:'Condition',
            businessLegalName:'Legal Business Name',businessPhone:'Business Phone',businessEmail:'Business Email',
            contactName:'Contact Name',bizDescription:'Business Description',businessStartDate:'Business Start Date',
            principal1Name:'Principal 1 Name',principal1Title:'Principal 1 Title',principal1Ownership:'Principal 1 Ownership %',
            principal1DOB:'Principal 1 DOB',principal1Phone:'Principal 1 Phone',principal1Address:'Principal 1 Address',
            principal1City:'Principal 1 City',principal1Prov:'Principal 1 Province/State',principal1Postal:'Principal 1 Postal/Zip',
            principal1SinSsn:'Principal 1 SIN / SSN',
            financingType:'Financing Type',amountRequested:'Amount Requested',useOfFunds:'Use of Funds',
            o1Name:'Owner 1 Name',o1Title:'Owner 1 Title',o1Pct:'Owner 1 Ownership %',o1Phone:'Owner 1 Phone',
            o1DOB:'Owner 1 DOB',o1Address:'Owner 1 Address',o1SinSsn:'Owner 1 SIN / SSN',
            dateIncorporated:'Date Incorporated',yrsOwner:'Years as Owner',annualSales:'Annual Sales',
            arOutstanding:'AR Outstanding',arTerms:'AR Terms',arMonthlySales:'AR Monthly Sales',
            structure:'Business Structure',ownerHomeStatus:'Home Status'
        };
        var skipFields = ['formType','applicationId','submittedAt','referralSource','signatureName','signatureTimestamp'];

        // Build form data rows
        var formDataRows = '';
        if (fd && typeof fd === 'object') {
            var entries = Object.entries(fd).filter(function(e) { return e[1] && e[1].toString().trim() && !skipFields.includes(e[0]); });
            entries.forEach(function(e) {
                var label = labelMap[e[0]] || e[0].replace(/([A-Z])/g, ' $1').replace(/^./, function(s){return s.toUpperCase();});
                formDataRows += '<tr><td style="padding:8px 12px;border:1px solid #ddd;font-weight:600;width:35%;background:#f8f9fa;">' + label + '</td><td style="padding:8px 12px;border:1px solid #ddd;">' + e[1] + '</td></tr>';
            });
        }

        var sigDate = app.signature_timestamp ? new Date(app.signature_timestamp).toLocaleString('en-US', {
            year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',timeZoneName:'short'
        }) : 'N/A';

        var html = '<!DOCTYPE html><html><head><title>Lender Package - ' + (app.application_id || '') + '</title>' +
            '<style>' +
            'body{font-family:Arial,Helvetica,sans-serif;margin:40px;color:#333;line-height:1.6}' +
            '.header{text-align:center;border-bottom:3px solid #1a365d;padding-bottom:20px;margin-bottom:30px}' +
            '.header h1{color:#1a365d;margin:0;font-size:24px}' +
            '.header p{color:#666;margin:5px 0 0}' +
            '.section{margin-bottom:25px}' +
            '.section h2{color:#1a365d;font-size:16px;border-bottom:2px solid #e2e8f0;padding-bottom:8px;margin-bottom:12px}' +
            'table{width:100%;border-collapse:collapse;margin-bottom:15px}' +
            'td{padding:8px 12px;border:1px solid #ddd;font-size:13px}' +
            '.signature-box{background:#f0f7ff;border:2px solid #1a365d;border-radius:8px;padding:20px;margin-top:20px}' +
            '.signature-box .sig-name{font-size:22px;font-style:italic;font-weight:700;color:#1a365d;margin:10px 0}' +
            '.signature-box .sig-meta{font-size:12px;color:#64748b}' +
            '.consent-text{font-size:11px;color:#666;margin-top:15px;padding:15px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;line-height:1.5}' +
            '.footer{margin-top:40px;text-align:center;font-size:11px;color:#999;border-top:1px solid #e2e8f0;padding-top:15px}' +
            '@media print{body{margin:20px}button{display:none !important}}' +
            '</style></head><body>' +
            '<div class="header">' +
            '<h1>Alliance Financing Group Ltd.</h1>' +
            '<p>35+ Years of Commercial Financing Excellence</p>' +
            '<p style="font-size:12px;color:#999">1-877-660-3660 ext. 222 &nbsp;|&nbsp; info@alliancefinancing.ai &nbsp;|&nbsp; alliancefinancing.ai</p>' +
            '</div>' +
            '<div style="text-align:center;margin-bottom:25px">' +
            '<h2 style="color:#1a365d;font-size:20px;margin:0">Credit Application ‚Äî ' + formTypeDisplay + '</h2>' +
            '<p style="color:#666;margin:5px 0">Application ID: <strong>' + (app.application_id || 'N/A') + '</strong> &nbsp;|&nbsp; Submitted: <strong>' + (app.submitted_at ? new Date(app.submitted_at).toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}) : 'N/A') + '</strong></p>' +
            '</div>' +
            '<div class="section"><h2>Applicant Summary</h2>' +
            '<table>' +
            '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Full Name</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.full_name || 'N/A') + '</td></tr>' +
            '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Business Name</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.business_name || 'N/A') + '</td></tr>' +
            '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Email</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.email || 'N/A') + '</td></tr>' +
            '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Phone</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.phone || 'N/A') + '</td></tr>' +
            '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Time in Business</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.time_in_business || 'N/A') + '</td></tr>' +
            '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Funding Requested</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.funding_amount_text || (app.funding_amount_requested ? '$' + Number(app.funding_amount_requested).toLocaleString() : 'N/A')) + '</td></tr>' +
            '</table></div>' +
            '<div class="section"><h2>Complete Application Details</h2>' +
            '<table>' + formDataRows + '</table></div>' +
            '<div class="section"><h2>Electronic Signature & Authorization</h2>' +
            '<div class="signature-box">' +
            '<p style="margin:0;font-size:13px;color:#64748b">The applicant has electronically signed this application:</p>' +
            '<div class="sig-name">"' + (app.signature_name || 'N/A') + '"</div>' +
            '<div class="sig-meta">Date & Time: ' + sigDate + '</div>' +
            '<div class="sig-meta">Application ID: ' + (app.application_id || 'N/A') + '</div>' +
            '<div class="sig-meta">IP-based electronic signature captured at time of submission</div>' +
            '</div>' +
            '<div class="consent-text">' +
            '<strong>Authorization Statement:</strong> The applicant confirmed that the information provided is true and complete, and authorized Alliance Financing Group Ltd. and its partners to obtain credit reports, verify business information with banks, processors, and third parties, and to use this information to evaluate the application. This electronic signature is legally binding under the <em>Personal Information Protection and Electronic Documents Act</em> (PIPEDA) and applicable provincial and state laws.' +
            '</div></div>' +
            (function() {
                if (appDocsList.length === 0) return '';
                var docTypeLabels = {
                    bank_statement:'Bank Statement', processing_statement:'Processing Statement',
                    photo_id:'Photo ID', void_cheque:'Void Cheque', business_license:'Business License',
                    tax_return:'Tax Return', financial_statements:'Financial Statements',
                    credit_report:'Credit Report', equipment_quote:'Equipment Quote / Invoice',
                    ap_ar_aging:'AP / AR Aging Report', supporting_document:'Supporting Document', other:'Other'
                };
                var docRows = appDocsList.map(function(d) {
                    var typeLabel = docTypeLabels[d.type] || d.type || 'Other';
                    var sizeMB = d.size ? (d.size / 1024 / 1024).toFixed(2) + ' MB' : 'N/A';
                    var uploaded = d.uploadedAt ? new Date(d.uploadedAt).toLocaleDateString('en-US', {year:'numeric',month:'short',day:'numeric'}) : 'N/A';
                    var link = d.url ? '<a href="' + d.url + '" target="_blank" style="color:#3B82F6;text-decoration:none;font-weight:600">Download</a>' : '<span style="color:#999">Unavailable</span>';
                    return '<tr>' +
                        '<td style="padding:8px 12px;border:1px solid #ddd;">' + d.name + '</td>' +
                        '<td style="padding:8px 12px;border:1px solid #ddd;">' + typeLabel + '</td>' +
                        '<td style="padding:8px 12px;border:1px solid #ddd;">' + sizeMB + '</td>' +
                        '<td style="padding:8px 12px;border:1px solid #ddd;">' + uploaded + '</td>' +
                        '<td style="padding:8px 12px;border:1px solid #ddd;text-align:center">' + link + '</td></tr>';
                }).join('');
                return '<div class="section"><h2>Supporting Documents (' + appDocsList.length + ' files attached)</h2>' +
                    '<table><tr style="background:#f8f9fa"><td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">File Name</td>' +
                    '<td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">Type</td>' +
                    '<td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">Size</td>' +
                    '<td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">Uploaded</td>' +
                    '<td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">Link</td></tr>' +
                    docRows + '</table>' +
                    '<p style="font-size:11px;color:#999;margin-top:8px">Document download links are valid for 7 days from the date this package was generated. If links have expired, generate a new lender package from the dashboard.</p>' +
                    '</div>';
            })() +
            '<div class="footer">' +
            '<p>This document was generated by Alliance Financing Group Ltd. ‚Äî Confidential Lender Package</p>' +
            '<p>Generated on: ' + new Date().toLocaleString() + '</p>' +
            '</div>' +
            '<div style="text-align:center;margin-top:20px"><button onclick="window.print()" style="background:#1a365d;color:white;border:none;padding:12px 30px;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600">Print / Save as PDF</button></div>' +
            '</body></html>';

        var win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
    }

    // ============================================
    // Download Complete Lender Package as ZIP
    // ============================================
    async function downloadLenderZip(appId) {
        var app = window._currentAppData;
        if (!app) { alert('Application data not available. Please reopen the application.'); return; }

        var btn = document.getElementById('zipDownloadBtn');
        var origText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '‚è≥ Building ZIP...';

        try {
            var zip = new JSZip();
            var docsFolder = zip.folder('Supporting_Documents');

            // --- Build the application summary HTML ---
            var fd = app.form_data || {};
            var formTypeLabels = {
                'merchant-advance': 'Merchant Cash Advance',
                'leasing': 'Equipment Leasing',
                'working-capital': 'Working Capital & Factoring'
            };
            var formTypeDisplay = formTypeLabels[app.form_type] || app.form_type || 'N/A';

            var labelMap = {
                advanceAmount:'Advance Amount Requested',fundsPurpose:'Purpose of Funds',legalName:'Legal Business Name',tradeName:'Trade Name / DBA',
                bizAddress:'Business Address',bizCity:'City',bizProv:'Province/State',bizPostal:'Postal/Zip',bizCountry:'Country',bizPhone:'Business Phone',
                bizEmail:'Business Email',gstFedId:'GST / Federal ID Number',taxId:'GST / Federal ID Number',industry:'Industry',timeInBusiness:'Time in Business',
                numEmployees:'Number of Employees',monthlyRevenue:'Monthly Revenue',cardSales:'Monthly Card Sales',annualRevenue:'Annual Revenue',
                processor:'Credit Card Processor',bankName:'Bank Name',currentMCA:'Current MCA?',mcaBalance:'MCA Balance',existingLoans:'Existing Loans?',
                loanPayment:'Loan Payment',taxLiens:'Tax Liens?',taxArrears:'Tax Arrears?',
                ownerName:'Owner Full Name',ownerTitle:'Owner Title',ownerPct:'Ownership %',ownerDOB:'Date of Birth',ownerPhone:'Phone',
                ownerAddress:'Home Address',ownerEmail:'Email',ownerSinSsn:'SIN / SSN',
                owner2Name:'Second Owner Name',owner2Title:'Second Owner Title',owner2Pct:'Second Owner %',owner2DOB:'Second Owner DOB',owner2Phone:'Second Owner Phone',
                equipmentDescription:'Equipment Description',equipmentCost:'Equipment Cost',vendorName:'Vendor Name',equipmentCondition:'Condition',
                businessLegalName:'Legal Business Name',businessPhone:'Business Phone',businessEmail:'Business Email',
                contactName:'Contact Name',bizDescription:'Business Description',businessStartDate:'Business Start Date',
                principal1Name:'Principal 1 Name',principal1Title:'Principal 1 Title',principal1Ownership:'Principal 1 Ownership %',
                principal1DOB:'Principal 1 DOB',principal1Phone:'Principal 1 Phone',principal1Address:'Principal 1 Address',
                principal1City:'Principal 1 City',principal1Prov:'Principal 1 Province/State',principal1Postal:'Principal 1 Postal/Zip',
                principal1SinSsn:'Principal 1 SIN / SSN',
                financingType:'Financing Type',amountRequested:'Amount Requested',useOfFunds:'Use of Funds',
                o1Name:'Owner 1 Name',o1Title:'Owner 1 Title',o1Pct:'Owner 1 Ownership %',o1Phone:'Owner 1 Phone',
                o1DOB:'Owner 1 DOB',o1Address:'Owner 1 Address',o1SinSsn:'Owner 1 SIN / SSN',
                dateIncorporated:'Date Incorporated',yrsOwner:'Years as Owner',annualSales:'Annual Sales',
                arOutstanding:'AR Outstanding',arTerms:'AR Terms',arMonthlySales:'AR Monthly Sales',
                structure:'Business Structure',ownerHomeStatus:'Home Status'
            };
            var skipFields = ['formType','applicationId','submittedAt','referralSource','signatureName','signatureTimestamp'];

            var formDataRows = '';
            if (fd && typeof fd === 'object') {
                Object.entries(fd).filter(function(e) { return e[1] && e[1].toString().trim() && !skipFields.includes(e[0]); })
                .forEach(function(e) {
                    var label = labelMap[e[0]] || e[0].replace(/([A-Z])/g, ' $1').replace(/^./, function(s){return s.toUpperCase();});
                    formDataRows += '<tr><td style="padding:8px 12px;border:1px solid #ddd;font-weight:600;width:35%;background:#f8f9fa;">' + label + '</td><td style="padding:8px 12px;border:1px solid #ddd;">' + e[1] + '</td></tr>';
                });
            }

            var sigDate = app.signature_timestamp ? new Date(app.signature_timestamp).toLocaleString('en-US', {
                year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',timeZoneName:'short'
            }) : 'N/A';

            var summaryHtml = '<!DOCTYPE html><html><head><title>Lender Package - ' + (app.application_id || '') + '</title>' +
                '<style>' +
                'body{font-family:Arial,Helvetica,sans-serif;margin:40px;color:#333;line-height:1.6}' +
                '.header{text-align:center;border-bottom:3px solid #1a365d;padding-bottom:20px;margin-bottom:30px}' +
                '.header h1{color:#1a365d;margin:0;font-size:24px}' +
                '.header p{color:#666;margin:5px 0 0}' +
                '.section{margin-bottom:25px}' +
                '.section h2{color:#1a365d;font-size:16px;border-bottom:2px solid #e2e8f0;padding-bottom:8px;margin-bottom:12px}' +
                'table{width:100%;border-collapse:collapse;margin-bottom:15px}' +
                'td{padding:8px 12px;border:1px solid #ddd;font-size:13px}' +
                '.signature-box{background:#f0f7ff;border:2px solid #1a365d;border-radius:8px;padding:20px;margin-top:20px}' +
                '.signature-box .sig-name{font-size:22px;font-style:italic;font-weight:700;color:#1a365d;margin:10px 0}' +
                '.signature-box .sig-meta{font-size:12px;color:#64748b}' +
                '.consent-text{font-size:11px;color:#666;margin-top:15px;padding:15px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:6px;line-height:1.5}' +
                '.footer{margin-top:40px;text-align:center;font-size:11px;color:#999;border-top:1px solid #e2e8f0;padding-top:15px}' +
                '@media print{body{margin:20px}}' +
                '</style></head><body>' +
                '<div class="header">' +
                '<h1>Alliance Financing Group Ltd.</h1>' +
                '<p>35+ Years of Commercial Financing Excellence</p>' +
                '<p style="font-size:12px;color:#999">1-877-660-3660 ext. 222 | info@alliancefinancing.ai | alliancefinancing.ai</p>' +
                '</div>' +
                '<div style="text-align:center;margin-bottom:25px">' +
                '<h2 style="color:#1a365d;font-size:20px;margin:0">Credit Application ‚Äî ' + formTypeDisplay + '</h2>' +
                '<p style="color:#666;margin:5px 0">Application ID: <strong>' + (app.application_id || 'N/A') + '</strong> | Submitted: <strong>' + (app.submitted_at ? new Date(app.submitted_at).toLocaleDateString('en-US', {year:'numeric',month:'long',day:'numeric'}) : 'N/A') + '</strong></p>' +
                '</div>' +
                '<div class="section"><h2>Applicant Summary</h2>' +
                '<table>' +
                '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Full Name</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.full_name || 'N/A') + '</td></tr>' +
                '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Business Name</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.business_name || 'N/A') + '</td></tr>' +
                '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Email</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.email || 'N/A') + '</td></tr>' +
                '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Phone</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.phone || 'N/A') + '</td></tr>' +
                '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Time in Business</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.time_in_business || 'N/A') + '</td></tr>' +
                '<tr><td style="font-weight:600;width:35%;background:#f8f9fa;border:1px solid #ddd;padding:8px 12px">Funding Requested</td><td style="border:1px solid #ddd;padding:8px 12px">' + (app.funding_amount_text || (app.funding_amount_requested ? '$' + Number(app.funding_amount_requested).toLocaleString() : 'N/A')) + '</td></tr>' +
                '</table></div>' +
                '<div class="section"><h2>Complete Application Details</h2>' +
                '<table>' + formDataRows + '</table></div>' +
                '<div class="section"><h2>Electronic Signature & Authorization</h2>' +
                '<div class="signature-box">' +
                '<p style="margin:0;font-size:13px;color:#64748b">The applicant has electronically signed this application:</p>' +
                '<div class="sig-name">"' + (app.signature_name || 'N/A') + '"</div>' +
                '<div class="sig-meta">Date & Time: ' + sigDate + '</div>' +
                '<div class="sig-meta">Application ID: ' + (app.application_id || 'N/A') + '</div>' +
                '<div class="sig-meta">IP-based electronic signature captured at time of submission</div>' +
                '</div>' +
                '<div class="consent-text">' +
                '<strong>Authorization Statement:</strong> The applicant confirmed that the information provided is true and complete, and authorized Alliance Financing Group Ltd. and its partners to obtain credit reports, verify business information with banks, processors, and third parties, and to use this information to evaluate the application. This electronic signature is legally binding under the <em>Personal Information Protection and Electronic Documents Act</em> (PIPEDA) and applicable provincial and state laws.' +
                '</div></div>';

            // --- Fetch and add supporting documents ---
            var docTypeLabels = {
                bank_statement:'Bank_Statement', processing_statement:'Processing_Statement',
                photo_id:'Photo_ID', void_cheque:'Void_Cheque', business_license:'Business_License',
                tax_return:'Tax_Return', financial_statements:'Financial_Statements',
                credit_report:'Credit_Report', equipment_quote:'Equipment_Quote',
                ap_ar_aging:'AP_AR_Aging', other:'Other'
            };

            var fileList = [];
            try {
                btn.textContent = '‚è≥ Fetching documents...';
                var { data: docs } = await db.from('documents').select('*').eq('application_id', app.id).order('uploaded_at', { ascending: false });
                if (docs && docs.length > 0) {
                    for (var di = 0; di < docs.length; di++) {
                        var doc = docs[di];
                        btn.textContent = '‚è≥ Downloading ' + (di + 1) + ' of ' + docs.length + '...';
                        try {
                            // Download the actual file blob
                            var { data: fileBlob, error: dlError } = await db.storage
                                .from('deal-documents')
                                .download(doc.file_path);
                            if (dlError) { console.warn('Could not download', doc.file_name, dlError); continue; }

                            // Create a clean filename with type prefix
                            var typePrefix = docTypeLabels[doc.document_type] || 'Document';
                            var cleanName = typePrefix + '_' + doc.file_name.replace(/[^a-zA-Z0-9._-]/g, '_');
                            docsFolder.file(cleanName, fileBlob);
                            fileList.push({ name: cleanName, type: doc.document_type, originalName: doc.file_name, size: doc.file_size_bytes });
                        } catch(e) { console.warn('Error downloading ' + doc.file_name + ':', e); }
                    }
                }
            } catch(e) { console.warn('Could not fetch documents:', e); }

            // Add document manifest to summary
            if (fileList.length > 0) {
                summaryHtml += '<div class="section"><h2>Supporting Documents (' + fileList.length + ' files included in this ZIP)</h2>' +
                    '<table><tr style="background:#f8f9fa"><td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">File Name in ZIP</td>' +
                    '<td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">Document Type</td>' +
                    '<td style="padding:8px 12px;border:1px solid #ddd;font-weight:600">Original File Name</td></tr>';
                fileList.forEach(function(f) {
                    var typeDisplay = f.type ? f.type.replace(/_/g, ' ').replace(/\b\w/g, function(l){return l.toUpperCase();}) : 'Other';
                    summaryHtml += '<tr><td style="padding:8px 12px;border:1px solid #ddd;">Supporting_Documents/' + f.name + '</td>' +
                        '<td style="padding:8px 12px;border:1px solid #ddd;">' + typeDisplay + '</td>' +
                        '<td style="padding:8px 12px;border:1px solid #ddd;">' + f.originalName + '</td></tr>';
                });
                summaryHtml += '</table>' +
                    '<p style="font-size:11px;color:#666;margin-top:8px">All supporting documents are included in the Supporting_Documents folder within this ZIP file.</p>' +
                    '</div>';
            } else {
                summaryHtml += '<div class="section"><h2>Supporting Documents</h2>' +
                    '<p style="color:#666">No supporting documents have been uploaded for this application yet.</p></div>';
            }

            summaryHtml += '<div class="footer">' +
                '<p>This document was generated by Alliance Financing Group Ltd. ‚Äî Confidential Lender Package</p>' +
                '<p>Generated on: ' + new Date().toLocaleString() + '</p>' +
                '</div></body></html>';

            // Add summary to ZIP
            zip.file('Application_Summary_' + (app.application_id || 'unknown') + '.html', summaryHtml);

            // Generate and download ZIP
            btn.textContent = '‚è≥ Creating ZIP file...';
            var content = await zip.generateAsync({ type: 'blob' });
            var zipName = 'Lender_Package_' + (app.application_id || 'unknown') + '_' + new Date().toISOString().split('T')[0] + '.zip';
            saveAs(content, zipName);

            btn.disabled = false;
            btn.textContent = origText;

        } catch (error) {
            console.error('ZIP generation error:', error);
            alert('Error creating ZIP package: ' + (error.message || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = origText;
        }
    }

    function closeApplicationModal() {
        document.getElementById('applicationModal').classList.remove('active');
    }

    // ============================================
    // Send Application Form
    // ============================================
    var selectedSendAppType = null;

    function openSendApplicationModal() {
        selectedSendAppType = null;
        document.getElementById('sendAppLinkSection').style.display = 'none';
        ['sendAppLeasing', 'sendAppMca', 'sendAppWc'].forEach(function(id) {
            document.getElementById(id).style.borderColor = '#E2E8F0';
            document.getElementById(id).style.background = 'white';
        });
        document.getElementById('sendAppClientEmail').value = '';
        document.getElementById('sendAppClientName').value = '';
        document.getElementById('sendApplicationModal').classList.add('active');
    }

    function closeSendApplicationModal() {
        document.getElementById('sendApplicationModal').classList.remove('active');
    }

    function selectSendAppType(type) {
        selectedSendAppType = type;
        var baseUrl = window.location.origin;
        var formUrls = {
            leasing: baseUrl + '/apply-leasing.html',
            mca: baseUrl + '/apply-merchant-advance.html',
            wc: baseUrl + '/apply-working-capital.html'
        };

        // Highlight selected card
        var cardMap = { leasing: 'sendAppLeasing', mca: 'sendAppMca', wc: 'sendAppWc' };
        Object.keys(cardMap).forEach(function(key) {
            var el = document.getElementById(cardMap[key]);
            if (key === type) {
                el.style.borderColor = 'var(--gold)';
                el.style.background = '#FFFBEB';
            } else {
                el.style.borderColor = '#E2E8F0';
                el.style.background = 'white';
            }
        });

        document.getElementById('sendAppLinkUrl').value = formUrls[type];
        document.getElementById('sendAppLinkSection').style.display = 'block';
    }

    function copySendAppLink() {
        var input = document.getElementById('sendAppLinkUrl');
        navigator.clipboard.writeText(input.value).then(function() {
            var btn = event.target;
            btn.textContent = 'Copied!';
            btn.style.background = '#10B981';
            setTimeout(function() { btn.textContent = 'Copy Link'; btn.style.background = ''; }, 2000);
        });
    }

    function emailSendAppLink() {
        var email = document.getElementById('sendAppClientEmail').value.trim();
        var clientName = document.getElementById('sendAppClientName').value.trim() || 'there';
        var link = document.getElementById('sendAppLinkUrl').value;

        if (!email) { alert('Please enter the client\'s email address.'); return; }
        if (!selectedSendAppType) { alert('Please select an application type first.'); return; }

        var typeNames = { leasing: 'Equipment Leasing', mca: 'Merchant Cash Advance', wc: 'Working Capital & Factoring' };
        var typeName = typeNames[selectedSendAppType];

        var subject = encodeURIComponent('Alliance Financing - ' + typeName + ' Application');
        var body = encodeURIComponent(
            'Hi ' + clientName + ',\n\n' +
            'Thank you for your interest in financing with Alliance Financing Group.\n\n' +
            'Please complete our ' + typeName + ' application at the link below:\n\n' +
            link + '\n\n' +
            'If you have any questions, please don\'t hesitate to reach out.\n\n' +
            'Best regards,\n' +
            'Alliance Financing Group Ltd.\n' +
            '1-877-660-3660 ext. 222\n' +
            'info@alliancefinancing.ai'
        );

        window.open('mailto:' + email + '?subject=' + subject + '&body=' + body);
    }

    // ============================================
    // Document Management
    // ============================================
    var currentDocUploadDealId = null;
    var currentDocUploadApplicationId = null;

    function showDocumentUploadModal(dealId, applicationId) {
        if (!['super_admin', 'admin'].includes(currentUserRole)) { alert('Document management is restricted to administrators.'); return; }
        currentDocUploadDealId = dealId;
        currentDocUploadApplicationId = applicationId;
        document.getElementById('docTypeSelect').value = '';
        document.getElementById('docFileInput').value = '';
        document.getElementById('docNotesInput').value = '';
        document.getElementById('docUploadProgress').style.display = 'none';
        document.getElementById('docUploadBtn').disabled = false;
        document.getElementById('docUploadBtn').textContent = 'Upload Document';
        document.getElementById('documentUploadModal').classList.add('active');
    }

    function closeDocumentUploadModal() {
        document.getElementById('documentUploadModal').classList.remove('active');
        currentDocUploadDealId = null;
        currentDocUploadApplicationId = null;
    }

    async function uploadToStorage(bucketName, filePath, file) {
        // Direct REST API upload - bypasses JS client RLS issues
        var url = SUPABASE_URL + '/storage/v1/object/' + bucketName + '/' + filePath;
        var response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                'apikey': SUPABASE_ANON_KEY,
                'x-upsert': 'true'
            },
            body: file
        });
        if (!response.ok) {
            var errBody = await response.json().catch(function() { return { error: response.statusText }; });
            throw new Error(errBody.message || errBody.error || 'Upload failed (' + response.status + ')');
        }
        return await response.json();
    }

    async function submitDocumentUpload() {
        var docType = document.getElementById('docTypeSelect').value;
        var fileInput = document.getElementById('docFileInput');
        var notes = document.getElementById('docNotesInput').value;
        var file = fileInput.files[0];

        if (!docType) { alert('Please select a document type.'); return; }
        if (!file) { alert('Please select a file to upload.'); return; }
        if (file.size > 10 * 1024 * 1024) { alert('File exceeds 10MB limit.'); return; }

        var btn = document.getElementById('docUploadBtn');
        btn.disabled = true;
        btn.textContent = 'Uploading...';
        document.getElementById('docUploadProgress').style.display = 'block';
        document.getElementById('docUploadProgressBar').style.width = '30%';

        try {
            var folder = currentDocUploadDealId ? 'deals/' + currentDocUploadDealId : 'applications/' + currentDocUploadApplicationId;
            var filePath = folder + '/' + Date.now() + '-' + file.name.replace(/[^a-zA-Z0-9._-]/g, '_');

            await uploadToStorage('deal-documents', filePath, file);

            document.getElementById('docUploadProgressBar').style.width = '70%';

            var docRecord = {
                file_name: file.name,
                file_path: filePath,
                file_type: file.type,
                file_size_bytes: file.size,
                document_type: docType,
                notes: notes || null,
                uploaded_by: currentUserId,
                uploaded_by_name: currentUserName || 'Admin'
            };
            if (currentDocUploadDealId) docRecord.deal_id = currentDocUploadDealId;
            if (currentDocUploadApplicationId) docRecord.application_id = currentDocUploadApplicationId;

            var { error: docError } = await db.from('documents').insert([docRecord]);
            if (docError) {
                alert('DOCUMENTS TABLE insert failed: ' + docError.message);
                throw docError;
            }

            document.getElementById('docUploadProgressBar').style.width = '100%';
            document.getElementById('docUploadProgressText').textContent = 'Upload complete!';

            var refreshDealId = currentDocUploadDealId;
            var refreshAppId = currentDocUploadApplicationId;
            setTimeout(function() {
                closeDocumentUploadModal();
                if (refreshDealId) viewDeal(refreshDealId);
                else if (refreshAppId) viewApplication(refreshAppId);
            }, 500);

        } catch (error) {
            console.error('Document upload error:', error);
            alert('Error uploading document: ' + (error.message || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Upload Document';
            document.getElementById('docUploadProgress').style.display = 'none';
        }
    }

    async function downloadDocument(filePath, fileName) {
        try {
            var { data, error } = await db.storage
                .from('deal-documents')
                .createSignedUrl(filePath, 604800);
            if (error) throw error;
            window.open(data.signedUrl, '_blank');
        } catch (error) {
            console.error('Download error:', error);
            alert('Error downloading document: ' + (error.message || 'Unknown error'));
        }
    }

    async function deleteDocument(docId, filePath, parentDealId, parentAppId) {
        if (!confirm('Are you sure you want to delete this document? This cannot be undone.')) return;
        try {
            await db.storage.from('deal-documents').remove([filePath]);
            var { error } = await db.from('documents').delete().eq('id', docId);
            if (error) throw error;
            alert('Document deleted.');
            if (parentDealId) viewDeal(parentDealId);
            else if (parentAppId) viewApplication(parentAppId);
        } catch (error) {
            console.error('Delete document error:', error);
            alert('Error deleting document: ' + (error.message || 'Unknown error'));
        }
    }

    function buildDocumentsHtml(documents, parentDealId, parentAppId) {
        // Compliance: Only super_admin and admin can see sensitive documents
        if (!['super_admin', 'admin'].includes(currentUserRole)) return '';

        var docTypeLabels = {
            bank_statement: 'Bank Statement', processing_statement: 'Processing Statement',
            photo_id: 'Photo ID', void_cheque: 'Void Cheque', business_license: 'Business License',
            tax_return: 'Tax Return', financial_statements: 'Financial Statements',
            credit_report: 'Credit Report', equipment_quote: 'Equipment Quote / Invoice',
            ap_ar_aging: 'AP / AR Aging Report', supporting_document: 'Supporting Document', other: 'Other'
        };

        var addBtnHtml = ['super_admin', 'admin'].includes(currentUserRole)
            ? '<button class="btn btn-secondary btn-sm" onclick="showDocumentUploadModal(' +
              (parentDealId ? "'" + parentDealId + "'" : 'null') + ', ' +
              (parentAppId ? "'" + parentAppId + "'" : 'null') +
              ')" style="padding: 4px 12px; font-size: 12px;">+ Add Document</button>'
            : '';

        var docsRows = '';
        if (documents && documents.length > 0) {
            docsRows = documents.map(function(doc) {
                var typeLabel = docTypeLabels[doc.document_type] || doc.document_type || 'Other';
                var sizeMB = doc.file_size_bytes ? (doc.file_size_bytes / 1024 / 1024).toFixed(2) + ' MB' : '';
                var uploaded = doc.uploaded_at ? new Date(doc.uploaded_at).toLocaleDateString() : '';
                var uploader = doc.uploaded_by_name || 'Unknown';
                var deleteBtn = ['super_admin', 'admin'].includes(currentUserRole)
                    ? '<button onclick="deleteDocument(\'' + doc.id + '\', \'' + doc.file_path + '\', ' +
                      (parentDealId ? "'" + parentDealId + "'" : 'null') + ', ' +
                      (parentAppId ? "'" + parentAppId + "'" : 'null') +
                      ')" style="padding:4px 10px;background:#FEE2E2;color:#DC2626;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Delete</button>'
                    : '';
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#F8FAFC;border:1px solid #E2E8F0;border-radius:6px;margin-bottom:8px;">' +
                    '<div style="flex:1">' +
                    '<div style="font-weight:600;font-size:13px;color:var(--navy);">' + doc.file_name + '</div>' +
                    '<div style="font-size:11px;color:#64748b;margin-top:3px;">' +
                    '<span style="background:#EFF6FF;color:#3B82F6;padding:1px 6px;border-radius:8px;font-weight:600;margin-right:6px;">' + typeLabel + '</span>' +
                    sizeMB + (uploaded ? ' ‚Ä¢ ' + uploaded : '') + ' ‚Ä¢ by ' + uploader +
                    (doc.notes ? ' ‚Ä¢ <em>' + doc.notes + '</em>' : '') +
                    '</div></div>' +
                    '<div style="display:flex;gap:6px;margin-left:10px;flex-shrink:0;">' +
                    '<button onclick="downloadDocument(\'' + doc.file_path + '\', \'' + doc.file_name + '\')" style="padding:4px 10px;background:#3B82F6;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;">Download</button>' +
                    deleteBtn +
                    '</div></div>';
            }).join('');
        } else {
            docsRows = '<p style="color:#999;font-size:13px;">No documents attached yet.</p>';
        }

        return '<div style="margin-top:20px;border-top:2px solid var(--border-gray);padding-top:15px;">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">' +
            '<label style="font-size:15px;font-weight:600;color:var(--navy);">Documents (' + (documents ? documents.length : 0) + ')</label>' +
            addBtnHtml +
            '</div>' + docsRows + '</div>';
    }

    // ============================================
    // Contact Management
    // ============================================

    async function viewContact(contactId) {
        try {
            const { data: contact, error } = await db
                .from('contact_submissions')
                .select('*')
                .eq('id', contactId)
                .single();

            if (error) throw error;

            // Mark as read
            if (!contact.is_read) {
                await db
                    .from('contact_submissions')
                    .update({ is_read: true })
                    .eq('id', contactId);
            }

            // Parse existing notes (stored as JSON array in admin_notes column)
            let notes = [];
            try {
                notes = contact.admin_notes ? JSON.parse(contact.admin_notes) : [];
            } catch(e) {
                notes = contact.admin_notes ? [{ text: contact.admin_notes, author: 'System', date: 'Previously' }] : [];
            }

            const notesHtml = notes.length > 0
                ? notes.map(n => `
                    <div style="background: #F8FAFC; border-left: 3px solid var(--gold); padding: 10px 12px; margin-bottom: 8px; border-radius: 0 4px 4px 0;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 4px;">
                            <strong>${n.author || 'Admin'}</strong> ‚Äî ${n.date || 'N/A'}
                        </div>
                        <div style="font-size: 14px; color: var(--text-dark);">${n.text}</div>
                    </div>
                `).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No notes yet.</p>';

            const contactStatusOptions = ['New', 'In Progress', 'Responded', 'Closed'].map(s =>
                `<option value="${s}" ${(contact.status || 'New') === s ? 'selected' : ''}>${s}</option>`
            ).join('');

            const modalBody = document.getElementById('contactModalBody');
            modalBody.innerHTML = `
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Name</label>
                        <div class="modal-field-value">${contact.name || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Email</label>
                        <div class="modal-field-value"><a href="mailto:${contact.email}">${contact.email || 'N/A'}</a></div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Phone</label>
                        <div class="modal-field-value">${contact.phone || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Submitted</label>
                        <div class="modal-field-value">${formatDate(contact.submitted_at)}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Subject</label>
                        <div class="modal-field-value">${contact.subject || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <div class="modal-field-value">
                            <select id="contactStatusSelect" onchange="updateContactStatus('${contactId}', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                                ${contactStatusOptions}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-row full">
                    <div class="modal-field">
                        <label>Message</label>
                        <div class="modal-field-value">${contact.message || 'No message'}</div>
                    </div>
                </div>
                <div class="modal-row full" style="margin-top: 10px;">
                    <div class="modal-field">
                        <label style="font-size: 15px; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px;">Activity Notes</label>
                        <div id="notesContainer">${notesHtml}</div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <textarea id="newNoteText" placeholder="Add a note..." style="flex: 1; min-height: 60px; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        <button class="btn btn-gold btn-sm" onclick="addContactNote('${contactId}')" style="margin-top: 8px;">Add Note</button>
                    </div>
                </div>
            `;

            document.getElementById('contactModal').classList.add('active');
            await loadContacts();
        } catch (error) {
            console.error('View contact error:', error);
            alert('Error loading contact details');
        }
    }

    async function addContactNote(contactId) {
        const noteText = document.getElementById('newNoteText').value.trim();
        if (!noteText) return;

        try {
            // Get current notes
            const { data: contact } = await db
                .from('contact_submissions')
                .select('admin_notes')
                .eq('id', contactId)
                .single();

            let notes = [];
            try {
                notes = contact.admin_notes ? JSON.parse(contact.admin_notes) : [];
            } catch(e) {
                notes = [];
            }

            // Add new note with timestamp
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;

            notes.push({
                text: noteText,
                author: userEmail,
                date: dateStr
            });

            // Save back
            const { error } = await db
                .from('contact_submissions')
                .update({ admin_notes: JSON.stringify(notes) })
                .eq('id', contactId);

            if (error) throw error;

            // Refresh the modal
            await viewContact(contactId);
        } catch (error) {
            console.error('Add note error:', error);
            alert('Error adding note: ' + error.message);
        }
    }

    async function updateContactStatus(contactId, newStatus) {
        try {
            // Get current contact to read existing notes
            const { data: contact } = await db
                .from('contact_submissions')
                .select('admin_notes, status')
                .eq('id', contactId)
                .single();

            const oldStatus = contact.status || 'New';

            // Parse existing notes
            let notes = [];
            try {
                notes = contact.admin_notes ? JSON.parse(contact.admin_notes) : [];
            } catch(e) {
                notes = [];
            }

            // Add status change note
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;

            notes.push({
                text: `Status changed from "${oldStatus}" to "${newStatus}"`,
                author: userEmail,
                date: dateStr
            });

            // Update status and notes together
            const { error } = await db
                .from('contact_submissions')
                .update({ status: newStatus, admin_notes: JSON.stringify(notes) })
                .eq('id', contactId);

            if (error) throw error;

            // Refresh both the list and the modal
            await loadContacts();
            await viewContact(contactId);
        } catch (error) {
            console.error('Update contact status error:', error);
            alert('Error updating status: ' + error.message);
        }
    }

    function closeContactModal() {
        document.getElementById('contactModal').classList.remove('active');
    }

    // ============================================
    // Agent Management
    // ============================================

    function openAddAgentModal() {
        document.getElementById('addAgentForm').reset();
        document.getElementById('agentSlug').value = '';
        document.getElementById('addAgentModal').classList.add('active');
    }

    function closeAddAgentModal() {
        document.getElementById('addAgentModal').classList.remove('active');
    }

    // Auto-generate referral slug from name
    document.addEventListener('input', function(e) {
        if (e.target.id === 'agentName') {
            const name = e.target.value.trim();
            const slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            document.getElementById('agentSlug').value = slug;
        }
    });

    async function handleAddAgent(event) {
        event.preventDefault();

        try {
            const referralSlug = document.getElementById('agentSlug').value;
            if (!referralSlug) {
                alert('Please enter an agent name to generate the referral slug');
                return;
            }

            const { data, error } = await db
                .from('users')
                .insert([{
                    full_name: document.getElementById('agentName').value,
                    email: document.getElementById('agentEmail').value,
                    phone: document.getElementById('agentPhone').value || null,
                    role: 'agent',
                    business_type: document.getElementById('agentBusinessType').value || null,
                    referral_slug: referralSlug,
                    status: document.getElementById('agentStatus').value || null,
                    created_at: new Date().toISOString()
                }])
                .select();

            if (error) throw error;

            closeAddAgentModal();
            await loadAgents();
            alert('Agent created successfully!');
        } catch (error) {
            console.error('Add agent error:', error);
            alert('Error creating agent: ' + error.message);
        }
    }

    // ============================================
    // Agent Detail View
    // ============================================

    async function viewAgent(agentId) {
        try {
            const { data: agent, error } = await db
                .from('users')
                .select('*')
                .eq('id', agentId)
                .single();

            if (error) throw error;
            if (!agent) { alert('Agent not found'); return; }

            // Get agent's deals
            const { data: deals } = await db
                .from('deals')
                .select('deal_number, company_name, deal_amount, status')
                .eq('source_agent_id', agentId);

            // Get agent's referral applications
            const { data: apps } = await db
                .from('applications')
                .select('application_id, full_name, business_name, status, funding_amount_text')
                .eq('referral_slug', agent.referral_slug);

            // Parse notes
            let notes = [];
            try {
                notes = agent.notes ? JSON.parse(agent.notes) : [];
            } catch(e) {
                notes = agent.notes ? [{ text: agent.notes, author: 'System', date: 'Previously' }] : [];
            }

            const notesHtml = notes.length > 0
                ? notes.map(n => `
                    <div style="background: #F8FAFC; border-left: 3px solid var(--gold); padding: 10px 12px; margin-bottom: 8px; border-radius: 0 4px 4px 0;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 4px;">
                            <strong>${n.author || 'Admin'}</strong> ‚Äî ${n.date || 'N/A'}
                        </div>
                        <div style="font-size: 14px; color: var(--text-dark);">${n.text}</div>
                    </div>
                `).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No notes yet.</p>';

            // Deals summary
            const dealsHtml = deals && deals.length > 0
                ? deals.map(d => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-gray); font-size: 13px;">
                        <span><strong>${d.deal_number || 'N/A'}</strong> ‚Äî ${d.company_name || 'N/A'}</span>
                        <span>${getStatusBadge(d.status)} ${d.deal_amount ? formatCurrency(d.deal_amount) : ''}</span>
                    </div>
                `).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No deals yet.</p>';

            // Applications summary
            const appsHtml = apps && apps.length > 0
                ? apps.map(a => `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-gray); font-size: 13px;">
                        <span><strong>${a.application_id || 'N/A'}</strong> ‚Äî ${a.full_name || 'N/A'} (${a.business_name || 'N/A'})</span>
                        <span>${getStatusBadge(a.status)} ${a.funding_amount_text || ''}</span>
                    </div>
                `).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No referral applications yet.</p>';

            const statusOptions = 'AIA,MOU,Active,Inactive,Pending'.split(',').map(s =>
                `<option value="${s}" ${(agent.agent_status || '') === s ? 'selected' : ''}>${s}</option>`
            ).join('');

            const businessTypeOptions = 'Mortgage Agent,Mortgage Broker,Insurance,Consulting,Accounting,Other'.split(',').map(s =>
                `<option value="${s}" ${(agent.business_type || '') === s ? 'selected' : ''}>${s}</option>`
            ).join('');

            // Build parent agent options (exclude self)
            if (cachedAgents.length === 0) {
                const { data: agts } = await db.from('users').select('id, full_name, email').eq('role', 'agent');
                cachedAgents = agts || [];
            }
            const parentAgentOptions = cachedAgents
                .filter(a => a.id !== agentId)
                .map(a => `<option value="${a.id}" ${agent.parent_agent_id === a.id ? 'selected' : ''}>${a.full_name || a.email}</option>`)
                .join('');

            // Get sub-agents count
            const subAgents = cachedAgents.filter(a => a.parent_agent_id === agentId);

            document.getElementById('agentDetailTitle').textContent = agent.full_name || 'Agent Details';
            const modalBody = document.getElementById('agentModalBody');
            modalBody.innerHTML = `
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Full Name</label>
                        <div class="modal-field-value">${agent.full_name || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Email</label>
                        <div class="modal-field-value"><a href="mailto:${agent.email}">${agent.email || 'N/A'}</a></div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Phone</label>
                        <div class="modal-field-value">${agent.phone || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Referral Slug</label>
                        <div class="modal-field-value" style="font-family: monospace;">${agent.referral_slug || 'N/A'}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Status</label>
                        <div class="modal-field-value">
                            <select onchange="updateAgentField('${agentId}', 'agent_status', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                                <option value="">Select Status</option>
                                ${statusOptions}
                            </select>
                        </div>
                    </div>
                    <div class="modal-field">
                        <label>Business Type</label>
                        <div class="modal-field-value">
                            <select onchange="updateAgentField('${agentId}', 'business_type', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                                <option value="">Select Type</option>
                                ${businessTypeOptions}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Parent Agent</label>
                        <div class="modal-field-value">
                            <select onchange="updateAgentField('${agentId}', 'parent_agent_id', this.value || null)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                                <option value="">No Parent (Top-Level)</option>
                                ${parentAgentOptions}
                            </select>
                        </div>
                    </div>
                    <div class="modal-field">
                        <label>Sub-Agents</label>
                        <div class="modal-field-value">${subAgents.length > 0 ? subAgents.map(s => s.full_name || s.email).join(', ') : 'None'}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>LinkedIn</label>
                        <div class="modal-field-value">${agent.linkedin_profile ? '<a href="' + agent.linkedin_profile + '" target="_blank">View Profile</a>' : 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Joined</label>
                        <div class="modal-field-value">${formatDate(agent.created_at)}</div>
                    </div>
                </div>

                <div style="border-top: 2px solid var(--border-gray); margin: 20px 0 15px; padding-top: 15px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy);">Referral Applications (${apps ? apps.length : 0})</label>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">${appsHtml}</div>

                <div style="border-top: 2px solid var(--border-gray); margin: 20px 0 15px; padding-top: 15px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy);">Deals (${deals ? deals.length : 0})</label>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">${dealsHtml}</div>

                <div style="border-top: 2px solid var(--border-gray); margin: 20px 0 15px; padding-top: 15px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy);">Activity Notes</label>
                </div>
                <div id="agentNotesContainer">${notesHtml}</div>
                <div style="margin-top: 12px; display: flex; gap: 8px;">
                    <textarea id="agentNoteText" placeholder="Add a note..." style="flex: 1; min-height: 60px; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                </div>
                <button class="btn btn-gold btn-sm" onclick="addAgentNote('${agentId}')" style="margin-top: 8px;">Add Note</button>
            `;

            document.getElementById('agentDetailModal').classList.add('active');
        } catch (error) {
            console.error('View agent error:', error);
            alert('Error loading agent details');
        }
    }

    function closeAgentDetailModal() {
        document.getElementById('agentDetailModal').classList.remove('active');
    }

    async function updateAgentStatus(agentId, newStatus) {
        try {
            const { error } = await db
                .from('users')
                .update({ agent_status: newStatus })
                .eq('id', agentId);
            if (error) throw error;
        } catch (error) {
            console.error('Update agent status error:', error);
            alert('Error updating status: ' + error.message);
        }
    }

    async function updateAgentField(agentId, field, value) {
        try {
            const update = {};
            update[field] = value;
            const { error } = await db
                .from('users')
                .update(update)
                .eq('id', agentId);
            if (error) throw error;
            await loadAgents();
        } catch (error) {
            console.error('Update agent field error:', error);
            alert('Error updating: ' + error.message);
        }
    }

    async function addAgentNote(agentId) {
        const noteText = document.getElementById('agentNoteText').value.trim();
        if (!noteText) return;

        try {
            const { data: agent } = await db
                .from('users')
                .select('notes')
                .eq('id', agentId)
                .single();

            let notes = [];
            try {
                notes = agent.notes ? JSON.parse(agent.notes) : [];
            } catch(e) {
                notes = [];
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;

            notes.push({
                text: noteText,
                author: userEmail,
                date: dateStr
            });

            const { error } = await db
                .from('users')
                .update({ notes: JSON.stringify(notes) })
                .eq('id', agentId);

            if (error) throw error;
            await viewAgent(agentId);
        } catch (error) {
            console.error('Add agent note error:', error);
            alert('Error adding note: ' + error.message);
        }
    }

    // ============================================
    // Lender Management
    // ============================================

    function openAddLenderModal() {
        document.getElementById('addLenderForm').reset();
        document.getElementById('lenderExtraContacts').innerHTML = '';
        lenderContactCount = 1;
        document.getElementById('addLenderModal').classList.add('active');
    }

    function closeAddLenderModal() {
        document.getElementById('addLenderModal').classList.remove('active');
    }

    function addLenderContactField() {
        lenderContactCount++;
        const container = document.getElementById('lenderExtraContacts');
        const contactDiv = document.createElement('div');
        contactDiv.id = `lenderContact_${lenderContactCount}`;
        contactDiv.style.cssText = 'border-top: 1px solid var(--border-gray); margin-top: 15px; padding-top: 15px;';
        contactDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label style="font-size: 14px; font-weight: 500; color: var(--navy);">Contact ${lenderContactCount}</label>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeLenderContactField(${lenderContactCount})" style="padding: 4px 8px; font-size: 12px;">Remove</button>
            </div>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Contact Name</label>
                    <input type="text" class="lenderContact" data-contact-id="${lenderContactCount}" data-field="name">
                </div>
                <div class="modal-field">
                    <label>Contact Email</label>
                    <input type="email" class="lenderContact" data-contact-id="${lenderContactCount}" data-field="email">
                </div>
            </div>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Contact Phone</label>
                    <input type="tel" class="lenderContact" data-contact-id="${lenderContactCount}" data-field="phone">
                </div>
                <div class="modal-field">
                    <label>Contact Role/Title</label>
                    <input type="text" class="lenderContact" data-contact-id="${lenderContactCount}" data-field="role">
                </div>
            </div>
        `;
        container.appendChild(contactDiv);
    }

    function removeLenderContactField(contactId) {
        const contactDiv = document.getElementById(`lenderContact_${contactId}`);
        if (contactDiv) {
            contactDiv.remove();
        }
    }

    function addVendorContactField() {
        vendorContactCount++;
        const container = document.getElementById('vendorExtraContacts');
        const contactDiv = document.createElement('div');
        contactDiv.id = `vendorContact_${vendorContactCount}`;
        contactDiv.style.cssText = 'border-top: 1px solid var(--border-gray); margin-top: 15px; padding-top: 15px;';
        contactDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label style="font-size: 14px; font-weight: 500; color: var(--navy);">Contact ${vendorContactCount}</label>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeVendorContactField(${vendorContactCount})" style="padding: 4px 8px; font-size: 12px;">Remove</button>
            </div>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Contact Name</label>
                    <input type="text" class="vendorContact" data-contact-id="${vendorContactCount}" data-field="name">
                </div>
                <div class="modal-field">
                    <label>Contact Email</label>
                    <input type="email" class="vendorContact" data-contact-id="${vendorContactCount}" data-field="email">
                </div>
            </div>
            <div class="modal-row">
                <div class="modal-field">
                    <label>Contact Phone</label>
                    <input type="text" class="vendorContact" data-contact-id="${vendorContactCount}" data-field="phone">
                </div>
                <div class="modal-field">
                    <label>Contact Role/Title</label>
                    <input type="text" class="vendorContact" data-contact-id="${vendorContactCount}" data-field="role">
                </div>
            </div>
        `;
        container.appendChild(contactDiv);
    }

    function removeVendorContactField(contactId) {
        const contactDiv = document.getElementById(`vendorContact_${contactId}`);
        if (contactDiv) {
            contactDiv.remove();
        }
    }

    async function handleAddLender(event) {
        event.preventDefault();

        try {
            // Collect countries from checkboxes
            const countryCheckboxes = document.querySelectorAll('input[name="lenderCountries"]:checked');
            const countries = Array.from(countryCheckboxes).map(cb => cb.value).join(', ');

            const { data, error } = await db
                .from('lenders')
                .insert([{
                    name: document.getElementById('lenderName').value,
                    lender_id: document.getElementById('lenderId').value || null,
                    lender_type: document.getElementById('lenderType').value || null,
                    country: countries || null,
                    currency: document.getElementById('lenderCurrency').value || null,
                    status: document.getElementById('lenderStatus').value || null,
                    created_at: new Date().toISOString()
                }])
                .select();

            if (error) throw error;

            // Collect all contacts (primary + extra)
            const allContacts = [];

            // Primary contact
            const primaryName = document.getElementById('lenderContactName').value.trim();
            if (primaryName) {
                allContacts.push({
                    lender_id: data[0].id,
                    contact_name: primaryName,
                    email: document.getElementById('lenderContactEmail').value.trim() || null,
                    phone: document.getElementById('lenderContactPhone').value.trim() || null,
                    role_title: document.getElementById('lenderContactRole').value.trim() || null,
                    is_primary: true
                });
            }

            // Extra contacts
            for (let i = 2; i <= lenderContactCount; i++) {
                const nameInput = document.querySelector(`input[data-contact-id="${i}"][data-field="name"]`);
                if (nameInput && nameInput.value.trim()) {
                    const emailInput = document.querySelector(`input[data-contact-id="${i}"][data-field="email"]`);
                    const phoneInput = document.querySelector(`input[data-contact-id="${i}"][data-field="phone"]`);
                    const roleInput = document.querySelector(`input[data-contact-id="${i}"][data-field="role"]`);

                    allContacts.push({
                        lender_id: data[0].id,
                        contact_name: nameInput.value.trim(),
                        email: emailInput ? emailInput.value.trim() || null : null,
                        phone: phoneInput ? phoneInput.value.trim() || null : null,
                        role_title: roleInput ? roleInput.value.trim() || null : null,
                        is_primary: false
                    });
                }
            }

            // Insert all contacts
            if (allContacts.length > 0) {
                const { error: contactError } = await db
                    .from('lender_contacts')
                    .insert(allContacts);
                if (contactError) console.warn('Some contacts could not be saved:', contactError);
            }

            closeAddLenderModal();
            await loadLenders();
            alert('Lender created successfully!');
        } catch (error) {
            console.error('Add lender error:', error);
            alert('Error creating lender: ' + error.message);
        }
    }

    // ============================================
    // Vendor Management
    // ============================================

    function openAddVendorModal() {
        document.getElementById('addVendorForm').reset();
        document.getElementById('vendorExtraContacts').innerHTML = '';
        vendorContactCount = 1;
        document.getElementById('addVendorModal').classList.add('active');
    }

    function closeAddVendorModal() {
        document.getElementById('addVendorModal').classList.remove('active');
    }

    async function handleAddVendor(event) {
        event.preventDefault();

        try {
            // Collect countries from checkboxes
            const countryCheckboxes = document.querySelectorAll('input[name="vendorCountries"]:checked');
            const countries = Array.from(countryCheckboxes).map(cb => cb.value).join(', ');

            // First, insert vendor
            const { data: vendorData, error: vendorError } = await db
                .from('vendors')
                .insert([{
                    name: document.getElementById('vendorName').value,
                    website: document.getElementById('vendorWebsite').value || null,
                    product_description: document.getElementById('vendorProduct').value || null,
                    country: countries || null,
                    status: document.getElementById('vendorStatus').value || null,
                    created_at: new Date().toISOString()
                }])
                .select();

            if (vendorError) throw vendorError;

            // Collect all contacts (primary + extra)
            const allContacts = [];

            // Primary contact
            const primaryName = document.getElementById('vendorContactName').value.trim();
            if (primaryName && vendorData && vendorData.length > 0) {
                allContacts.push({
                    vendor_id: vendorData[0].id,
                    contact_name: primaryName,
                    email: document.getElementById('vendorContactEmail').value.trim() || null,
                    phone: document.getElementById('vendorContactPhone').value.trim() || null,
                    role_title: document.getElementById('vendorContactRole').value.trim() || null,
                    created_at: new Date().toISOString()
                });
            }

            // Extra contacts
            for (let i = 2; i <= vendorContactCount; i++) {
                const nameInput = document.querySelector(`input[data-contact-id="${i}"][data-field="name"]`);
                if (nameInput && nameInput.value.trim()) {
                    const emailInput = document.querySelector(`input[data-contact-id="${i}"][data-field="email"]`);
                    const phoneInput = document.querySelector(`input[data-contact-id="${i}"][data-field="phone"]`);
                    const roleInput = document.querySelector(`input[data-contact-id="${i}"][data-field="role"]`);

                    allContacts.push({
                        vendor_id: vendorData[0].id,
                        contact_name: nameInput.value.trim(),
                        email: emailInput ? emailInput.value.trim() || null : null,
                        phone: phoneInput ? phoneInput.value.trim() || null : null,
                        role_title: roleInput ? roleInput.value.trim() || null : null,
                        created_at: new Date().toISOString()
                    });
                }
            }

            // Insert all contacts
            if (allContacts.length > 0) {
                const { error: contactError } = await db
                    .from('vendor_contacts')
                    .insert(allContacts);
                if (contactError) {
                    console.warn('Warning: Vendor created but some contacts could not be added:', contactError);
                }
            }

            closeAddVendorModal();
            await loadVendors();
            alert('Vendor created successfully!');
        } catch (error) {
            console.error('Add vendor error:', error);
            alert('Error creating vendor: ' + error.message);
        }
    }

    // ============================================
    // Vendor Detail View
    // ============================================

    async function viewVendor(vendorId) {
        try {
            // Ensure agents are cached for source agent dropdown
            if (cachedAgents.length === 0) {
                const { data: agts } = await db.from('users').select('id, full_name, email').eq('role', 'agent');
                cachedAgents = agts || [];
            }
            // Fetch vendor details
            const { data: vendor, error: vendorError } = await db
                .from('vendors')
                .select('*')
                .eq('id', vendorId)
                .single();

            if (vendorError) throw vendorError;
            if (!vendor) { alert('Vendor not found'); return; }

            // Fetch vendor contacts
            const { data: contacts, error: contactsError } = await db
                .from('vendor_contacts')
                .select('*')
                .eq('vendor_id', vendorId);

            if (contactsError) console.warn('Could not load contacts:', contactsError);

            // Fetch deals linked to this vendor's salespeople
            let spDeals = [];
            try {
                const { data: spd } = await db.from('deals').select('id, company_name, deal_amount, status, vendor_salesperson_id').eq('source_vendor_id', vendorId);
                spDeals = spd || [];
            } catch(e) { console.warn('Could not load vendor deals:', e); }

            // Build salesperson deal stats lookup
            const spDealStats = {};
            spDeals.forEach(d => {
                const spId = d.vendor_salesperson_id || '_unassigned';
                if (!spDealStats[spId]) spDealStats[spId] = { count: 0, volume: 0, funded: 0, fundedVol: 0 };
                spDealStats[spId].count++;
                spDealStats[spId].volume += (d.deal_amount || 0);
                if (d.status === 'Funded' || d.status === 'Closed') {
                    spDealStats[spId].funded++;
                    spDealStats[spId].fundedVol += (d.deal_amount || 0);
                }
            });

            // Parse admin notes
            let notes = [];
            try {
                notes = vendor.admin_notes ? JSON.parse(vendor.admin_notes) : [];
            } catch(e) {
                notes = vendor.admin_notes ? [{ text: vendor.admin_notes, author: 'System', date: 'Previously' }] : [];
            }

            const notesHtml = notes.length > 0
                ? notes.map(n => `
                    <div style="background: #F8FAFC; border-left: 3px solid var(--gold); padding: 10px 12px; margin-bottom: 8px; border-radius: 0 4px 4px 0;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 4px;">
                            <strong>${n.author || 'Admin'}</strong> ‚Äî ${n.date || 'N/A'}
                        </div>
                        <div style="font-size: 14px; color: var(--text-dark);">${n.text}</div>
                    </div>
                `).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No notes yet.</p>';

            // Build contacts HTML with per-contact notes, edit, status, delete
            const contactsHtml = (contacts && contacts.length > 0)
                ? contacts.map(c => {
                    let cNotes = [];
                    try { cNotes = c.notes ? JSON.parse(c.notes) : []; } catch(e) { cNotes = []; }
                    const cNotesHtml = cNotes.length > 0
                        ? cNotes.map(n => `
                            <div style="background: white; border-left: 3px solid var(--gold); padding: 8px 10px; margin-bottom: 6px; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 3px;"><strong>${n.author || 'Admin'}</strong> ‚Äî ${n.date || 'N/A'}</div>
                                <div style="font-size: 13px; color: var(--text-dark);">${n.text}</div>
                            </div>
                        `).join('')
                        : '<p style="color: var(--text-light); font-size: 12px; margin: 4px 0;">No notes for this contact yet.</p>';
                    const statusColor = (c.status === 'Left Company') ? 'var(--danger)' : (c.status === 'Inactive') ? 'var(--warning)' : 'var(--success)';
                    const contactStatus = c.status || 'Active';
                    return `
                    <div class="vendor-contact-card" style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 10px; border: 1px solid var(--border-gray); ${contactStatus === 'Left Company' ? 'opacity: 0.65;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div id="vendorContactDisplay_${c.id}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 600; color: var(--navy);">${c.contact_name || 'N/A'}</span>
                                    <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}; color: white;">${contactStatus}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-light); margin-top: 4px;">
                                    ${c.email ? `<div>Email: <a href="mailto:${c.email}">${c.email}</a></div>` : ''}
                                    ${c.phone ? `<div>Phone: ${c.phone}</div>` : ''}
                                    ${c.role_title ? `<div>Role: ${c.role_title}</div>` : ''}
                                </div>
                                ${(() => {
                                    const stats = spDealStats[c.id];
                                    if (!stats) return '<div style="font-size: 12px; color: #94a3b8; margin-top: 6px; font-style: italic;">No deals linked yet</div>';
                                    return '<div style="display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap;">' +
                                        '<div style="background: #EFF6FF; padding: 4px 10px; border-radius: 6px; font-size: 12px;"><strong style="color: #3B82F6;">' + stats.count + '</strong> <span style="color: #64748b;">Deals</span></div>' +
                                        '<div style="background: #F0FDF4; padding: 4px 10px; border-radius: 6px; font-size: 12px;"><strong style="color: #10B981;">' + stats.funded + '</strong> <span style="color: #64748b;">Funded</span></div>' +
                                        '<div style="background: #FFF7ED; padding: 4px 10px; border-radius: 6px; font-size: 12px;"><strong style="color: #F59E0B;">' + formatCurrency(stats.volume) + '</strong> <span style="color: #64748b;">Volume</span></div>' +
                                    '</div>';
                                })()}
                            </div>
                            <div id="vendorContactEdit_${c.id}" style="display: none; flex: 1;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <input type="text" id="editVCName_${c.id}" value="${(c.contact_name || '').replace(/"/g, '&quot;')}" placeholder="Name" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                    <input type="email" id="editVCEmail_${c.id}" value="${(c.email || '').replace(/"/g, '&quot;')}" placeholder="Email" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <input type="text" id="editVCPhone_${c.id}" value="${(c.phone || '').replace(/"/g, '&quot;')}" placeholder="Phone" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                    <input type="text" id="editVCRole_${c.id}" value="${(c.role_title || '').replace(/"/g, '&quot;')}" placeholder="Role/Title" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-gold btn-sm" onclick="saveVendorContact('${c.id}', '${vendorId}')" style="padding: 4px 12px; font-size: 12px;">Save</button>
                                    <button class="btn btn-secondary btn-sm" onclick="cancelEditVendorContact('${c.id}')" style="padding: 4px 12px; font-size: 12px;">Cancel</button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px; margin-left: 8px; flex-shrink: 0;">
                                <select onchange="updateVendorContactStatus('${c.id}', '${vendorId}', this.value)" style="padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 11px; cursor: pointer;">
                                    ${'Active,Inactive,Left Company'.split(',').map(s => `<option value="${s}" ${contactStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="toggleEditVendorContact('${c.id}')" style="padding: 3px 8px; font-size: 11px;" title="Edit">Edit</button>
                                <button class="btn btn-sm" onclick="deleteVendorContact('${c.id}', '${vendorId}', '${(c.contact_name || '').replace(/'/g, "\\'")}')" style="padding: 3px 8px; font-size: 11px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;" title="Delete">Del</button>
                                <button class="btn btn-secondary btn-sm" onclick="this.closest('.vendor-contact-card').querySelector('.contact-notes-section').style.display = this.closest('.vendor-contact-card').querySelector('.contact-notes-section').style.display === 'none' ? 'block' : 'none'" style="padding: 3px 8px; font-size: 11px; white-space: nowrap;">Notes (${cNotes.length})</button>
                            </div>
                        </div>
                        <div class="contact-notes-section" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-gray);">
                            <div id="vendorContactNotes_${c.id}">${cNotesHtml}</div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" id="vendorContactNoteInput_${c.id}" placeholder="Add note for ${c.contact_name}..." style="flex: 1; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <button class="btn btn-gold btn-sm" onclick="addVendorContactNote('${c.id}', '${vendorId}')" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">Add</button>
                            </div>
                        </div>
                    </div>
                `}).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No contacts yet.</p>';

            const modalBody = document.getElementById('vendorModalBody');
            document.getElementById('vendorDetailTitle').textContent = vendor.name || 'Vendor Details';

            modalBody.innerHTML = `
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Name</label>
                        <div class="modal-field-value">${vendor.name || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <div class="modal-field-value">
                            <select id="vendorDetailStatus" onchange="updateVendorStatus(${vendorId}, this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                                ${'Active,Inactive'.split(',').map(s => `<option value="${s}" ${(vendor.status || '') === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Website</label>
                        <div class="modal-field-value">
                            ${vendor.website ? `<a href="${vendor.website.startsWith('http') ? vendor.website : 'https://' + vendor.website}" target="_blank">${vendor.website}</a>` : 'N/A'}
                        </div>
                    </div>
                    <div class="modal-field">
                        <label>Countries</label>
                        <div class="modal-field-value">
                            ${(() => {
                                const countries = ['Canada', 'United States', 'UK', 'Germany'];
                                const currentCountries = (vendor.country || '').split(',').map(c => c.trim()).filter(c => c);
                                return `<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                    ${countries.map(country => `
                                        <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                            <input type="checkbox" name="vendorDetailCountries" value="${country}" ${currentCountries.includes(country) ? 'checked' : ''} onchange="updateVendorCountries('${vendorId}')"> ${country}
                                        </label>
                                    `).join('')}
                                </div>`;
                            })()}
                        </div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field" style="flex: 2;">
                        <label>Product Description</label>
                        <div class="modal-field-value">${vendor.product_description || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Source Agent</label>
                        <select onchange="updateVendorField('${vendorId}', 'source_agent_id', this.value || null)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer; width: 100%;">
                            <option value="">No Agent</option>
                            ${cachedAgents.map(a => '<option value="' + a.id + '"' + (vendor.source_agent_id === a.id ? ' selected' : '') + '>' + (a.full_name || a.email) + '</option>').join('')}
                        </select>
                    </div>
                </div>
                <div style="border-top: 2px solid var(--border-gray); margin: 20px 0 15px; padding-top: 15px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy);">Funding Performance</label>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Projected Annual Volume</label>
                        <input type="text" id="vendorProjectedVolume" value="${vendor.projected_volume || ''}"
                            onblur="updateVendorField('${vendorId}', 'projected_volume', this.value ? parseFloat(this.value.replace(/[^0-9.]/g, '')) : null)"
                            style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                    </div>
                    <div class="modal-field">
                        <label>Actual Volume (YTD)</label>
                        <input type="text" id="vendorActualVolume" value="${vendor.actual_volume || ''}"
                            onblur="updateVendorField('${vendorId}', 'actual_volume', this.value ? parseFloat(this.value.replace(/[^0-9.]/g, '')) : null)"
                            style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                    </div>
                </div>
                ${(() => {
                    const pct = vendor.projected_volume && vendor.actual_volume
                        ? Math.round((vendor.actual_volume / vendor.projected_volume) * 100)
                        : 0;
                    const pctDisplay = pct > 0 ? pct + '%' : 'N/A';
                    const pctColor = pct >= 100 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)';
                    return `
                    <div class="modal-row">
                        <div class="modal-field">
                            <label>Revenue Target</label>
                            <input type="text" id="vendorRevenueTarget" value="${vendor.revenue_target || ''}"
                                onblur="updateVendorField('${vendorId}', 'revenue_target', this.value ? parseFloat(this.value.replace(/[^0-9.]/g, '')) : null)"
                                style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div class="modal-field">
                            <label>% of Target</label>
                            <div class="modal-field-value" style="font-weight: 600; color: ${pctColor};">${pctDisplay}</div>
                        </div>
                    </div>
                    `;
                })()}
                <!-- Salespeople Summary -->
                ${spDeals.length > 0 ? `
                <div style="margin-top: 20px; padding: 15px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 8px;">
                    <label style="font-size: 15px; font-weight: 600; color: var(--navy); margin-bottom: 10px; display: block;">Deal Summary by Source</label>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <div style="background: white; padding: 10px 16px; border-radius: 6px; border: 1px solid #E2E8F0; min-width: 100px; text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: var(--navy);">${spDeals.length}</div>
                            <div style="font-size: 12px; color: var(--text-light);">Total Deals</div>
                        </div>
                        <div style="background: white; padding: 10px 16px; border-radius: 6px; border: 1px solid #E2E8F0; min-width: 100px; text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: var(--success);">${spDeals.filter(d => d.status === 'Funded' || d.status === 'Closed').length}</div>
                            <div style="font-size: 12px; color: var(--text-light);">Funded</div>
                        </div>
                        <div style="background: white; padding: 10px 16px; border-radius: 6px; border: 1px solid #E2E8F0; min-width: 100px; text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: var(--gold);">${formatCurrency(spDeals.reduce((s,d) => s + (d.deal_amount || 0), 0))}</div>
                            <div style="font-size: 12px; color: var(--text-light);">Total Volume</div>
                        </div>
                        <div style="background: white; padding: 10px 16px; border-radius: 6px; border: 1px solid #E2E8F0; min-width: 100px; text-align: center;">
                            <div style="font-size: 22px; font-weight: 700; color: #3B82F6;">${(contacts || []).filter(c => c.status !== 'Left Company').length}</div>
                            <div style="font-size: 12px; color: var(--text-light);">Active Salespeople</div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div class="modal-row full" style="margin-top: 20px;">
                    <div class="modal-field">
                        <label style="font-size: 15px; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px;">Salespeople / Contacts</label>
                        <div id="vendorContactsContainer" style="margin-bottom: 15px;">${contactsHtml}</div>
                        <div style="background: #f9f9f9; padding: 12px; border-radius: 4px; border: 1px solid var(--border-gray);">
                            <h4 style="font-size: 13px; font-weight: 600; color: var(--navy); margin-bottom: 10px;">Add New Salesperson / Contact</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="newVendorContactName" placeholder="Name" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <input type="email" id="newVendorContactEmail" placeholder="Email" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="text" id="newVendorContactPhone" placeholder="Phone" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <input type="text" id="newVendorContactRole" placeholder="Role/Title" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                            </div>
                            <button class="btn btn-gold btn-sm" onclick="addVendorContact('${vendorId}')" style="margin-top: 10px;">Add Contact</button>
                        </div>
                    </div>
                </div>
                <div class="modal-row full" style="margin-top: 20px;">
                    <div class="modal-field">
                        <label style="font-size: 15px; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px;">Activity Notes</label>
                        <div id="vendorNotesContainer">${notesHtml}</div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <textarea id="newVendorNoteText" placeholder="Add a note..." style="flex: 1; min-height: 60px; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        <button class="btn btn-gold btn-sm" onclick="addVendorNote('${vendorId}')" style="margin-top: 8px;">Add Note</button>
                    </div>
                </div>
            `;

            document.getElementById('vendorDetailModal').classList.add('active');
        } catch (error) {
            console.error('View vendor error:', error);
            alert('Error loading vendor details: ' + error.message);
        }
    }

    function closeVendorDetailModal() {
        document.getElementById('vendorDetailModal').classList.remove('active');
    }

    async function updateVendorStatus(vendorId, newStatus) {
        try {
            const { error } = await db
                .from('vendors')
                .update({ status: newStatus })
                .eq('id', vendorId);

            if (error) throw error;
            await loadVendors();
        } catch (error) {
            console.error('Update vendor status error:', error);
            alert('Error updating status: ' + error.message);
        }
    }

    async function updateVendorField(vendorId, field, value) {
        try {
            const { error } = await db
                .from('vendors')
                .update({ [field]: value })
                .eq('id', vendorId);

            if (error) throw error;
            await loadVendors();
        } catch (error) {
            console.error('Update vendor field error:', error);
            alert('Error updating field: ' + error.message);
        }
    }

    async function updateVendorCountries(vendorId) {
        try {
            const countryCheckboxes = document.querySelectorAll('input[name="vendorDetailCountries"]:checked');
            const countries = Array.from(countryCheckboxes).map(cb => cb.value).join(', ');

            const { error } = await db
                .from('vendors')
                .update({ country: countries || null })
                .eq('id', vendorId);

            if (error) throw error;
            await loadVendors();
        } catch (error) {
            console.error('Update vendor countries error:', error);
            alert('Error updating countries: ' + error.message);
        }
    }

    async function addVendorContact(vendorId) {
        const name = document.getElementById('newVendorContactName').value.trim();
        const email = document.getElementById('newVendorContactEmail').value.trim();
        const phone = document.getElementById('newVendorContactPhone').value.trim();
        const role = document.getElementById('newVendorContactRole').value.trim();

        if (!name) {
            alert('Please enter a contact name');
            return;
        }

        try {
            const { error } = await db
                .from('vendor_contacts')
                .insert([{
                    vendor_id: vendorId,
                    contact_name: name,
                    email: email || null,
                    phone: phone || null,
                    role_title: role || null,
                    created_at: new Date().toISOString()
                }]);

            if (error) throw error;

            document.getElementById('newVendorContactName').value = '';
            document.getElementById('newVendorContactEmail').value = '';
            document.getElementById('newVendorContactPhone').value = '';
            document.getElementById('newVendorContactRole').value = '';

            await viewVendor(vendorId);
        } catch (error) {
            console.error('Add vendor contact error:', error);
            alert('Error adding contact: ' + error.message);
        }
    }

    async function addVendorNote(vendorId) {
        const noteText = document.getElementById('newVendorNoteText').value.trim();
        if (!noteText) return;

        try {
            const { data: vendor } = await db
                .from('vendors')
                .select('admin_notes')
                .eq('id', vendorId)
                .single();

            let notes = [];
            try {
                notes = vendor.admin_notes ? JSON.parse(vendor.admin_notes) : [];
            } catch(e) {
                notes = [];
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;

            notes.push({
                text: noteText,
                author: userEmail,
                date: dateStr
            });

            const { error } = await db
                .from('vendors')
                .update({ admin_notes: JSON.stringify(notes) })
                .eq('id', vendorId);

            if (error) throw error;

            await viewVendor(vendorId);
        } catch (error) {
            console.error('Add vendor note error:', error);
            alert('Error adding note: ' + error.message);
        }
    }

    async function addVendorContactNote(contactId, vendorId) {
        const noteText = document.getElementById('vendorContactNoteInput_' + contactId).value.trim();
        if (!noteText) return;

        try {
            const { data: contact } = await db
                .from('vendor_contacts')
                .select('notes')
                .eq('id', contactId)
                .single();

            let notes = [];
            try { notes = contact.notes ? JSON.parse(contact.notes) : []; } catch(e) { notes = []; }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;

            notes.push({ text: noteText, author: userEmail, date: dateStr });

            const { error } = await db
                .from('vendor_contacts')
                .update({ notes: JSON.stringify(notes) })
                .eq('id', contactId);

            if (error) throw error;
            await viewVendor(vendorId);
        } catch (error) {
            console.error('Add vendor contact note error:', error);
            alert('Error adding contact note: ' + error.message);
        }
    }

    // Vendor Contact Management - Edit, Status, Delete
    function toggleEditVendorContact(contactId) {
        document.getElementById('vendorContactDisplay_' + contactId).style.display = 'none';
        document.getElementById('vendorContactEdit_' + contactId).style.display = 'block';
    }
    function cancelEditVendorContact(contactId) {
        document.getElementById('vendorContactDisplay_' + contactId).style.display = 'block';
        document.getElementById('vendorContactEdit_' + contactId).style.display = 'none';
    }
    async function saveVendorContact(contactId, vendorId) {
        try {
            const { error } = await db.from('vendor_contacts').update({
                contact_name: document.getElementById('editVCName_' + contactId).value.trim(),
                email: document.getElementById('editVCEmail_' + contactId).value.trim() || null,
                phone: document.getElementById('editVCPhone_' + contactId).value.trim() || null,
                role_title: document.getElementById('editVCRole_' + contactId).value.trim() || null
            }).eq('id', contactId);
            if (error) throw error;
            await viewVendor(vendorId);
        } catch (error) {
            console.error('Save vendor contact error:', error);
            alert('Error saving contact: ' + error.message);
        }
    }
    async function updateVendorContactStatus(contactId, vendorId, newStatus) {
        try {
            const { error } = await db.from('vendor_contacts').update({ status: newStatus }).eq('id', contactId);
            if (error) throw error;

            // Auto-add a note about the status change
            const { data: contact } = await db.from('vendor_contacts').select('notes, contact_name').eq('id', contactId).single();
            let notes = [];
            try { notes = contact.notes ? JSON.parse(contact.notes) : []; } catch(e) { notes = []; }
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;
            notes.push({ text: `Status changed to "${newStatus}"`, author: userEmail, date: dateStr });
            await db.from('vendor_contacts').update({ notes: JSON.stringify(notes) }).eq('id', contactId);

            await viewVendor(vendorId);
        } catch (error) {
            console.error('Update vendor contact status error:', error);
            alert('Error updating contact status: ' + error.message);
        }
    }
    async function deleteVendorContact(contactId, vendorId, contactName) {
        if (!confirm(`Are you sure you want to delete contact "${contactName}"? This cannot be undone.`)) return;
        try {
            const { error } = await db.from('vendor_contacts').delete().eq('id', contactId);
            if (error) throw error;
            await viewVendor(vendorId);
        } catch (error) {
            console.error('Delete vendor contact error:', error);
            alert('Error deleting contact: ' + error.message);
        }
    }

    // ============================================
    // Lender Detail View
    // ============================================

    async function viewLender(lenderId) {
        try {
            // Fetch lender details
            const { data: lender, error: lenderError } = await db
                .from('lenders')
                .select('*')
                .eq('id', lenderId)
                .single();

            if (lenderError) throw lenderError;
            if (!lender) { alert('Lender not found'); return; }

            // Fetch lender contacts
            const { data: contacts, error: contactsError } = await db
                .from('lender_contacts')
                .select('*')
                .eq('lender_id', lenderId);

            if (contactsError) console.warn('Could not load contacts:', contactsError);

            // Parse admin notes
            let notes = [];
            try {
                notes = lender.admin_notes ? JSON.parse(lender.admin_notes) : [];
            } catch(e) {
                notes = lender.admin_notes ? [{ text: lender.admin_notes, author: 'System', date: 'Previously' }] : [];
            }

            const notesHtml = notes.length > 0
                ? notes.map(n => `
                    <div style="background: #F8FAFC; border-left: 3px solid var(--gold); padding: 10px 12px; margin-bottom: 8px; border-radius: 0 4px 4px 0;">
                        <div style="font-size: 12px; color: var(--text-light); margin-bottom: 4px;">
                            <strong>${n.author || 'Admin'}</strong> ‚Äî ${n.date || 'N/A'}
                        </div>
                        <div style="font-size: 14px; color: var(--text-dark);">${n.text}</div>
                    </div>
                `).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No notes yet.</p>';

            // Build contacts HTML with per-contact notes, edit, status, delete
            const contactsHtml = (contacts && contacts.length > 0)
                ? contacts.map(c => {
                    let cNotes = [];
                    try { cNotes = c.notes ? JSON.parse(c.notes) : []; } catch(e) { cNotes = []; }
                    const cNotesHtml = cNotes.length > 0
                        ? cNotes.map(n => `
                            <div style="background: white; border-left: 3px solid var(--gold); padding: 8px 10px; margin-bottom: 6px; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 11px; color: var(--text-light); margin-bottom: 3px;"><strong>${n.author || 'Admin'}</strong> ‚Äî ${n.date || 'N/A'}</div>
                                <div style="font-size: 13px; color: var(--text-dark);">${n.text}</div>
                            </div>
                        `).join('')
                        : '<p style="color: var(--text-light); font-size: 12px; margin: 4px 0;">No notes for this contact yet.</p>';
                    const statusColor = (c.status === 'Left Company') ? 'var(--danger)' : (c.status === 'Inactive') ? 'var(--warning)' : 'var(--success)';
                    const contactStatus = c.status || 'Active';
                    return `
                    <div class="lender-contact-card" style="background: #f5f5f5; padding: 12px; border-radius: 4px; margin-bottom: 10px; border: 1px solid var(--border-gray); ${contactStatus === 'Left Company' ? 'opacity: 0.65;' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div id="lenderContactDisplay_${c.id}">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-weight: 600; color: var(--navy);">${c.contact_name || 'N/A'}</span>
                                    <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}; color: white;">${contactStatus}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-light); margin-top: 4px;">
                                    ${c.email ? `<div>Email: <a href="mailto:${c.email}">${c.email}</a></div>` : ''}
                                    ${c.phone ? `<div>Phone: ${c.phone}</div>` : ''}
                                    ${c.role_title ? `<div>Role: ${c.role_title}</div>` : ''}
                                    ${c.territory ? `<div>Territory: ${c.territory}</div>` : ''}
                                    ${c.linkedin_profile ? `<div>LinkedIn: <a href="${c.linkedin_profile}" target="_blank">Profile</a></div>` : ''}
                                </div>
                            </div>
                            <div id="lenderContactEdit_${c.id}" style="display: none; flex: 1;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <input type="text" id="editLCName_${c.id}" value="${(c.contact_name || '').replace(/"/g, '&quot;')}" placeholder="Name" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                    <input type="email" id="editLCEmail_${c.id}" value="${(c.email || '').replace(/"/g, '&quot;')}" placeholder="Email" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <input type="text" id="editLCPhone_${c.id}" value="${(c.phone || '').replace(/"/g, '&quot;')}" placeholder="Phone" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                    <input type="text" id="editLCRole_${c.id}" value="${(c.role_title || '').replace(/"/g, '&quot;')}" placeholder="Role/Title" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                    <input type="text" id="editLCTerritory_${c.id}" value="${(c.territory || '').replace(/"/g, '&quot;')}" placeholder="Territory" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                    <input type="url" id="editLCLinkedIn_${c.id}" value="${(c.linkedin_profile || '').replace(/"/g, '&quot;')}" placeholder="LinkedIn URL" style="padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-gold btn-sm" onclick="saveLenderContact('${c.id}', '${lenderId}')" style="padding: 4px 12px; font-size: 12px;">Save</button>
                                    <button class="btn btn-secondary btn-sm" onclick="cancelEditLenderContact('${c.id}')" style="padding: 4px 12px; font-size: 12px;">Cancel</button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 4px; margin-left: 8px; flex-shrink: 0;">
                                <select onchange="updateLenderContactStatus('${c.id}', '${lenderId}', this.value)" style="padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 11px; cursor: pointer;">
                                    ${'Active,Inactive,Left Company'.split(',').map(s => `<option value="${s}" ${contactStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                                <button class="btn btn-secondary btn-sm" onclick="toggleEditLenderContact('${c.id}')" style="padding: 3px 8px; font-size: 11px;" title="Edit">Edit</button>
                                <button class="btn btn-sm" onclick="deleteLenderContact('${c.id}', '${lenderId}', '${(c.contact_name || '').replace(/'/g, "\\'")}')" style="padding: 3px 8px; font-size: 11px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;" title="Delete">Del</button>
                                <button class="btn btn-secondary btn-sm" onclick="this.closest('.lender-contact-card').querySelector('.contact-notes-section').style.display = this.closest('.lender-contact-card').querySelector('.contact-notes-section').style.display === 'none' ? 'block' : 'none'" style="padding: 3px 8px; font-size: 11px; white-space: nowrap;">Notes (${cNotes.length})</button>
                            </div>
                        </div>
                        <div class="contact-notes-section" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-gray);">
                            <div id="lenderContactNotes_${c.id}">${cNotesHtml}</div>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <input type="text" id="lenderContactNoteInput_${c.id}" placeholder="Add note for ${c.contact_name}..." style="flex: 1; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <button class="btn btn-gold btn-sm" onclick="addLenderContactNote('${c.id}', '${lenderId}')" style="padding: 6px 12px; font-size: 12px; white-space: nowrap;">Add</button>
                            </div>
                        </div>
                    </div>
                `}).join('')
                : '<p style="color: var(--text-light); font-size: 14px;">No contacts yet.</p>';

            const modalBody = document.getElementById('lenderModalBody');
            document.getElementById('lenderDetailTitle').textContent = lender.name || 'Lender Details';

            modalBody.innerHTML = `
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Name</label>
                        <div class="modal-field-value">${lender.name || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Lender ID</label>
                        <div class="modal-field-value">${lender.lender_id || 'N/A'}</div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Type</label>
                        <div class="modal-field-value">${lender.lender_type || 'N/A'}</div>
                    </div>
                    <div class="modal-field">
                        <label>Countries</label>
                        <div class="modal-field-value">
                            ${(() => {
                                const countries = ['Canada', 'United States', 'UK', 'Germany'];
                                const currentCountries = (lender.country || '').split(',').map(c => c.trim()).filter(c => c);
                                return `<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px;">
                                    ${countries.map(country => `
                                        <label style="display:flex;align-items:center;gap:4px;font-weight:400;font-size:13px;cursor:pointer;">
                                            <input type="checkbox" name="lenderDetailCountries" value="${country}" ${currentCountries.includes(country) ? 'checked' : ''} onchange="updateLenderCountries('${lenderId}')"> ${country}
                                        </label>
                                    `).join('')}
                                </div>`;
                            })()}
                        </div>
                    </div>
                </div>
                <div class="modal-row">
                    <div class="modal-field">
                        <label>Currency</label>
                        <div class="modal-field-value">
                            <select id="lenderDetailCurrency" onchange="updateLenderField(${lenderId}, 'currency', this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer; width: 100%;">
                                ${'CAD,USD,GBP,EUR'.split(',').map(c => `<option value="${c}" ${(lender.currency || '') === c ? 'selected' : ''}>${c}</option>`).join('')}
                                <option value="">None</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-field">
                        <label>Status</label>
                        <div class="modal-field-value">
                            <select id="lenderDetailStatus" onchange="updateLenderStatus(${lenderId}, this.value)" style="padding: 5px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; cursor: pointer;">
                                ${'Active,Inactive'.split(',').map(s => `<option value="${s}" ${(lender.status || '') === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-row full" style="margin-top: 20px;">
                    <div class="modal-field">
                        <label style="font-size: 15px; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px;">Contacts</label>
                        <div id="lenderContactsContainer" style="margin-bottom: 15px;">${contactsHtml}</div>
                        <div style="background: #f9f9f9; padding: 12px; border-radius: 4px; border: 1px solid var(--border-gray);">
                            <h4 style="font-size: 13px; font-weight: 600; color: var(--navy); margin-bottom: 10px;">Add New Contact</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="newLenderContactName" placeholder="Contact Name" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <input type="email" id="newLenderContactEmail" placeholder="Email" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <input type="text" id="newLenderContactPhone" placeholder="Phone" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <input type="text" id="newLenderContactRole" placeholder="Role/Title" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="text" id="newLenderContactTerritory" placeholder="Territory" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                                <input type="url" id="newLenderContactLinkedIn" placeholder="LinkedIn URL" style="padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
                            </div>
                            <button class="btn btn-gold btn-sm" onclick="addLenderContact('${lenderId}')" style="margin-top: 10px;">Add Contact</button>
                        </div>
                    </div>
                </div>
                <div class="modal-row full" style="margin-top: 20px;">
                    <div class="modal-field">
                        <label style="font-size: 15px; color: var(--navy); border-bottom: 1px solid var(--border-gray); padding-bottom: 8px; margin-bottom: 10px;">Activity Notes</label>
                        <div id="lenderNotesContainer">${notesHtml}</div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <textarea id="newLenderNoteText" placeholder="Add a note..." style="flex: 1; min-height: 60px; padding: 8px; border: 1px solid var(--border-gray); border-radius: 4px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                        </div>
                        <button class="btn btn-gold btn-sm" onclick="addLenderNote('${lenderId}')" style="margin-top: 8px;">Add Note</button>
                    </div>
                </div>
            `;

            document.getElementById('lenderDetailModal').classList.add('active');
        } catch (error) {
            console.error('View lender error:', error);
            alert('Error loading lender details: ' + error.message);
        }
    }

    function closeLenderDetailModal() {
        document.getElementById('lenderDetailModal').classList.remove('active');
    }

    async function updateLenderStatus(lenderId, newStatus) {
        try {
            const { error } = await db
                .from('lenders')
                .update({ status: newStatus })
                .eq('id', lenderId);

            if (error) throw error;
            await loadLenders();
        } catch (error) {
            console.error('Update lender status error:', error);
            alert('Error updating status: ' + error.message);
        }
    }

    async function updateLenderField(lenderId, field, value) {
        try {
            const { error } = await db
                .from('lenders')
                .update({ [field]: value })
                .eq('id', lenderId);

            if (error) throw error;
            await loadLenders();
        } catch (error) {
            console.error('Update lender field error:', error);
            alert('Error updating field: ' + error.message);
        }
    }

    async function updateLenderCountries(lenderId) {
        try {
            const countryCheckboxes = document.querySelectorAll('input[name="lenderDetailCountries"]:checked');
            const countries = Array.from(countryCheckboxes).map(cb => cb.value).join(', ');

            const { error } = await db
                .from('lenders')
                .update({ country: countries || null })
                .eq('id', lenderId);

            if (error) throw error;
            await loadLenders();
        } catch (error) {
            console.error('Update lender countries error:', error);
            alert('Error updating countries: ' + error.message);
        }
    }

    async function addLenderContact(lenderId) {
        const name = document.getElementById('newLenderContactName').value.trim();
        const email = document.getElementById('newLenderContactEmail').value.trim();
        const phone = document.getElementById('newLenderContactPhone').value.trim();
        const role = document.getElementById('newLenderContactRole').value.trim();
        const territory = document.getElementById('newLenderContactTerritory').value.trim();
        const linkedin = document.getElementById('newLenderContactLinkedIn').value.trim();

        if (!name) {
            alert('Please enter a contact name');
            return;
        }

        try {
            const { error } = await db
                .from('lender_contacts')
                .insert([{
                    lender_id: lenderId,
                    contact_name: name,
                    email: email || null,
                    phone: phone || null,
                    role_title: role || null,
                    territory: territory || null,
                    linkedin_profile: linkedin || null,
                    created_at: new Date().toISOString()
                }]);

            if (error) throw error;

            document.getElementById('newLenderContactName').value = '';
            document.getElementById('newLenderContactEmail').value = '';
            document.getElementById('newLenderContactPhone').value = '';
            document.getElementById('newLenderContactRole').value = '';
            document.getElementById('newLenderContactTerritory').value = '';
            document.getElementById('newLenderContactLinkedIn').value = '';

            await viewLender(lenderId);
        } catch (error) {
            console.error('Add lender contact error:', error);
            alert('Error adding contact: ' + error.message);
        }
    }

    async function addLenderNote(lenderId) {
        const noteText = document.getElementById('newLenderNoteText').value.trim();
        if (!noteText) return;

        try {
            const { data: lender } = await db
                .from('lenders')
                .select('admin_notes')
                .eq('id', lenderId)
                .single();

            let notes = [];
            try {
                notes = lender.admin_notes ? JSON.parse(lender.admin_notes) : [];
            } catch(e) {
                notes = [];
            }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;

            notes.push({
                text: noteText,
                author: userEmail,
                date: dateStr
            });

            const { error } = await db
                .from('lenders')
                .update({ admin_notes: JSON.stringify(notes) })
                .eq('id', lenderId);

            if (error) throw error;

            await viewLender(lenderId);
        } catch (error) {
            console.error('Add lender note error:', error);
            alert('Error adding note: ' + error.message);
        }
    }

    async function addLenderContactNote(contactId, lenderId) {
        const noteText = document.getElementById('lenderContactNoteInput_' + contactId).value.trim();
        if (!noteText) return;

        try {
            const { data: contact } = await db
                .from('lender_contacts')
                .select('notes')
                .eq('id', contactId)
                .single();

            let notes = [];
            try { notes = contact.notes ? JSON.parse(contact.notes) : []; } catch(e) { notes = []; }

            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;

            notes.push({ text: noteText, author: userEmail, date: dateStr });

            const { error } = await db
                .from('lender_contacts')
                .update({ notes: JSON.stringify(notes) })
                .eq('id', contactId);

            if (error) throw error;
            await viewLender(lenderId);
        } catch (error) {
            console.error('Add lender contact note error:', error);
            alert('Error adding contact note: ' + error.message);
        }
    }

    // Lender Contact Management - Edit, Status, Delete
    function toggleEditLenderContact(contactId) {
        document.getElementById('lenderContactDisplay_' + contactId).style.display = 'none';
        document.getElementById('lenderContactEdit_' + contactId).style.display = 'block';
    }
    function cancelEditLenderContact(contactId) {
        document.getElementById('lenderContactDisplay_' + contactId).style.display = 'block';
        document.getElementById('lenderContactEdit_' + contactId).style.display = 'none';
    }
    async function saveLenderContact(contactId, lenderId) {
        try {
            const { error } = await db.from('lender_contacts').update({
                contact_name: document.getElementById('editLCName_' + contactId).value.trim(),
                email: document.getElementById('editLCEmail_' + contactId).value.trim() || null,
                phone: document.getElementById('editLCPhone_' + contactId).value.trim() || null,
                role_title: document.getElementById('editLCRole_' + contactId).value.trim() || null,
                territory: document.getElementById('editLCTerritory_' + contactId).value.trim() || null,
                linkedin_profile: document.getElementById('editLCLinkedIn_' + contactId).value.trim() || null
            }).eq('id', contactId);
            if (error) throw error;
            await viewLender(lenderId);
        } catch (error) {
            console.error('Save lender contact error:', error);
            alert('Error saving contact: ' + error.message);
        }
    }
    async function updateLenderContactStatus(contactId, lenderId, newStatus) {
        try {
            const { error } = await db.from('lender_contacts').update({ status: newStatus }).eq('id', contactId);
            if (error) throw error;

            // Auto-add a note about the status change
            const { data: contact } = await db.from('lender_contacts').select('notes, contact_name').eq('id', contactId).single();
            let notes = [];
            try { notes = contact.notes ? JSON.parse(contact.notes) : []; } catch(e) { notes = []; }
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const userEmail = document.getElementById('userEmailDisplay').textContent;
            notes.push({ text: `Status changed to "${newStatus}"`, author: userEmail, date: dateStr });
            await db.from('lender_contacts').update({ notes: JSON.stringify(notes) }).eq('id', contactId);

            await viewLender(lenderId);
        } catch (error) {
            console.error('Update lender contact status error:', error);
            alert('Error updating contact status: ' + error.message);
        }
    }
    async function deleteLenderContact(contactId, lenderId, contactName) {
        if (!confirm(`Are you sure you want to delete contact "${contactName}"? This cannot be undone.`)) return;
        try {
            const { error } = await db.from('lender_contacts').delete().eq('id', contactId);
            if (error) throw error;
            await viewLender(lenderId);
        } catch (error) {
            console.error('Delete lender contact error:', error);
            alert('Error deleting contact: ' + error.message);
        }
    }

    // ============================================
    // CSV Import
    // ============================================

    function openCSVImportModal() {
        document.getElementById('csvImportForm').reset();
        document.getElementById('csvPreview').style.display = 'none';
        document.getElementById('csvSubmitBtn').style.display = 'none';
        document.getElementById('csvImportModal').classList.add('active');
    }

    function closeCSVImportModal() {
        document.getElementById('csvImportModal').classList.remove('active');
    }

    document.addEventListener('change', function(e) {
        if (e.target.id === 'csvFile') {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    displayCSVPreview(results.data);
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }
    });

    function displayCSVPreview(data) {
        if (!data || data.length === 0) {
            alert('CSV file is empty');
            return;
        }

        const previewRows = data.slice(0, 5);
        const columns = Object.keys(data[0]);

        let tableHtml = '<thead><tr style="background-color: var(--light-gray); font-weight: 600; position: sticky; top: 0;">';
        columns.forEach(col => {
            tableHtml += `<th style="padding: 8px; border-bottom: 1px solid var(--border-gray); text-align: left;">${col}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';

        previewRows.forEach(row => {
            tableHtml += '<tr>';
            columns.forEach(col => {
                const value = row[col] || '';
                tableHtml += `<td style="padding: 8px; border-bottom: 1px solid var(--border-gray); max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${value}</td>`;
            });
            tableHtml += '</tr>';
        });
        tableHtml += '</tbody>';

        document.getElementById('csvPreviewTable').innerHTML = tableHtml;
        document.getElementById('csvPreview').style.display = 'block';
        document.getElementById('csvSubmitBtn').style.display = 'inline-block';
        window.csvData = data; // Store for submission
    }

    async function handleCSVImport(event) {
        event.preventDefault();

        if (!window.csvData || window.csvData.length === 0) {
            alert('Please select and preview a CSV file first');
            return;
        }

        const targetTable = document.getElementById('csvTargetTable').value;
        if (!targetTable) {
            alert('Please select a target table');
            return;
        }

        try {
            document.getElementById('csvSubmitBtn').disabled = true;
            document.getElementById('csvSubmitBtn').textContent = 'Importing...';

            const rows = window.csvData;
            let successCount = 0;
            let errorCount = 0;

            // Process each row
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const preparedData = prepareRowForTable(targetTable, row);

                if (!preparedData) {
                    errorCount++;
                    continue;
                }

                try {
                    const { error } = await db
                        .from(targetTable)
                        .insert([preparedData]);

                    if (error) {
                        console.warn(`Row ${i + 1} error:`, error);
                        errorCount++;
                    } else {
                        successCount++;
                    }
                } catch (err) {
                    console.warn(`Row ${i + 1} error:`, err);
                    errorCount++;
                }
            }

            document.getElementById('csvSubmitBtn').disabled = false;
            document.getElementById('csvSubmitBtn').textContent = 'Import Data';

            alert(`Import complete!\nSuccessful: ${successCount}\nFailed: ${errorCount}`);

            // Reload the appropriate table
            closeCSVImportModal();
            if (targetTable === 'users') await loadAgents();
            else if (targetTable === 'lenders') await loadLenders();
            else if (targetTable === 'vendors') await loadVendors();
            else if (targetTable === 'applications') {
                await loadApplications();
                await loadDashboard();
            }
        } catch (error) {
            console.error('CSV import error:', error);
            alert('Error importing data: ' + error.message);
            document.getElementById('csvSubmitBtn').disabled = false;
            document.getElementById('csvSubmitBtn').textContent = 'Import Data';
        }
    }

    function prepareRowForTable(tableName, row) {
        const timestamp = new Date().toISOString();

        if (tableName === 'users') {
            // Agents
            if (!row.full_name || !row.email) return null;
            const slug = row.referral_slug || row.full_name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            return {
                full_name: row.full_name,
                email: row.email,
                phone: row.phone || null,
                role: 'agent',
                business_type: row.business_type || null,
                referral_slug: slug,
                status: row.status || 'Pending',
                created_at: timestamp
            };
        } else if (tableName === 'lenders') {
            if (!row.name) return null;
            return {
                name: row.name,
                lender_id: row.lender_id || null,
                lender_type: row.type || row.lender_type || null,
                country: row.country || null,
                currency: row.currency || null,
                status: row.status || 'Active',
                created_at: timestamp
            };
        } else if (tableName === 'vendors') {
            if (!row.name) return null;
            return {
                name: row.name,
                website: row.website || null,
                product_description: row.product_description || row.product || null,
                country: row.country || null,
                status: row.status || 'Active',
                created_at: timestamp
            };
        } else if (tableName === 'applications') {
            if (!row.full_name || !row.email) return null;
            let fundingAmountRequested = null;
            let fundingAmountText = null;
            if (row.funding_amount_requested || row.funding_amount) {
                const amt = row.funding_amount_requested || row.funding_amount;
                const parsed = parseFloat(amt.replace(/[^0-9.]/g, ''));
                if (!isNaN(parsed)) {
                    fundingAmountRequested = parsed;
                } else {
                    fundingAmountText = amt;
                }
            }
            return {
                full_name: row.full_name,
                email: row.email,
                phone: row.phone || null,
                business_name: row.business_name || null,
                time_in_business: row.time_in_business || null,
                annual_revenue: row.annual_revenue || null,
                funding_amount_requested: fundingAmountRequested,
                funding_amount_text: fundingAmountText,
                description: row.description || null,
                status: row.status || 'Submitted',
                submitted_at: timestamp
            };
        }

        return null;
    }

    // ============================================
    // Utility Functions
    // ============================================

    function getContactStatusBadge(status) {
        let badgeClass = 'badge-info';
        if (status === 'Closed' || status === 'Responded') badgeClass = 'badge-success';
        else if (status === 'In Progress') badgeClass = 'badge-warning';
        else if (status === 'New') badgeClass = 'badge-info';
        return `<span class="badge ${badgeClass}">${status}</span>`;
    }

    function getStatusBadge(status) {
        let badgeClass = 'badge-info';
        if (['Funded', 'Active', 'Approved'].includes(status)) {
            badgeClass = 'badge-success';
        } else if (['Prospect', 'Quote sent', 'Info received', 'In Credit', 'Approval sent'].includes(status)) {
            badgeClass = 'badge-warning';
        } else if (['Declined', 'Dead approval'].includes(status)) {
            badgeClass = 'badge-danger';
        }
        return `<span class="badge ${badgeClass}">${status || 'Unknown'}</span>`;
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // ============================================
    // Export to CSV Utility
    // ============================================

    function exportToCSV(data, filename, columns) {
        if (!data || data.length === 0) {
            alert('No data to export');
            return;
        }
        const headers = columns.map(c => c.label).join(',');
        const rows = data.map(row => {
            return columns.map(c => {
                let val = row[c.key] || '';
                // Escape commas and quotes
                val = String(val).replace(/"/g, '""');
                if (val.includes(',') || val.includes('"') || val.includes('\n')) {
                    val = '"' + val + '"';
                }
                return val;
            }).join(',');
        });
        const csv = headers + '\n' + rows.join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        URL.revokeObjectURL(link.href);
    }

    async function exportDeals() {
        try {
            const { data, error } = await db
                .from('deals')
                .select('*')
                .order('date_submitted', { ascending: false });

            if (error) throw error;

            const exportData = (data || []).map(deal => ({
                deal_number: deal.deal_number,
                company_name: deal.company_name,
                deal_amount: deal.deal_amount,
                currency: deal.currency,
                product_type: deal.product_type,
                status: deal.status,
                date_submitted: formatDate(deal.date_submitted),
                expected_close: formatDate(deal.expected_close),
                gross_fee_percent: deal.gross_fee_percent,
                alliance_net_fee: deal.alliance_net_fee,
                notes: deal.notes
            }));

            const columns = [
                { key: 'deal_number', label: 'Deal Number' },
                { key: 'company_name', label: 'Company' },
                { key: 'deal_amount', label: 'Amount' },
                { key: 'currency', label: 'Currency' },
                { key: 'product_type', label: 'Product Type' },
                { key: 'status', label: 'Status' },
                { key: 'date_submitted', label: 'Date Submitted' },
                { key: 'expected_close', label: 'Expected Close' },
                { key: 'gross_fee_percent', label: 'Gross Fee %' },
                { key: 'alliance_net_fee', label: 'Alliance Net Fee' },
                { key: 'notes', label: 'Notes' }
            ];

            const filename = 'deals_' + new Date().toISOString().split('T')[0] + '.csv';
            exportToCSV(exportData, filename, columns);
        } catch (error) {
            console.error('Export deals error:', error);
            alert('Error exporting deals: ' + error.message);
        }
    }

    async function exportApplications() {
        try {
            const { data, error } = await db
                .from('applications')
                .select('*')
                .order('submitted_at', { ascending: false });

            if (error) throw error;

            const exportData = (data || []).map(app => ({
                application_id: app.application_id,
                full_name: app.full_name,
                email: app.email,
                phone: app.phone,
                business_name: app.business_name,
                time_in_business: app.time_in_business,
                annual_revenue: app.annual_revenue,
                funding_amount: app.funding_amount_requested || app.funding_amount_text,
                status: app.status,
                submitted_at: formatDate(app.submitted_at),
                description: app.description
            }));

            const columns = [
                { key: 'application_id', label: 'Application ID' },
                { key: 'full_name', label: 'Full Name' },
                { key: 'email', label: 'Email' },
                { key: 'phone', label: 'Phone' },
                { key: 'business_name', label: 'Business Name' },
                { key: 'time_in_business', label: 'Time in Business' },
                { key: 'annual_revenue', label: 'Annual Revenue' },
                { key: 'funding_amount', label: 'Funding Amount' },
                { key: 'status', label: 'Status' },
                { key: 'submitted_at', label: 'Submitted Date' },
                { key: 'description', label: 'Description' }
            ];

            const filename = 'applications_' + new Date().toISOString().split('T')[0] + '.csv';
            exportToCSV(exportData, filename, columns);
        } catch (error) {
            console.error('Export applications error:', error);
            alert('Error exporting applications: ' + error.message);
        }
    }

    async function exportAgents() {
        try {
            const { data, error } = await db
                .from('users')
                .select('*')
                .eq('role', 'agent')
                .order('full_name', { ascending: true });

            if (error) throw error;

            const exportData = (data || []).map(agent => ({
                full_name: agent.full_name,
                email: agent.email,
                phone: agent.phone,
                business_type: agent.business_type,
                agent_status: agent.agent_status,
                referral_slug: agent.referral_slug,
                created_at: formatDate(agent.created_at)
            }));

            const columns = [
                { key: 'full_name', label: 'Full Name' },
                { key: 'email', label: 'Email' },
                { key: 'phone', label: 'Phone' },
                { key: 'business_type', label: 'Business Type' },
                { key: 'agent_status', label: 'Agent Status' },
                { key: 'referral_slug', label: 'Referral Slug' },
                { key: 'created_at', label: 'Created Date' }
            ];

            const filename = 'agents_' + new Date().toISOString().split('T')[0] + '.csv';
            exportToCSV(exportData, filename, columns);
        } catch (error) {
            console.error('Export agents error:', error);
            alert('Error exporting agents: ' + error.message);
        }
    }

    async function exportLenders() {
        try {
            const exportData = (allLenders || []).map(lender => ({
                lender_id: lender.lender_id,
                name: lender.name,
                type: lender.lender_type,
                country: lender.country,
                currency: lender.currency,
                status: lender.status
            }));

            const columns = [
                { key: 'lender_id', label: 'Lender ID' },
                { key: 'name', label: 'Name' },
                { key: 'type', label: 'Type' },
                { key: 'country', label: 'Country' },
                { key: 'currency', label: 'Currency' },
                { key: 'status', label: 'Status' }
            ];

            const filename = 'lenders_' + new Date().toISOString().split('T')[0] + '.csv';
            exportToCSV(exportData, filename, columns);
        } catch (error) {
            console.error('Export lenders error:', error);
            alert('Error exporting lenders: ' + error.message);
        }
    }

    async function exportVendors() {
        try {
            const exportData = (allVendors || []).map(vendor => ({
                name: vendor.name,
                website: vendor.website,
                product_description: vendor.product_description,
                country: vendor.country,
                status: vendor.status
            }));

            const columns = [
                { key: 'name', label: 'Name' },
                { key: 'website', label: 'Website' },
                { key: 'product_description', label: 'Product Description' },
                { key: 'country', label: 'Country' },
                { key: 'status', label: 'Status' }
            ];

            const filename = 'vendors_' + new Date().toISOString().split('T')[0] + '.csv';
            exportToCSV(exportData, filename, columns);
        } catch (error) {
            console.error('Export vendors error:', error);
            alert('Error exporting vendors: ' + error.message);
        }
    }

    async function exportContacts() {
        try {
            const { data, error } = await db
                .from('contact_submissions')
                .select('*')
                .order('submitted_at', { ascending: false });

            if (error) throw error;

            const exportData = (data || []).map(contact => ({
                name: contact.name,
                email: contact.email,
                phone: contact.phone,
                subject: contact.subject,
                message: contact.message,
                status: contact.status,
                submitted_at: formatDate(contact.submitted_at)
            }));

            const columns = [
                { key: 'name', label: 'Name' },
                { key: 'email', label: 'Email' },
                { key: 'phone', label: 'Phone' },
                { key: 'subject', label: 'Subject' },
                { key: 'message', label: 'Message' },
                { key: 'status', label: 'Status' },
                { key: 'submitted_at', label: 'Submitted Date' }
            ];

            const filename = 'contacts_' + new Date().toISOString().split('T')[0] + '.csv';
            exportToCSV(exportData, filename, columns);
        } catch (error) {
            console.error('Export contacts error:', error);
            alert('Error exporting contacts: ' + error.message);
        }
    }

    // ============================================
    // Modal close on background click
    // ============================================

    window.onclick = function(event) {
        const modals = ['dealModal', 'addDealModal', 'applicationModal', 'contactModal', 'addAgentModal', 'addLenderModal', 'addVendorModal', 'addApplicationModal', 'csvImportModal', 'vendorDetailModal', 'lenderDetailModal', 'agentDetailModal', 'documentUploadModal', 'sendApplicationModal'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                modal.classList.remove('active');
            }
        });
    }
</script>

</body>
</html>
